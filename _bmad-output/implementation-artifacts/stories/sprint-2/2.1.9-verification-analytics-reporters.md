# Story 2.1.9: Verification Analytics for Reporters

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 5  
**Sprint:** 2  
**Status:** In Progress (Code Complete, Tests Pending)

---

## User Story

**As a** reporter  
**I want** to see how many of my reports were verified  
**So that** I understand my contribution accuracy

---

## Acceptance Criteria

- [ ] User profile displays verification statistics:
  - Total reports submitted
  - Reports verified by community (count + percentage)
  - Average verification speed (time from submission to 2nd verification)
- [ ] "My Reports" page shows verification status for each report:
  - Badge: "Pending (0/2)" or "Verified âœ“"
  - Verifier usernames for verified reports
- [ ] Sort options on "My Reports" page:
  - Most recent
  - Most verified
  - Pending verification
- [ ] Filter options:
  - All, Pending, Verified, Resolved
- [ ] Empty state for zero reports: "You haven't reported any issues yet. Start contributing!"
- [ ] Loading skeleton while fetching reports
- [ ] Pagination: 20 reports per page

---

## Technical Implementation

### My Reports Page

```typescript
// app/[locale]/profile/reports/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { MyReportsList } from '@/components/profile/MyReportsList';
import { ReportStats } from '@/components/profile/ReportStats';

export default async function MyReportsPage({
  searchParams,
}: {
  searchParams: { page?: string; sort?: string; filter?: string };
}) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  // Fetch user stats
  const stats = await getUserReportStats(user.id);

  // Fetch user reports with pagination
  const page = parseInt(searchParams.page || '1');
  const pageSize = 20;
  const offset = (page - 1) * pageSize;

  const sort = searchParams.sort || 'recent';
  const filter = searchParams.filter || 'all';

  let query = supabase
    .from('issues')
    .select(`
      id,
      category,
      severity,
      status,
      verifications_count,
      created_at,
      address,
      photos,
      verifications:verifications (
        verifier:users!verifier_id (username, avatar_url)
      )
    `, { count: 'exact' })
    .eq('user_id', user.id);

  // Apply filters
  if (filter === 'pending') {
    query = query.lt('verifications_count', 2);
  } else if (filter === 'verified') {
    query = query.gte('verifications_count', 2);
  } else if (filter === 'resolved') {
    query = query.eq('status', 'resolved');
  }

  // Apply sorting
  if (sort === 'recent') {
    query = query.order('created_at', { ascending: false });
  } else if (sort === 'verified') {
    query = query.order('verifications_count', { ascending: false });
  } else if (sort === 'pending') {
    query = query.order('verifications_count', { ascending: true });
  }

  query = query.range(offset, offset + pageSize - 1);

  const { data: reports, count, error } = await query;

  if (error) {
    console.error('Failed to fetch reports:', error);
  }

  return (
    <div className="container max-w-4xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">My Reports</h1>

      <ReportStats stats={stats} />

      <MyReportsList
        reports={reports || []}
        totalCount={count || 0}
        currentPage={page}
        pageSize={pageSize}
      />
    </div>
  );
}

async function getUserReportStats(userId: string) {
  const supabase = await createClient();

  // Total reports
  const { count: totalReports } = await supabase
    .from('issues')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId);

  // Verified reports
  const { count: verifiedReports } = await supabase
    .from('issues')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .gte('verifications_count', 2);

  // Average verification speed (in hours)
  const { data: verifiedIssues } = await supabase
    .from('issues')
    .select(`
      created_at,
      verifications (created_at)
    `)
    .eq('user_id', userId)
    .gte('verifications_count', 2)
    .limit(100);

  let avgVerificationSpeed = 0;
  if (verifiedIssues && verifiedIssues.length > 0) {
    const speeds = verifiedIssues.map(issue => {
      // Get 2nd verification timestamp
      const sortedVerifications = issue.verifications
        .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime());

      if (sortedVerifications.length >= 2) {
        const issueTime = new Date(issue.created_at).getTime();
        const secondVerificationTime = new Date(sortedVerifications[1].created_at).getTime();
        return (secondVerificationTime - issueTime) / (1000 * 60 * 60); // hours
      }
      return 0;
    }).filter(speed => speed > 0);

    avgVerificationSpeed = speeds.length > 0
      ? speeds.reduce((a, b) => a + b, 0) / speeds.length
      : 0;
  }

  const verificationRate = totalReports > 0
    ? (verifiedReports / totalReports) * 100
    : 0;

  return {
    totalReports: totalReports || 0,
    verifiedReports: verifiedReports || 0,
    verificationRate: Math.round(verificationRate),
    avgVerificationSpeed: Math.round(avgVerificationSpeed),
  };
}
```

### Report Stats Component

```typescript
// components/profile/ReportStats.tsx
'use client';
import { FileText, CheckCircle, Clock, TrendingUp } from '@hugeicons/react';

interface ReportStatsProps {
  stats: {
    totalReports: number;
    verifiedReports: number;
    verificationRate: number;
    avgVerificationSpeed: number; // in hours
  };
}

export function ReportStats({ stats }: ReportStatsProps) {
  return (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <StatCard
        icon={<FileText size={24} />}
        label="Total Reports"
        value={stats.totalReports.toString()}
        color="blue"
      />

      <StatCard
        icon={<CheckCircle size={24} />}
        label="Verified"
        value={stats.verifiedReports.toString()}
        color="green"
      />

      <StatCard
        icon={<TrendingUp size={24} />}
        label="Verification Rate"
        value={`${stats.verificationRate}%`}
        color="purple"
      />

      <StatCard
        icon={<Clock size={24} />}
        label="Avg. Verification Time"
        value={`${stats.avgVerificationSpeed}h`}
        color="orange"
      />
    </div>
  );
}

function StatCard({
  icon,
  label,
  value,
  color
}: {
  icon: React.ReactNode;
  label: string;
  value: string;
  color: 'blue' | 'green' | 'purple' | 'orange';
}) {
  const colorClasses = {
    blue: 'bg-blue-50 text-blue-600',
    green: 'bg-green-50 text-green-600',
    purple: 'bg-purple-50 text-purple-600',
    orange: 'bg-orange-50 text-orange-600',
  };

  return (
    <div className="bg-white border rounded-lg p-4">
      <div className={`inline-flex p-2 rounded-lg ${colorClasses[color]} mb-2`}>
        {icon}
      </div>
      <div className="text-2xl font-bold">{value}</div>
      <div className="text-sm text-gray-600">{label}</div>
    </div>
  );
}
```

### My Reports List Component

```typescript
// components/profile/MyReportsList.tsx
'use client';
import { useState } from 'react';
import Link from 'next/link';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { CheckCircle } from '@hugeicons/react';

export function MyReportsList({ reports, totalCount, currentPage, pageSize }) {
  const [sort, setSort] = useState('recent');
  const [filter, setFilter] = useState('all');

  const totalPages = Math.ceil(totalCount / pageSize);

  const handleSortChange = (value: string) => {
    setSort(value);
    window.location.href = `/profile/reports?sort=${value}&filter=${filter}`;
  };

  const handleFilterChange = (value: string) => {
    setFilter(value);
    window.location.href = `/profile/reports?sort=${sort}&filter=${value}`;
  };

  if (reports.length === 0) {
    return (
      <div className="text-center py-12">
        <FileText size={64} className="mx-auto text-gray-300 mb-4" />
        <h3 className="text-lg font-semibold mb-2">No reports yet</h3>
        <p className="text-gray-600 mb-4">
          You haven't reported any issues yet. Start contributing!
        </p>
        <Button asChild>
          <Link href="/">Report an Issue</Link>
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Filters and Sort */}
      <div className="flex gap-4">
        <Select value={filter} onValueChange={handleFilterChange}>
          <SelectTrigger className="w-40">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Reports</SelectItem>
            <SelectItem value="pending">Pending</SelectItem>
            <SelectItem value="verified">Verified</SelectItem>
            <SelectItem value="resolved">Resolved</SelectItem>
          </SelectContent>
        </Select>

        <Select value={sort} onValueChange={handleSortChange}>
          <SelectTrigger className="w-40">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="recent">Most Recent</SelectItem>
            <SelectItem value="verified">Most Verified</SelectItem>
            <SelectItem value="pending">Pending First</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Reports List */}
      <div className="space-y-4">
        {reports.map(report => (
          <ReportCard key={report.id} report={report} />
        ))}
      </div>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex justify-center gap-2 pt-4">
          <Button
            variant="outline"
            disabled={currentPage === 1}
            asChild
          >
            <Link href={`/profile/reports?page=${currentPage - 1}&sort=${sort}&filter=${filter}`}>
              Previous
            </Link>
          </Button>

          <span className="flex items-center px-4 text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>

          <Button
            variant="outline"
            disabled={currentPage === totalPages}
            asChild
          >
            <Link href={`/profile/reports?page=${currentPage + 1}&sort=${sort}&filter=${filter}`}>
              Next
            </Link>
          </Button>
        </div>
      )}
    </div>
  );
}

function ReportCard({ report }) {
  const isVerified = report.verifications_count >= 2;

  return (
    <Link
      href={`/issues/${report.id}`}
      className="block bg-white border rounded-lg p-4 hover:shadow-md transition-shadow"
    >
      <div className="flex gap-4">
        {/* Photo */}
        {report.photos?.[0] && (
          <div className="relative w-24 h-24 rounded-lg overflow-hidden flex-shrink-0">
            <Image
              src={report.photos[0]}
              alt="Report photo"
              fill
              className="object-cover"
            />
          </div>
        )}

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-2 mb-2">
            <div>
              <h3 className="font-semibold capitalize">{report.category}</h3>
              <p className="text-sm text-gray-600">{report.address}</p>
            </div>

            <Badge variant={isVerified ? 'success' : 'secondary'}>
              {isVerified ? (
                <span className="flex items-center gap-1">
                  <CheckCircle size={14} />
                  Verified
                </span>
              ) : (
                `Pending (${report.verifications_count}/2)`
              )}
            </Badge>
          </div>

          <div className="flex items-center gap-4 text-sm text-gray-500">
            <span>
              {formatDistanceToNow(new Date(report.created_at), { addSuffix: true })}
            </span>

            {isVerified && report.verifications?.length > 0 && (
              <span>
                Verified by {report.verifications.slice(0, 2).map(v => `@${v.verifier.username}`).join(', ')}
                {report.verifications.length > 2 && ` +${report.verifications.length - 2} more`}
              </span>
            )}
          </div>
        </div>
      </div>
    </Link>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create My Reports Page

- [x] Create `/app/[locale]/profile/reports/page.tsx`
- [x] Add authentication check
- [x] Fetch user report stats
- [x] Fetch user reports with pagination
- [x] Apply filters and sorting
- [x] Render ReportStats and MyReportsList components

### Task 2: Create ReportStats Component

- [x] Create `/components/profile/ReportStats.tsx`
- [x] Display 4 stat cards (total, verified, rate, avg time)
- [x] Color-code icons
- [x] Responsive grid layout

### Task 3: Create MyReportsList Component

- [x] Create `/components/profile/MyReportsList.tsx`
- [x] Add filter dropdown (all, pending, verified, resolved)
- [x] Add sort dropdown (recent, verified, pending)
- [x] Display reports in list format
- [x] Add pagination controls
- [x] Empty state for zero reports

### Task 4: Implement Verification Speed Calculation

- [x] Query verifications with timestamps
- [x] Calculate time between issue creation and 2nd verification
- [x] Average across all verified reports
- [x] Display in hours

### Task 5: Navigation Integration

- [x] Add "My Reports" link to navigation (DesktopNav, MobileMenu)
- [x] Updated href to `/profile/reports`

### Task 6: Testing

- [ ] Unit tests for ReportStats component
- [ ] Unit tests for verification speed calculation
- [ ] Test pagination logic
- [ ] Test filter and sort combinations
- [ ] E2E test: View my reports page
- [ ] E2E test: Filter and sort reports

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (Verification records)
  - Story 1.4.1 (Authentication)
- **Blocks:** None
- **Related:**
  - Story 2.2.4 (Activity feed uses similar data)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] My Reports page created and accessible
- [ ] Report stats displaying correctly
- [ ] Verification speed calculation working
- [ ] Filter and sort working
- [ ] Pagination functional (20 per page)
- [ ] Empty state displays
- [ ] Links from profile working
- [ ] Unit tests written and passing
- [ ] E2E tests verify functionality
- [ ] Mobile responsive
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.1.9" epic="2.1" points="5" sprint="2">
  <title>Verification Analytics for Reporters</title>
  <goal>Show reporters their verification statistics and report history</goal>

  <components>
    <create file="app/[locale]/profile/reports/page.tsx"/>
    <create file="components/profile/ReportStats.tsx"/>
    <create file="components/profile/MyReportsList.tsx"/>
  </components>

  <stats>
    <metric name="total_reports" query="COUNT(*)"/>
    <metric name="verified_reports" query="COUNT(*) WHERE verifications_count >= 2"/>
    <metric name="verification_rate" formula="(verified / total) * 100"/>
    <metric name="avg_verification_speed" unit="hours"/>
  </stats>

  <pagination>
    <page-size value="20"/>
    <controls type="prev-next"/>
  </pagination>
</story>
```
