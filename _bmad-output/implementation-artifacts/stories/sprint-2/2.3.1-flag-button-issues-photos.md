# Story 2.3.1: Flag Button on Issues & Photos

**Epic:** 2.3 Community-Driven Content Flagging  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** community member  
**I want** to flag inappropriate or spam content  
**So that** I can help maintain community standards

---

## Acceptance Criteria

- [ ] "Flag" button appears on:
  - Issue detail page (report card)
  - Individual verification photos in photo gallery
- [ ] Flag button design:
  - Icon: Flag (Hugeicons `Flag01`)
  - Text: "Flag" (or icon-only on mobile)
  - Variant: Outline, destructive color on hover
  - Position: Bottom-right of report card / top-right of photo thumbnail
- [ ] Clicking "Flag" opens flag modal with:
  - **Flag reason selection** (required):
    - "Spam or scam"
    - "Offensive content"
    - "Inaccurate location"
    - "Duplicate report"
    - "Other"
  - **Optional comment** (200 char max)
  - Submit button
  - Cancel button
- [ ] **Self-flag prevention:** Users cannot flag their own reports or verifications
  - Hide flag button if `issue.user_id === current_user.id` OR `verification.verifier_id === current_user.id`
- [ ] **Duplicate flag prevention:** Users cannot flag the same content twice
  - Disable flag button if user already flagged this content
  - Show "You flagged this" instead of button
- [ ] Flag submission:
  - POST to `/api/flags` with `{ target_type, target_id, reason, comment }`
  - Toast: "Thank you for flagging. Our team will review this."
  - Modal closes
  - Button changes to "You flagged this" (disabled state)
- [ ] **Anonymous user handling:**
  - Anonymous users CAN flag using session_id (same as verification)
  - Store `session_id` if `user_id` is NULL
  - Duplicate prevention uses session_id for anonymous users
- [ ] Loading state on submit button
- [ ] Validation errors displayed inline
- [ ] Mobile responsive modal (bottom sheet)

---

## Technical Implementation

### Database Migration

```sql
-- migrations/007_flags.sql

CREATE TABLE flags (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

  -- Flagger identity (user OR anonymous session)
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id TEXT, -- For anonymous flagging

  -- Flagged content
  target_type TEXT NOT NULL, -- 'issue' or 'verification'
  target_id UUID NOT NULL,

  -- Flag details
  reason TEXT NOT NULL, -- 'spam', 'offensive', 'inaccurate_location', 'duplicate', 'other'
  comment TEXT,

  -- Metadata
  created_at TIMESTAMPTZ DEFAULT NOW(),

  -- Status (for admin moderation)
  status TEXT DEFAULT 'pending', -- 'pending', 'reviewed', 'dismissed'
  reviewed_at TIMESTAMPTZ,
  reviewed_by UUID REFERENCES auth.users(id),

  -- Constraints
  CHECK (user_id IS NOT NULL OR session_id IS NOT NULL),
  CHECK (target_type IN ('issue', 'verification')),
  CHECK (reason IN ('spam', 'offensive', 'inaccurate_location', 'duplicate', 'other')),
  CHECK (comment IS NULL OR LENGTH(comment) <= 200),

  -- Prevent duplicate flags (user or session per target)
  UNIQUE NULLS NOT DISTINCT (user_id, session_id, target_type, target_id)
);

-- RLS Policies
ALTER TABLE flags ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can insert flags"
  ON flags FOR INSERT
  WITH CHECK (
    (auth.uid() = user_id) OR (session_id IS NOT NULL)
  );

CREATE POLICY "Users can read own flags"
  ON flags FOR SELECT
  USING (
    auth.uid() = user_id OR
    auth.uid() IN (SELECT id FROM auth.users WHERE role = 'admin')
  );

-- Indexes
CREATE INDEX idx_flags_target ON flags(target_type, target_id);
CREATE INDEX idx_flags_status ON flags(status) WHERE status = 'pending';
CREATE INDEX idx_flags_user ON flags(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX idx_flags_session ON flags(session_id) WHERE session_id IS NOT NULL;
```

### FlagButton Component

```typescript
// components/flags/FlagButton.tsx
'use client';
import { useState } from 'react';
import { Flag01 } from '@hugeicons/react';
import { Button } from '@/components/ui/button';
import { FlagModal } from './FlagModal';

interface FlagButtonProps {
  targetType: 'issue' | 'verification';
  targetId: string;
  isOwnContent: boolean; // Hide if user's own content
  hasUserFlagged: boolean; // Show "You flagged this" if already flagged
}

export function FlagButton({
  targetType,
  targetId,
  isOwnContent,
  hasUserFlagged
}: FlagButtonProps) {
  const [modalOpen, setModalOpen] = useState(false);

  // Don't show flag button for own content
  if (isOwnContent) {
    return null;
  }

  // Show disabled state if already flagged
  if (hasUserFlagged) {
    return (
      <Button variant="outline" size="sm" disabled className="text-gray-500">
        <Flag01 size={16} className="mr-1" />
        You flagged this
      </Button>
    );
  }

  return (
    <>
      <Button
        variant="outline"
        size="sm"
        onClick={() => setModalOpen(true)}
        className="hover:text-red-600 hover:border-red-600"
      >
        <Flag01 size={16} className="mr-1" />
        <span className="hidden sm:inline">Flag</span>
      </Button>

      <FlagModal
        open={modalOpen}
        onOpenChange={setModalOpen}
        targetType={targetType}
        targetId={targetId}
      />
    </>
  );
}
```

### FlagModal Component

```typescript
// components/flags/FlagModal.tsx
'use client';
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import * as z from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { submitFlag } from '@/app/actions/submitFlag';
import { toast } from 'sonner';

const flagSchema = z.object({
  reason: z.enum(['spam', 'offensive', 'inaccurate_location', 'duplicate', 'other']),
  comment: z.string().max(200).optional(),
});

type FlagFormData = z.infer<typeof flagSchema>;

interface FlagModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  targetType: 'issue' | 'verification';
  targetId: string;
}

export function FlagModal({ open, onOpenChange, targetType, targetId }: FlagModalProps) {
  const [submitting, setSubmitting] = useState(false);

  const form = useForm<FlagFormData>({
    resolver: zodResolver(flagSchema),
    defaultValues: {
      reason: undefined,
      comment: '',
    },
  });

  const onSubmit = async (data: FlagFormData) => {
    setSubmitting(true);

    try {
      const result = await submitFlag({
        target_type: targetType,
        target_id: targetId,
        reason: data.reason,
        comment: data.comment || null,
      });

      if (result.success) {
        toast.success('Thank you for flagging. Our team will review this.');
        onOpenChange(false);
        form.reset();
      } else {
        toast.error(result.error || 'Failed to submit flag');
      }
    } catch (error) {
      toast.error('Failed to submit flag');
    } finally {
      setSubmitting(false);
    }
  };

  const reasonOptions = [
    { value: 'spam', label: 'Spam or scam' },
    { value: 'offensive', label: 'Offensive content' },
    { value: 'inaccurate_location', label: 'Inaccurate location' },
    { value: 'duplicate', label: 'Duplicate report' },
    { value: 'other', label: 'Other' },
  ];

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Flag Content</DialogTitle>
          <DialogDescription>
            Help us maintain community standards by reporting inappropriate content.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="reason"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Reason *</FormLabel>
                  <FormControl>
                    <RadioGroup
                      onValueChange={field.onChange}
                      value={field.value}
                      className="space-y-2"
                    >
                      {reasonOptions.map((option) => (
                        <div key={option.value} className="flex items-center space-x-2">
                          <RadioGroupItem value={option.value} id={option.value} />
                          <label
                            htmlFor={option.value}
                            className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                          >
                            {option.label}
                          </label>
                        </div>
                      ))}
                    </RadioGroup>
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="comment"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Additional details (optional)</FormLabel>
                  <FormControl>
                    <Textarea
                      {...field}
                      placeholder="Provide more context..."
                      maxLength={200}
                      rows={3}
                    />
                  </FormControl>
                  <p className="text-xs text-gray-500">
                    {field.value?.length || 0} / 200
                  </p>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex gap-2 pt-4">
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
                className="flex-1"
              >
                Cancel
              </Button>
              <Button
                type="submit"
                disabled={submitting || !form.formState.isValid}
                className="flex-1"
              >
                {submitting ? 'Submitting...' : 'Submit Flag'}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
```

### Server Action

```typescript
// app/actions/submitFlag.ts
'use server';
import { createClient } from '@/lib/supabase/server';
import { cookies } from 'next/headers';

interface SubmitFlagInput {
  target_type: 'issue' | 'verification';
  target_id: string;
  reason: 'spam' | 'offensive' | 'inaccurate_location' | 'duplicate' | 'other';
  comment?: string | null;
}

export async function submitFlag(input: SubmitFlagInput) {
  const supabase = await createClient();

  // Get user OR session_id
  const {
    data: { user },
  } = await supabase.auth.getUser();
  const cookieStore = await cookies();
  const sessionId = user ? null : cookieStore.get('session_id')?.value;

  // Prevent self-flagging (for authenticated users)
  if (user) {
    if (input.target_type === 'issue') {
      const { data: issue } = await supabase
        .from('issues')
        .select('user_id')
        .eq('id', input.target_id)
        .single();

      if (issue?.user_id === user.id) {
        return { success: false, error: 'You cannot flag your own report' };
      }
    } else if (input.target_type === 'verification') {
      const { data: verification } = await supabase
        .from('verifications')
        .select('verifier_id')
        .eq('id', input.target_id)
        .single();

      if (verification?.verifier_id === user.id) {
        return { success: false, error: 'You cannot flag your own verification' };
      }
    }
  }

  // Insert flag
  const { error } = await supabase.from('flags').insert({
    user_id: user?.id || null,
    session_id: sessionId,
    target_type: input.target_type,
    target_id: input.target_id,
    reason: input.reason,
    comment: input.comment,
  });

  if (error) {
    // Check for duplicate flag constraint violation
    if (error.code === '23505') {
      return { success: false, error: 'You have already flagged this content' };
    }

    console.error('Flag submission error:', error);
    return { success: false, error: 'Failed to submit flag' };
  }

  return { success: true };
}
```

### Integration Example (Issue Detail Page)

```typescript
// app/[locale]/issues/[id]/page.tsx (updated)
import { FlagButton } from '@/components/flags/FlagButton';

export default async function IssueDetailPage({ params }: { params: { id: string } }) {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // ... load issue ...

  // Check if user has flagged this issue
  const { data: userFlag } = user
    ? await supabase
        .from('flags')
        .select('id')
        .eq('target_type', 'issue')
        .eq('target_id', params.id)
        .eq('user_id', user.id)
        .single()
    : { data: null };

  const isOwnContent = user?.id === issue.user_id;
  const hasUserFlagged = !!userFlag;

  return (
    <div>
      {/* Issue content */}

      <FlagButton
        targetType="issue"
        targetId={issue.id}
        isOwnContent={isOwnContent}
        hasUserFlagged={hasUserFlagged}
      />
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create Database Migration

- [ ] Create `007_flags.sql`
- [ ] Define `flags` table
- [ ] Add self-flag prevention logic
- [ ] Add RLS policies
- [ ] Add indexes

### Task 2: Create FlagButton Component

- [ ] Create `/components/flags/FlagButton.tsx`
- [ ] Show/hide based on ownership
- [ ] Show disabled state if already flagged
- [ ] Open modal on click

### Task 3: Create FlagModal Component

- [ ] Create `/components/flags/FlagModal.tsx`
- [ ] Reason radio group
- [ ] Optional comment textarea
- [ ] Submit/Cancel buttons
- [ ] Form validation

### Task 4: Create Server Action

- [ ] Create `/app/actions/submitFlag.ts`
- [ ] Get user OR session_id
- [ ] Prevent self-flagging
- [ ] Insert flag record
- [ ] Handle duplicate flags

### Task 5: Integrate into Issue Detail Page

- [ ] Add FlagButton to issue card
- [ ] Check if user has flagged
- [ ] Pass props to FlagButton

### Task 6: Integrate into Photo Gallery

- [ ] Add FlagButton to verification photos
- [ ] Check if user has flagged each photo
- [ ] Position in top-right corner

### Task 7: Testing

- [ ] Test self-flag prevention
- [ ] Test duplicate flag prevention
- [ ] Test anonymous flagging
- [ ] E2E test: Flag issue

---

## Dependencies

- **Blocked by:** None
- **Blocks:**
  - Story 2.3.2 (Auto-hide logic needs flag count)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] `flags` table created
- [ ] FlagButton component functional
- [ ] FlagModal component functional
- [ ] Self-flag prevention working
- [ ] Duplicate flag prevention working
- [ ] Anonymous flagging working
- [ ] Server action working
- [ ] Integration on issue detail page
- [ ] Integration on verification photos
- [ ] Mobile responsive
- [ ] Unit tests passing
- [ ] E2E tests verify flagging
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.3.1" epic="2.3" points="3" sprint="2">
  <title>Flag Button on Issues & Photos</title>
  <goal>Allow users to flag inappropriate or spam content</goal>

  <flag-reasons>
    <reason value="spam">Spam or scam</reason>
    <reason value="offensive">Offensive content</reason>
    <reason value="inaccurate_location">Inaccurate location</reason>
    <reason value="duplicate">Duplicate report</reason>
    <reason value="other">Other</reason>
  </flag-reasons>

  <prevention>
    <self-flag>Users cannot flag own content</self-flag>
    <duplicate>Users cannot flag same content twice</duplicate>
  </prevention>
</story>
```
