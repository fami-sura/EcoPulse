# Story 2.1.1: Verification Button & UI Entry Point

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As an** authenticated community member  
**I want** to see a "Verify This Issue" button on unverified reports  
**So that** I can contribute to validating community reports

---

## Acceptance Criteria

- [ ] "Verify This Issue" button displays on issue detail pages for reports with status = 'pending'
- [ ] Button hidden for reports with status = 'verified' or 'resolved'
- [ ] Button disabled if user is the original reporter (self-verification blocked)
- [ ] **Anonymous verification check:** If user's `session_id` (from localStorage) matches report's `session_id`, disable button with tooltip: "You cannot verify your own report"
- [ ] **Session expiry enforcement:** Session IDs expire after 7 days. Reports older than 7 days with session_id cannot be self-verification blocked (session considered stale)
- [ ] Button shows verification count: "Verify (1/2)" or "Verified ✓" if threshold met
- [ ] Tap button opens verification modal/sheet (mobile: bottom sheet, desktop: modal)
- [ ] Anonymous users see "Login to verify" tooltip on hover
- [ ] Button uses Hugeicons `CheckCircle` icon
- [ ] Primary green color (#059669) when enabled, gray when disabled
- [ ] Touch target: 44x44px minimum
- [ ] Accessible: `aria-label="Verify this environmental issue"`

---

## Technical Implementation

### Components to Create/Update

**New Components:**

- `/components/verification/VerifyButton.tsx` - Main verification button component
- `/components/verification/VerificationModal.tsx` - Modal/sheet for verification flow
- `/components/verification/__tests__/VerifyButton.test.tsx` - Unit tests

**Updated Components:**

- `/app/[locale]/issues/[id]/page.tsx` - Add VerifyButton to issue detail page

### Code Structure

```typescript
// components/verification/VerifyButton.tsx
'use client';
import { useState, useEffect } from 'react';
import { CheckCircle } from '@hugeicons/react';
import { useAuthStore } from '@/stores/authStore';
import { Button } from '@/components/ui/button';
import { VerificationModal } from './VerificationModal';

interface VerifyButtonProps {
  issue: {
    id: string;
    user_id: string | null;
    session_id: string | null;
    status: 'pending' | 'verified' | 'resolved';
    verifications_count: number;
    created_at: string;
  };
}

export function VerifyButton({ issue }: VerifyButtonProps) {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [sessionId, setSessionId] = useState<string | null>(null);
  const { user } = useAuthStore();

  useEffect(() => {
    // Get session_id from localStorage
    setSessionId(localStorage.getItem('session_id'));
  }, []);

  // Helper function: Check if session is still valid (7 days)
  const isSessionValid = (reportCreatedAt: string) => {
    const SEVEN_DAYS_MS = 7 * 24 * 60 * 60 * 1000;
    const reportDate = new Date(reportCreatedAt).getTime();
    return Date.now() - reportDate < SEVEN_DAYS_MS;
  };

  // Check if user can verify
  const canVerify = () => {
    // Must be authenticated
    if (!user) return false;

    // Cannot verify own report (authenticated)
    if (issue.user_id && issue.user_id === user.id) return false;

    // Cannot verify own report (anonymous via session_id)
    // Only enforce if session is still valid (< 7 days old)
    if (
      issue.session_id &&
      sessionId &&
      issue.session_id === sessionId &&
      isSessionValid(issue.created_at)
    ) {
      return false;
    }

    // Only pending issues can be verified
    return issue.status === 'pending';
  };

  // Get tooltip message
  const getTooltip = () => {
    if (!user) return "Login to verify";
    if (issue.user_id === user.id) return "You cannot verify your own report";
    if (issue.session_id === sessionId && isSessionValid(issue.created_at)) {
      return "You cannot verify your own report";
    }
    if (issue.status !== 'pending') return "Issue already verified";
    return "Verify this environmental issue";
  };

  // Get button label
  const getLabel = () => {
    if (issue.verifications_count >= 2) return "Verified ✓";
    return `Verify (${issue.verifications_count}/2)`;
  };

  const isVerified = issue.verifications_count >= 2;
  const isDisabled = !canVerify() || isVerified;

  return (
    <>
      <Button
        onClick={() => setIsModalOpen(true)}
        disabled={isDisabled}
        className="flex items-center gap-2 h-11 min-w-44"
        variant={isDisabled ? "outline" : "default"}
        aria-label={getTooltip()}
        title={getTooltip()}
      >
        <CheckCircle
          size={20}
          className={isVerified ? "text-green-600" : ""}
        />
        <span>{getLabel()}</span>
      </Button>

      <VerificationModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        issueId={issue.id}
        verifierSessionId={sessionId}
      />
    </>
  );
}
```

```typescript
// components/verification/VerificationModal.tsx
'use client';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
import { useMediaQuery } from '@/hooks/useMediaQuery';

interface VerificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  issueId: string;
  verifierSessionId: string | null;
}

export function VerificationModal({
  isOpen,
  onClose,
  issueId,
  verifierSessionId
}: VerificationModalProps) {
  const isMobile = useMediaQuery('(max-width: 768px)');

  const content = (
    <div className="space-y-4">
      <p className="text-sm text-gray-600">
        Verification form will go here (Story 2.1.2-2.1.3)
      </p>
    </div>
  );

  // Mobile: Bottom sheet
  if (isMobile) {
    return (
      <Sheet open={isOpen} onOpenChange={onClose}>
        <SheetContent side="bottom" className="h-[80vh]">
          <SheetHeader>
            <SheetTitle>Verify This Issue</SheetTitle>
          </SheetHeader>
          {content}
        </SheetContent>
      </Sheet>
    );
  }

  // Desktop: Modal
  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-md">
        <DialogHeader>
          <DialogTitle>Verify This Issue</DialogTitle>
        </DialogHeader>
        {content}
      </DialogContent>
    </Dialog>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create VerifyButton Component

- [ ] Create `/components/verification/VerifyButton.tsx`
- [ ] Add session_id check logic (localStorage)
- [ ] Implement 7-day session expiry validation
- [ ] Add self-verification blocking (authenticated + anonymous)
- [ ] Show verification count: "Verify (1/2)" or "Verified ✓"
- [ ] Add tooltip for disabled states
- [ ] Style button with conditional colors (green/gray)
- [ ] Ensure 44x44px minimum touch target

### Task 2: Create VerificationModal Component

- [ ] Create `/components/verification/VerificationModal.tsx`
- [ ] Implement responsive modal (desktop) / bottom sheet (mobile)
- [ ] Add modal open/close state management
- [ ] Add placeholder content for verification form
- [ ] Style with shadcn/ui Dialog and Sheet components

### Task 3: Integrate into Issue Detail Page

- [ ] Update `/app/[locale]/issues/[id]/page.tsx`
- [ ] Fetch issue data with `verifications_count` column
- [ ] Add VerifyButton component below issue details
- [ ] Position button prominently (sticky footer on mobile)
- [ ] Test with different issue statuses

### Task 4: Session ID Management

- [ ] Ensure session_id is set in localStorage (from Story 1.3.x)
- [ ] Add utility function for session validity check
- [ ] Document session expiry logic (7 days)
- [ ] Add fallback if localStorage unavailable

### Task 5: Testing

- [ ] Write unit tests for VerifyButton
- [ ] Test self-verification blocking (authenticated)
- [ ] Test self-verification blocking (anonymous via session_id)
- [ ] Test session expiry logic (7 days)
- [ ] Test disabled states and tooltips
- [ ] Test modal open/close behavior
- [ ] E2E test: Verify button appears on pending issues
- [ ] E2E test: Verify button hidden on verified issues

---

## Dependencies

- **Blocked by:**
  - Story 1.3.7 (Issue Detail Page) ✅ COMPLETE
  - Story 1.4.1 (Authentication) ✅ COMPLETE
- **Blocks:**
  - Story 2.1.2 (Verification Photo Capture)
  - Story 2.1.3 (Verification Context Notes)
- **Related:**
  - Story 1.3.1 (Floating Action Button pattern)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] VerifyButton component created and functional
- [ ] VerificationModal responsive (mobile sheet, desktop modal)
- [ ] Self-verification blocked (authenticated + anonymous)
- [ ] Session expiry enforced (7 days)
- [ ] Verification count displayed: "Verify (1/2)"
- [ ] Button disabled for verified/resolved issues
- [ ] Touch target 44x44px minimum
- [ ] Unit tests written and passing (80% coverage)
- [ ] E2E tests verify button visibility rules
- [ ] Works on Chrome, Safari, Firefox (desktop + mobile)
- [ ] Accessible: WCAG 2.1 AA compliant
- [ ] No console errors or warnings
- [ ] Code reviewed and approved
- [ ] Deployed to Vercel preview environment

---

## Notes

### Session Expiry Logic

- **Why 7 days?** Balance between usability and security
- Reports older than 7 days: session_id self-verification block doesn't apply
- Prevents permanent lockout of old anonymous reports

### Design Decisions

- **Mobile:** Bottom sheet for better thumb reach
- **Desktop:** Modal for focus and clarity
- **Verification count:** Builds trust and shows progress toward threshold

### Performance Considerations

- Session ID check is client-side (no server request)
- Modal lazy loads verification form components
- Button state calculations cached in useMemo

### Accessibility

- `aria-label` describes action and state
- Disabled state communicated via tooltip
- Keyboard navigation: Tab to button, Enter to open modal
- Screen reader announces verification count

---

## Story Context XML

```xml
<story id="2.1.1" epic="2.1" points="3" sprint="2">
  <title>Verification Button & UI Entry Point</title>
  <goal>Provide UI entry point for community members to verify environmental reports</goal>

  <components>
    <create file="components/verification/VerifyButton.tsx" reason="Main verification button"/>
    <create file="components/verification/VerificationModal.tsx" reason="Responsive modal container"/>
    <update file="app/[locale]/issues/[id]/page.tsx" reason="Add verification button"/>
  </components>

  <validation>
    <rule type="self-verification-authenticated" check="user_id !== verifier_id"/>
    <rule type="self-verification-anonymous" check="session_id !== verifier_session_id && session_valid"/>
    <rule type="session-expiry" threshold="7 days"/>
    <rule type="status-check" allowed="pending"/>
  </validation>

  <ui>
    <button touch-target="44x44px" color-enabled="#059669" color-disabled="gray"/>
    <modal type="responsive" mobile="bottom-sheet" desktop="dialog"/>
    <tooltip position="top" triggers="hover,focus"/>
  </ui>

  <testing>
    <unit component="VerifyButton" scenarios="4"/>
    <e2e scenario="button-visibility-rules"/>
    <a11y standard="WCAG 2.1 AA"/>
  </testing>
</story>
```
