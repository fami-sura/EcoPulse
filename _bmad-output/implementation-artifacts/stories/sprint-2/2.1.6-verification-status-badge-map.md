# Story 2.1.6: Verification Status Badge on Map Pins

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** map viewer  
**I want** to see which issues are verified  
**So that** I can quickly identify community-validated reports

---

## Acceptance Criteria

- [ ] Map pins display different icons based on verification status:
  - Pending (0-1 verifications): Gray `MapPin` icon
  - Verified (2+ verifications): Green `MapPinHome` icon with checkmark badge
  - Resolved: Green `CheckCircle` icon
- [ ] Verified pin icon includes small green dot or checkmark overlay (top-right corner)
- [ ] Verification count shown on pin hover (desktop) or tap (mobile):
  - Tooltip: "2 verifications"
- [ ] Filter panel includes "Verified Only" toggle:
  - Checkbox: "Show only verified issues"
  - Applies filter to map query: `WHERE verifications_count >= 2`
- [ ] Verified pin color: #059669 (primary green)
- [ ] Pending pin color: #9CA3AF (gray)
- [ ] Pin size: 44x44px touch target
- [ ] Accessible: ARIA labels on pins include verification status

---

## Technical Implementation

### Components to Update

```typescript
// components/map/IssueMarker.tsx (UPDATE from Story 0.3)
'use client';
import { useMemo } from 'react';
import { Marker, Tooltip } from 'react-leaflet';
import { divIcon } from 'leaflet';
import { renderToStaticMarkup } from 'react-dom/server';
import { MapPin, MapPinHome, CheckCircle } from '@hugeicons/react';

interface IssueMarkerProps {
  issue: {
    id: string;
    lat: number;
    lng: number;
    category: 'waste' | 'drainage';
    severity: 'low' | 'medium' | 'high';
    status: 'pending' | 'verified' | 'in_progress' | 'resolved';
    verifications_count: number;
  };
}

export function IssueMarker({ issue }: IssueMarkerProps) {
  const icon = useMemo(() => {
    let IconComponent;
    let color;
    let badge = null;

    // Determine icon and color based on status
    if (issue.status === 'resolved') {
      IconComponent = CheckCircle;
      color = 'text-green-600';
    } else if (issue.verifications_count >= 2) {
      IconComponent = MapPinHome;
      color = 'text-green-600';
      // Add checkmark badge
      badge = (
        <div className="absolute -top-1 -right-1 w-3 h-3 bg-green-600 rounded-full border-2 border-white flex items-center justify-center">
          <span className="text-white text-[8px]">✓</span>
        </div>
      );
    } else {
      IconComponent = MapPin;
      color = 'text-gray-500';
    }

    const iconHtml = renderToStaticMarkup(
      <div className="relative w-11 h-11 flex items-center justify-center">
        <IconComponent className={`${color} w-8 h-8`} />
        {badge}
      </div>
    );

    return divIcon({
      html: iconHtml,
      className: 'custom-marker',
      iconSize: [44, 44],
      iconAnchor: [22, 44],
    });
  }, [issue.status, issue.verifications_count]);

  const tooltipText = issue.verifications_count >= 2
    ? `${issue.verifications_count} verifications`
    : 'Pending verification';

  return (
    <Marker
      position={[issue.lat, issue.lng]}
      icon={icon}
      eventHandlers={{
        click: () => {
          window.location.href = `/issues/${issue.id}`;
        }
      }}
    >
      <Tooltip>
        <div className="text-sm">
          <div className="font-medium capitalize">{issue.category}</div>
          <div className="text-gray-600">{tooltipText}</div>
        </div>
      </Tooltip>
    </Marker>
  );
}
```

### Map Filter Component

```typescript
// components/map/MapFilters.tsx (UPDATE from Story 1.2.4)
'use client';
import { useState } from 'react';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { useMapStore } from '@/stores/mapStore';

export function MapFilters() {
  const { filters, setFilters } = useMapStore();

  return (
    <div className="absolute top-4 left-4 z-1000 bg-white rounded-lg shadow-lg p-4 space-y-3">
      <h3 className="font-semibold text-sm">Filters</h3>

      {/* Category Filters */}
      <div className="space-y-2">
        <Label className="text-xs text-gray-600">Category</Label>
        <div className="flex items-center space-x-2">
          <Checkbox
            id="filter-waste"
            checked={filters.categories.includes('waste')}
            onCheckedChange={(checked) => {
              const newCategories = checked
                ? [...filters.categories, 'waste']
                : filters.categories.filter(c => c !== 'waste');
              setFilters({ ...filters, categories: newCategories });
            }}
          />
          <Label htmlFor="filter-waste" className="text-sm">Waste</Label>
        </div>
        <div className="flex items-center space-x-2">
          <Checkbox
            id="filter-drainage"
            checked={filters.categories.includes('drainage')}
            onCheckedChange={(checked) => {
              const newCategories = checked
                ? [...filters.categories, 'drainage']
                : filters.categories.filter(c => c !== 'drainage');
              setFilters({ ...filters, categories: newCategories });
            }}
          />
          <Label htmlFor="filter-drainage" className="text-sm">Drainage</Label>
        </div>
      </div>

      {/* Verification Filter */}
      <div className="space-y-2 pt-2 border-t">
        <Label className="text-xs text-gray-600">Status</Label>
        <div className="flex items-center space-x-2">
          <Checkbox
            id="filter-verified-only"
            checked={filters.verifiedOnly}
            onCheckedChange={(checked) => {
              setFilters({ ...filters, verifiedOnly: !!checked });
            }}
          />
          <Label htmlFor="filter-verified-only" className="text-sm">
            Show only verified issues
          </Label>
        </div>
      </div>
    </div>
  );
}
```

### Zustand Store Update

```typescript
// stores/mapStore.ts (ADD to existing state)
interface MapState {
  center: [number, number];
  zoom: number;
  selectedLayer: 'street' | 'satellite';
  filters: {
    categories: ('waste' | 'drainage')[];
    verifiedOnly: boolean;
  };
  setCenter: (center: [number, number]) => void;
  setZoom: (zoom: number) => void;
  setSelectedLayer: (layer: 'street' | 'satellite') => void;
  setFilters: (filters: MapState['filters']) => void;
}

export const useMapStore = create<MapState>()(
  persist(
    (set) => ({
      center: [6.5244, 3.3792],
      zoom: 13,
      selectedLayer: 'street',
      filters: {
        categories: ['waste', 'drainage'],
        verifiedOnly: false,
      },
      setCenter: (center) => set({ center }),
      setZoom: (zoom) => set({ zoom }),
      setSelectedLayer: (selectedLayer) => set({ selectedLayer }),
      setFilters: (filters) => set({ filters }),
    }),
    {
      name: 'map-storage',
      partialize: (state) => ({
        selectedLayer: state.selectedLayer,
        filters: state.filters,
      }),
    }
  )
);
```

---

## Tasks & Subtasks

### Task 1: Update IssueMarker Component

- [ ] Add verification status icon logic
- [ ] Add checkmark badge for verified issues
- [ ] Update colors (green for verified, gray for pending)
- [ ] Add tooltip with verification count
- [ ] Ensure 44x44px touch target
- [ ] Add ARIA labels for accessibility

### Task 2: Update MapFilters Component

- [ ] Add "Verified Only" checkbox
- [ ] Connect to Zustand store filters
- [ ] Update map query when toggled
- [ ] Persist filter state to localStorage

### Task 3: Update Map Query Logic

- [ ] Add verifications_count to issue query
- [ ] Apply verifiedOnly filter to WHERE clause
- [ ] Test filter performance with 500+ issues

### Task 4: Update Zustand Store

- [ ] Add filters state (categories, verifiedOnly)
- [ ] Add setFilters action
- [ ] Persist filters to localStorage
- [ ] Initialize with default values

### Task 5: Testing

- [ ] Unit tests for IssueMarker (all statuses)
- [ ] Test verification badge rendering
- [ ] Test filter toggle functionality
- [ ] E2E test: Verified filter shows only verified issues
- [ ] E2E test: Pin colors match verification status

---

## Dependencies

- **Blocked by:**
  - Story 0.3 (IssueMarker component) ✅ COMPLETE
  - Story 1.2.4 (MapFilters component) ✅ COMPLETE
  - Story 2.1.4 (verifications_count column exists)
- **Blocks:** None
- **Related:**
  - Story 1.2.2 (Display Issue Pins)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] IssueMarker shows correct icon per status
- [ ] Verified pins have checkmark badge
- [ ] Tooltip shows verification count
- [ ] "Verified Only" filter working
- [ ] Filter persists to localStorage
- [ ] Pin colors correct (green/gray)
- [ ] Touch target 44x44px minimum
- [ ] ARIA labels present
- [ ] Unit tests written and passing
- [ ] E2E tests verify filtering
- [ ] Works on Chrome, Safari, Firefox
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Notes

### Icon Design

- **Pending:** Gray MapPin (not validated yet)
- **Verified:** Green MapPinHome with checkmark (community confirmed)
- **Resolved:** Green CheckCircle (issue fixed)

### Filter Behavior

- "Verified Only" filter: `WHERE verifications_count >= 2`
- Combines with category filters (AND logic)
- Filter state persists across sessions

### Performance

- Verification count denormalized for fast queries
- Index on verifications_count column
- Client-side filtering after initial fetch (MVP)

### Accessibility

- ARIA labels: "Verified issue with 2 verifications"
- Keyboard navigation: Tab to pins
- Screen reader announces status on focus

---

## Story Context XML

```xml
<story id="2.1.6" epic="2.1" points="3" sprint="2">
  <title>Verification Status Badge on Map Pins</title>
  <goal>Visual distinction of verified issues on map for quick identification</goal>

  <components>
    <update file="components/map/IssueMarker.tsx" reason="Add verification badges"/>
    <update file="components/map/MapFilters.tsx" reason="Add verified filter"/>
    <update file="stores/mapStore.ts" reason="Add filters state"/>
  </components>

  <icons>
    <status value="pending" icon="MapPin" color="gray-500"/>
    <status value="verified" icon="MapPinHome" color="green-600" badge="checkmark"/>
    <status value="resolved" icon="CheckCircle" color="green-600"/>
  </icons>

  <filters>
    <filter name="verifiedOnly" type="boolean" query="verifications_count >= 2"/>
    <persistence storage="localStorage" key="map-storage"/>
  </filters>
</story>
```
