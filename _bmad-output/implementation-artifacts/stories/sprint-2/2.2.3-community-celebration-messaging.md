# Story 2.2.3: Community Celebration Messaging

**Epic:** 2.2 User Profiles with Tangible Impact  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to receive positive celebration messages when I contribute  
**So that** I feel appreciated without competitive pressure

---

## Acceptance Criteria

- [ ] **Milestone modals** appear when user reaches impact milestones:
  - First verified report: "Great start! Your first report is helping the community!"
  - 5 verified reports: "You've identified ~75 kg of waste! Keep it up!"
  - 10 verified reports: "Amazing! Your 10 verified reports are making a difference!"
  - First verification of someone else's report: "Thank you for verifying! You're building community trust!"
  - First drain cleared: "You helped clear a drainage blockage! Great work!"
- [ ] **Toast notifications** for immediate actions:
  - Report verified (2 verifications reached): "Your report is now verified! ~15 kg waste identified!"
  - Verification submitted: "Thank you for verifying! This helps the community!"
- [ ] **Celebration modal design:**
  - Full-screen overlay (mobile) / centered dialog (desktop)
  - Celebration icon (checkmark, confetti, trophy)
  - Headline message
  - Impact summary
  - "Continue" button
  - Optional "Share" button (future: social sharing)
- [ ] **Messaging tone:**
  - Community-focused (NOT competitive)
  - Tangible impact (NOT abstract points)
  - Encouraging (NOT pressuring)
  - ✅ "You've identified 75 kg of waste! Your community thanks you!"
  - ❌ "You're rank #5! Beat player #4 by reporting 3 more issues!"
- [ ] **Milestone tracking:**
  - Store milestone completions in `user_milestones` table
  - Only show each milestone once per user
  - No visual milestone badges (per stakeholder directive)
- [ ] **Accessibility:**
  - Toast auto-dismisses after 5 seconds
  - Modal dismissible with "Continue" button or ESC key
  - Focus trap in modal
  - Screen reader announcements

---

## Technical Implementation

### Database Migration

```sql
-- migrations/006_user_milestones.sql

CREATE TABLE user_milestones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  milestone_type TEXT NOT NULL, -- 'first_verified_report', '5_verified_reports', etc.
  achieved_at TIMESTAMPTZ DEFAULT NOW(),

  UNIQUE(user_id, milestone_type)
);

-- RLS Policies
ALTER TABLE user_milestones ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own milestones"
  ON user_milestones FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "System can insert milestones"
  ON user_milestones FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- Indexes
CREATE INDEX idx_user_milestones_user_id ON user_milestones(user_id);
```

### Milestone Checker Utility

```typescript
// lib/milestones/checkMilestones.ts
import { createClient } from '@/lib/supabase/server';

export type MilestoneType =
  | 'first_verified_report'
  | '5_verified_reports'
  | '10_verified_reports'
  | 'first_verification_given'
  | 'first_drain_cleared';

interface MilestoneConfig {
  type: MilestoneType;
  title: string;
  message: string;
  icon: 'checkmark' | 'confetti' | 'trophy';
}

const MILESTONES: Record<MilestoneType, MilestoneConfig> = {
  first_verified_report: {
    type: 'first_verified_report',
    title: 'Great Start!',
    message: 'Your first report is helping the community!',
    icon: 'checkmark',
  },
  '5_verified_reports': {
    type: '5_verified_reports',
    title: "You've Identified ~75 kg of Waste!",
    message: 'Keep up the great work! Your reports are making a difference.',
    icon: 'confetti',
  },
  '10_verified_reports': {
    type: '10_verified_reports',
    title: 'Amazing Impact!',
    message: 'Your 10 verified reports are helping clean up the community!',
    icon: 'trophy',
  },
  first_verification_given: {
    type: 'first_verification_given',
    title: 'Thank You for Verifying!',
    message: "You're building community trust by verifying reports!",
    icon: 'checkmark',
  },
  first_drain_cleared: {
    type: 'first_drain_cleared',
    title: 'Drainage Blockage Cleared!',
    message: 'You helped clear a drainage issue! Great work!',
    icon: 'trophy',
  },
};

export async function checkMilestones(userId: string): Promise<MilestoneConfig | null> {
  const supabase = await createClient();

  // Get user's verified report count
  const { data: issues, error: issuesError } = await supabase
    .from('issues')
    .select('id')
    .eq('user_id', userId)
    .gte('verifications_count', 2);

  if (issuesError) throw issuesError;

  const verifiedCount = issues?.length || 0;

  // Get user's verification count
  const { data: verifications, error: verificationsError } = await supabase
    .from('verifications')
    .select('id')
    .eq('verifier_id', userId);

  if (verificationsError) throw verificationsError;

  const verificationCount = verifications?.length || 0;

  // Get user's drain clearances
  const { data: drains, error: drainsError } = await supabase
    .from('issues')
    .select('id')
    .eq('category', 'drainage')
    .eq('status', 'resolved')
    .contains('verified_by_user_ids', [userId]); // User verified this drain

  if (drainsError) throw drainsError;

  const drainCount = drains?.length || 0;

  // Check which milestones to award
  const milestones: MilestoneType[] = [];

  if (verifiedCount === 1) milestones.push('first_verified_report');
  if (verifiedCount === 5) milestones.push('5_verified_reports');
  if (verifiedCount === 10) milestones.push('10_verified_reports');
  if (verificationCount === 1) milestones.push('first_verification_given');
  if (drainCount === 1) milestones.push('first_drain_cleared');

  // Check which milestones are new
  for (const milestoneType of milestones) {
    const { data: existing } = await supabase
      .from('user_milestones')
      .select('id')
      .eq('user_id', userId)
      .eq('milestone_type', milestoneType)
      .single();

    if (!existing) {
      // Award milestone
      await supabase
        .from('user_milestones')
        .insert({ user_id: userId, milestone_type: milestoneType });

      // Return milestone config to show modal
      return MILESTONES[milestoneType];
    }
  }

  return null; // No new milestones
}
```

### Celebration Modal Component

```typescript
// components/milestones/CelebrationModal.tsx
'use client';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { CheckmarkCircle01, Celebrate, Trophy } from '@hugeicons/react';

interface CelebrationModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  message: string;
  icon: 'checkmark' | 'confetti' | 'trophy';
}

export function CelebrationModal({
  open,
  onOpenChange,
  title,
  message,
  icon
}: CelebrationModalProps) {
  const icons = {
    checkmark: <CheckmarkCircle01 size={64} className="text-green-500" />,
    confetti: <Celebrate size={64} className="text-blue-500" />,
    trophy: <Trophy size={64} className="text-orange-500" />,
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader className="text-center">
          <div className="flex justify-center mb-4">
            {icons[icon]}
          </div>
          <DialogTitle className="text-2xl font-bold">{title}</DialogTitle>
        </DialogHeader>

        <p className="text-center text-gray-700 text-lg">{message}</p>

        <div className="mt-6">
          <Button
            onClick={() => onOpenChange(false)}
            className="w-full"
            size="lg"
          >
            Continue
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### Toast Notification Utility

```typescript
// lib/toast/celebrationToast.ts
import { toast } from 'sonner';

export function showVerificationToast() {
  toast.success('Thank you for verifying!', {
    description: 'This helps build community trust!',
    duration: 5000,
  });
}

export function showReportVerifiedToast(estimatedKg: number = 15) {
  toast.success('Your report is now verified!', {
    description: `~${estimatedKg} kg waste identified!`,
    duration: 5000,
  });
}
```

### Integration Example (Server Action)

```typescript
// app/actions/createIssue.ts (updated)
'use server';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { checkMilestones } from '@/lib/milestones/checkMilestones';

export async function createIssue(formData: FormData) {
  const supabase = await createClient();

  // ... existing issue creation logic ...

  const { data: user } = await supabase.auth.getUser();
  if (!user.user) throw new Error('Unauthorized');

  // Check for milestones (async, non-blocking)
  const milestone = await checkMilestones(user.user.id);

  return {
    success: true,
    issueId: newIssue.id,
    milestone, // Return to client for modal display
  };
}
```

### Client Component (Report Form)

```typescript
// components/report/ReportForm.tsx (updated)
'use client';
import { useState } from 'react';
import { createIssue } from '@/app/actions/createIssue';
import { CelebrationModal } from '@/components/milestones/CelebrationModal';

export function ReportForm() {
  const [celebrationModal, setCelebrationModal] = useState<any>(null);

  const handleSubmit = async (formData: FormData) => {
    const result = await createIssue(formData);

    // Show celebration modal if milestone achieved
    if (result.milestone) {
      setCelebrationModal(result.milestone);
    }
  };

  return (
    <>
      <form action={handleSubmit}>
        {/* ... form fields ... */}
      </form>

      {celebrationModal && (
        <CelebrationModal
          open={!!celebrationModal}
          onOpenChange={(open) => !open && setCelebrationModal(null)}
          title={celebrationModal.title}
          message={celebrationModal.message}
          icon={celebrationModal.icon}
        />
      )}
    </>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create Database Migration

- [ ] Create `006_user_milestones.sql`
- [ ] Define `user_milestones` table
- [ ] Add RLS policies
- [ ] Add indexes

### Task 2: Create Milestone Checker

- [ ] Create `/lib/milestones/checkMilestones.ts`
- [ ] Define milestone types & configs
- [ ] Implement checking logic
- [ ] Award new milestones

### Task 3: Create CelebrationModal Component

- [ ] Create `/components/milestones/CelebrationModal.tsx`
- [ ] Add icons (checkmark, confetti, trophy)
- [ ] Add responsive design
- [ ] Add focus trap

### Task 4: Create Toast Utility

- [ ] Create `/lib/toast/celebrationToast.ts`
- [ ] Add verification toast
- [ ] Add report verified toast

### Task 5: Integrate into Server Actions

- [ ] Update `createIssue` action
- [ ] Update `createVerification` action
- [ ] Return milestone data to client

### Task 6: Integrate into Client Components

- [ ] Add CelebrationModal to ReportForm
- [ ] Add toasts to verification flow
- [ ] Handle modal state

### Task 7: Testing

- [ ] Test milestone awarding logic
- [ ] Test duplicate prevention
- [ ] Test modal display
- [ ] Test toast notifications
- [ ] E2E test: First verified report milestone

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (Verifications data)
  - Story 2.2.2 (Impact metrics for messaging)
- **Blocks:** None

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] `user_milestones` table created
- [ ] Milestone checking logic working
- [ ] CelebrationModal component functional
- [ ] Toast notifications working
- [ ] Community-focused messaging (not competitive)
- [ ] Each milestone shows only once
- [ ] Mobile responsive
- [ ] Accessible (focus trap, screen reader)
- [ ] Unit tests passing
- [ ] E2E tests verify milestones
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.2.3" epic="2.2" points="3" sprint="2">
  <title>Community Celebration Messaging</title>
  <goal>Celebrate user contributions with community-focused messages</goal>

  <milestones>
    <milestone type="first_verified_report" icon="checkmark" title="Great Start!" />
    <milestone type="5_verified_reports" icon="confetti" title="75 kg Identified!" />
    <milestone type="10_verified_reports" icon="trophy" title="Amazing Impact!" />
    <milestone type="first_verification_given" icon="checkmark" title="Thank You!" />
    <milestone type="first_drain_cleared" icon="trophy" title="Drain Cleared!" />
  </milestones>

  <messaging-tone>
    <guideline>Community-focused (NOT competitive)</guideline>
    <guideline>Tangible impact (NOT abstract points)</guideline>
    <guideline>Encouraging (NOT pressuring)</guideline>
  </messaging-tone>
</story>
```
