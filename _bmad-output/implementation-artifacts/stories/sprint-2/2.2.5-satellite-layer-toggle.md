# Story 2.2.5: Satellite Layer Toggle

**Epic:** 1.2 Interactive Map with Clustering & Filters  
**Story Points:** 2  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to switch between street map and satellite view  
**So that** I can verify environmental issues with real-world satellite imagery

---

## Acceptance Criteria

- [ ] Layer toggle control displays on map (bottom-right, near zoom controls)
- [ ] Two base layers available:
  - OpenStreetMap (default, street view)
  - Esri World Imagery (satellite view)
- [ ] Desktop: Uses Leaflet's built-in `LayersControl` component
- [ ] Mobile: Custom toggle button with icon (44x44px touch target)
- [ ] Toggle button icons:
  - Street view: üó∫Ô∏è Map icon
  - Satellite view: üõ∞Ô∏è Satellite icon
- [ ] Smooth fade transition between layers (300ms)
- [ ] User's layer preference persists in Zustand store
- [ ] Layer preference saved to localStorage (persists across sessions)
- [ ] Accessibility: `aria-label` describes current and next layer state
- [ ] No performance degradation when switching layers
- [ ] Attribution properly displays for both layers

---

## Technical Implementation

### Components to Update

- `/components/map/BaseMap.tsx` - Add LayersControl with both tile layers
- `/components/map/LayerToggle.tsx` - NEW: Mobile-optimized toggle button
- `/components/map/__tests__/LayerToggle.test.tsx` - NEW: Unit tests

### State Management

- Zustand store: `useMapStore({ selectedLayer, setSelectedLayer })`
- Layer options: `'street' | 'satellite'`
- Persist to localStorage using Zustand persist middleware

### Code Structure

```typescript
// components/map/BaseMap.tsx
'use client';
import { MapContainer, TileLayer, LayersControl } from 'react-leaflet';

export function BaseMap({ center, zoom, children, className, onMapReady }: BaseMapProps) {
  const { selectedLayer, setSelectedLayer } = useMapStore();

  return (
    <MapContainer
      center={center}
      zoom={zoom}
      className={className}
      scrollWheelZoom={true}
      zoomControl={true}
    >
      <LayersControl position="bottomright">
        {/* OpenStreetMap - Default Street View */}
        <LayersControl.BaseLayer checked={selectedLayer === 'street'} name="Street Map">
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
            maxZoom={19}
          />
        </LayersControl.BaseLayer>

        {/* Esri World Imagery - Satellite View */}
        <LayersControl.BaseLayer checked={selectedLayer === 'satellite'} name="Satellite">
          <TileLayer
            attribution='Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            url="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
            maxZoom={19}
          />
        </LayersControl.BaseLayer>
      </LayersControl>

      {/* Mobile-only custom toggle */}
      <div className="md:hidden">
        <LayerToggle />
      </div>

      {children}
    </MapContainer>
  );
}
```

```typescript
// components/map/LayerToggle.tsx
'use client';
import { useMapStore } from '@/stores/mapStore';
import { HugeiconsIcon } from '@hugeicons/react';
import { Maps01Icon, SatelliteIcon } from '@hugeicons/core-free-icons';

export function LayerToggle() {
  const { selectedLayer, setSelectedLayer } = useMapStore();

  const toggleLayer = () => {
    setSelectedLayer(selectedLayer === 'street' ? 'satellite' : 'street');
  };

  const isSatellite = selectedLayer === 'satellite';

  return (
    <button
      onClick={toggleLayer}
      className="absolute bottom-24 right-4 z-1000 h-11 w-11 rounded-lg bg-white shadow-lg"
      aria-label={isSatellite ? 'Switch to street map' : 'Switch to satellite view'}
    >
      <HugeiconsIcon
        icon={isSatellite ? Maps01Icon : SatelliteIcon}
        className="text-gray-700"
        size={24}
      />
    </button>
  );
}
```

```typescript
// stores/mapStore.ts (updates)
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface MapState {
  center: [number, number];
  zoom: number;
  selectedLayer: 'street' | 'satellite';
  setCenter: (center: [number, number]) => void;
  setZoom: (zoom: number) => void;
  setSelectedLayer: (layer: 'street' | 'satellite') => void;
}

export const useMapStore = create<MapState>()(
  persist(
    (set) => ({
      center: [6.5244, 3.3792],
      zoom: 13,
      selectedLayer: 'street',
      setCenter: (center) => set({ center }),
      setZoom: (zoom) => set({ zoom }),
      setSelectedLayer: (selectedLayer) => set({ selectedLayer }),
    }),
    {
      name: 'map-storage',
      partialize: (state) => ({ selectedLayer: state.selectedLayer }), // Only persist layer preference
    }
  )
);
```

---

## Tasks & Subtasks

### Task 1: Update Zustand Store for Layer Preference

- [ ] Add `selectedLayer: 'street' | 'satellite'` to mapStore state
- [ ] Add `setSelectedLayer` action
- [ ] Add Zustand persist middleware
- [ ] Configure localStorage key: `'map-storage'`
- [ ] Only persist `selectedLayer` field (not center/zoom)
- [ ] Write unit tests for store updates

### Task 2: Add LayersControl to BaseMap

- [ ] Import `LayersControl` from `react-leaflet`
- [ ] Wrap existing TileLayer in `LayersControl.BaseLayer`
- [ ] Add Esri World Imagery as second BaseLayer
- [ ] Set position to `"bottomright"`
- [ ] Connect to `selectedLayer` state for controlled behavior
- [ ] Update layer on state change
- [ ] Ensure proper attribution for both layers

### Task 3: Create Mobile LayerToggle Component

- [ ] Create `/components/map/LayerToggle.tsx`
- [ ] Add toggle button (44x44px minimum touch target)
- [ ] Position: `absolute bottom-24 right-4 z-1000`
- [ ] Use Maps01Icon for street, SatelliteIcon for satellite
- [ ] Add smooth transitions (300ms fade)
- [ ] Connect to `selectedLayer` and `setSelectedLayer` from store
- [ ] Add proper `aria-label` for accessibility

### Task 4: Responsive Design

- [ ] Hide Leaflet's default LayersControl on mobile (`md:hidden`)
- [ ] Show custom LayerToggle button on mobile only
- [ ] Show Leaflet's LayersControl on desktop/tablet (md:block)
- [ ] Ensure no z-index conflicts with existing map controls

### Task 5: Layer Transition & Performance

- [ ] Add CSS transitions for smooth layer switching
- [ ] Test layer switching performance (should be < 500ms)
- [ ] Ensure no map position/zoom reset when switching
- [ ] Verify attribution updates correctly
- [ ] Test with slow network conditions

### Task 6: Testing

- [ ] Write unit tests for LayerToggle component
- [ ] Test layer switching behavior
- [ ] Test localStorage persistence
- [ ] Test mobile vs desktop rendering
- [ ] Test accessibility (aria-label, keyboard navigation)
- [ ] E2E test: Switch layers and verify tiles change
- [ ] E2E test: Verify layer preference persists after page reload

---

## Dependencies

- **Blocked by:** Story 1.2.1 (Basic Leaflet Map Setup) ‚úÖ COMPLETE
- **Blocks:** None
- **Related:** Story 1.2.2 (Display Issue Pins) - pins should render on both layers

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Unit tests written and passing (80% coverage)
- [ ] E2E tests verify layer switching and persistence
- [ ] Works on Chrome, Safari, Firefox (desktop + mobile)
- [ ] Touch target 44x44px minimum (mobile)
- [ ] Smooth transitions (no flicker)
- [ ] Layer preference persists across page reloads
- [ ] No console errors or warnings
- [ ] Proper attribution displays for both layers
- [ ] Code reviewed and approved
- [ ] Deployed to Vercel preview environment

---

## Notes

### Tile Provider Details

- **OpenStreetMap**: Free, no API key, 19 zoom levels
- **Esri World Imagery**: Free tier, check usage limits (no known restrictions for low-volume apps)
- Alternative satellite providers if Esri has issues:
  - Google Satellite (requires API key + billing)
  - Mapbox Satellite (requires API key)

### Design Decisions

- **Why two UIs?** Desktop has space for LayersControl; mobile needs simplified toggle
- **Why persist layer?** User preference should survive sessions
- **Why Esri?** Free, no API key, good satellite imagery quality

### Performance Considerations

- Tile layers load on-demand (only visible tiles)
- Switching layers doesn't reload map instance
- localStorage read is synchronous but fast (< 1ms)

### Accessibility

- Keyboard navigation: Tab to toggle, Enter/Space to activate
- Screen readers: aria-label describes action ("Switch to satellite view")
- Visual: High contrast between button and map background

---

## Story Context XML

```xml
<story id="2.2.5" epic="1.2" points="2" sprint="2">
  <title>Satellite Layer Toggle</title>
  <goal>Allow users to switch between street map and satellite imagery for better environmental issue verification</goal>

  <components>
    <update file="components/map/BaseMap.tsx" reason="Add LayersControl with dual tile layers"/>
    <create file="components/map/LayerToggle.tsx" reason="Mobile-optimized toggle button"/>
    <update file="stores/mapStore.ts" reason="Add selectedLayer state + persistence"/>
  </components>

  <layers>
    <layer id="street" provider="OpenStreetMap" default="true"/>
    <layer id="satellite" provider="Esri World Imagery" default="false"/>
  </layers>

  <state>
    <field name="selectedLayer" type="'street' | 'satellite'" persist="true"/>
  </state>

  <testing>
    <unit component="LayerToggle" coverage="80%"/>
    <e2e scenario="layer-switching"/>
    <e2e scenario="persistence-verification"/>
  </testing>
</story>
```
