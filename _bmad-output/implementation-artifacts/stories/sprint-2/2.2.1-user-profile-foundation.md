# Story 2.2.1: User Profile Page Foundation

**Epic:** 2.2 User Profiles with Tangible Impact  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As an** authenticated user  
**I want** to view and edit my profile  
**So that** I can manage my account and see my contributions

---

## Acceptance Criteria

- [ ] Profile page route: `/profile` (own profile) and `/profile/[username]` (public profiles)
- [ ] Profile displays:
  - Avatar (uploaded or default)
  - Username
  - Bio (optional, 0-200 characters)
  - Join date: "Member since March 2024"
  - Location (optional, city/region)
- [ ] "Edit Profile" button (only on own profile)
- [ ] Avatar upload:
  - Tap avatar to open file picker
  - Image upload with EXIF stripping (reuse uploadPhoto Server Action)
  - Crop to square (1:1 aspect ratio)
  - Max size: 2MB
  - Upload to Supabase Storage: `avatars/{userId}.jpg`
- [ ] Bio editor:
  - Textarea with 200 character limit
  - Character counter
  - Auto-save on blur (debounced)
- [ ] Privacy settings (Phase 2 placeholder):
  - Profile visibility: Public / Private (default: Public)
- [ ] Loading skeleton while fetching profile data
- [ ] Error handling:
  - Profile not found: 404 page
  - Avatar upload failed: "Upload failed. Try again or use default."
  - Bio update failed: "Save failed. Try again."

---

## Technical Implementation

### Profile Page (Own Profile)

```typescript
// app/[locale]/profile/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { ProfileHeader } from '@/components/profile/ProfileHeader';
import { ProfileContent } from '@/components/profile/ProfileContent';

export default async function OwnProfilePage() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  const { data: profile } = await supabase
    .from('users')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    return <div>Profile not found</div>;
  }

  return (
    <div className="container max-w-4xl mx-auto px-4 py-8">
      <ProfileHeader
        profile={profile}
        isOwnProfile={true}
      />

      <ProfileContent
        profile={profile}
        isOwnProfile={true}
      />
    </div>
  );
}
```

### Public Profile Page

```typescript
// app/[locale]/profile/[username]/page.tsx
import { createClient } from '@/lib/supabase/server';
import { notFound, redirect } from 'next/navigation';
import { ProfileHeader } from '@/components/profile/ProfileHeader';
import { ProfileContent } from '@/components/profile/ProfileContent';

export default async function PublicProfilePage({
  params,
}: {
  params: { username: string };
}) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  const { data: profile } = await supabase
    .from('users')
    .select('*')
    .eq('username', params.username)
    .single();

  if (!profile) {
    notFound();
  }

  // Check if profile is private
  if (!profile.profile_public && (!user || user.id !== profile.id)) {
    notFound();
  }

  const isOwnProfile = user?.id === profile.id;

  return (
    <div className="container max-w-4xl mx-auto px-4 py-8">
      <ProfileHeader
        profile={profile}
        isOwnProfile={isOwnProfile}
      />

      <ProfileContent
        profile={profile}
        isOwnProfile={isOwnProfile}
      />
    </div>
  );
}
```

### Profile Header Component

```typescript
// components/profile/ProfileHeader.tsx
'use client';
import { useState } from 'react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Pencil, Camera01 } from '@hugeicons/react';
import { uploadPhoto } from '@/app/actions/uploadPhoto';
import { updateProfile } from '@/app/actions/updateProfile';
import { useToast } from '@/hooks/use-toast';
import { format } from 'date-fns';

interface ProfileHeaderProps {
  profile: {
    id: string;
    username: string;
    avatar_url: string | null;
    bio: string | null;
    location: string | null;
    created_at: string;
  };
  isOwnProfile: boolean;
}

export function ProfileHeader({ profile, isOwnProfile }: ProfileHeaderProps) {
  const [isUploadingAvatar, setIsUploadingAvatar] = useState(false);
  const [avatarUrl, setAvatarUrl] = useState(profile.avatar_url);
  const { toast } = useToast();

  const handleAvatarUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file size (2MB max)
    if (file.size > 2 * 1024 * 1024) {
      toast({
        title: "File too large",
        description: "Avatar must be less than 2MB",
        variant: "destructive",
      });
      return;
    }

    setIsUploadingAvatar(true);

    try {
      const formData = new FormData();
      formData.append('photo', file);

      const result = await uploadPhoto(formData, {
        bucket: 'avatars',
        path: `${profile.id}.jpg`,
        resize: { width: 400, height: 400 },
        quality: 90,
        stripExif: true,
      });

      if (result.success && result.url) {
        await updateProfile(profile.id, { avatar_url: result.url });
        setAvatarUrl(result.url);

        toast({
          title: "Avatar updated",
          description: "Your profile photo has been updated",
        });
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      toast({
        title: "Upload failed",
        description: "Try again or use default",
        variant: "destructive",
      });
    } finally {
      setIsUploadingAvatar(false);
    }
  };

  return (
    <div className="flex flex-col md:flex-row gap-6 items-start mb-8">
      {/* Avatar */}
      <div className="relative">
        <Avatar className="w-32 h-32">
          <AvatarImage src={avatarUrl || undefined} />
          <AvatarFallback className="text-3xl">
            {profile.username.slice(0, 2).toUpperCase()}
          </AvatarFallback>
        </Avatar>

        {isOwnProfile && (
          <label className="absolute bottom-0 right-0 cursor-pointer">
            <input
              type="file"
              accept="image/*"
              className="hidden"
              onChange={handleAvatarUpload}
              disabled={isUploadingAvatar}
            />
            <div className="bg-white border-2 border-gray-200 rounded-full p-2 shadow-sm hover:bg-gray-50">
              <Camera01 size={20} className="text-gray-600" />
            </div>
          </label>
        )}
      </div>

      {/* Profile Info */}
      <div className="flex-1">
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-2xl font-bold">@{profile.username}</h1>
            <p className="text-gray-600">
              Member since {format(new Date(profile.created_at), 'MMMM yyyy')}
            </p>
            {profile.location && (
              <p className="text-sm text-gray-500 mt-1">{profile.location}</p>
            )}
          </div>

          {isOwnProfile && (
            <Button variant="outline" size="sm" asChild>
              <a href="/profile/edit">
                <Pencil size={16} className="mr-2" />
                Edit Profile
              </a>
            </Button>
          )}
        </div>

        {profile.bio && (
          <p className="mt-4 text-gray-700">{profile.bio}</p>
        )}
      </div>
    </div>
  );
}
```

### Profile Edit Page

```typescript
// app/[locale]/profile/edit/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { ProfileEditForm } from '@/components/profile/ProfileEditForm';

export default async function ProfileEditPage() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  const { data: profile } = await supabase
    .from('users')
    .select('*')
    .eq('id', user.id)
    .single();

  return (
    <div className="container max-w-2xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">Edit Profile</h1>

      <ProfileEditForm profile={profile} />
    </div>
  );
}
```

### Profile Edit Form

```typescript
// components/profile/ProfileEditForm.tsx
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { updateProfile } from '@/app/actions/updateProfile';
import { useToast } from '@/hooks/use-toast';

export function ProfileEditForm({ profile }) {
  const [bio, setBio] = useState(profile.bio || '');
  const [location, setLocation] = useState(profile.location || '');
  const [isSaving, setIsSaving] = useState(false);
  const router = useRouter();
  const { toast } = useToast();

  const MAX_BIO_LENGTH = 200;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);

    try {
      const result = await updateProfile(profile.id, {
        bio: bio.trim() || null,
        location: location.trim() || null,
      });

      if (result.success) {
        toast({
          title: "Profile updated",
          description: "Your changes have been saved",
        });
        router.push('/profile');
      } else {
        throw new Error(result.error);
      }
    } catch (error) {
      toast({
        title: "Save failed",
        description: "Try again",
        variant: "destructive",
      });
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div>
        <Label htmlFor="bio">Bio</Label>
        <Textarea
          id="bio"
          value={bio}
          onChange={(e) => setBio(e.target.value.slice(0, MAX_BIO_LENGTH))}
          placeholder="Tell us about yourself..."
          className="mt-1 min-h-24"
        />
        <p className="mt-1 text-sm text-gray-500">
          {bio.length}/{MAX_BIO_LENGTH} characters
        </p>
      </div>

      <div>
        <Label htmlFor="location">Location</Label>
        <Input
          id="location"
          value={location}
          onChange={(e) => setLocation(e.target.value)}
          placeholder="City, Country"
          className="mt-1"
        />
      </div>

      <div className="flex gap-3">
        <Button type="submit" disabled={isSaving}>
          {isSaving ? 'Saving...' : 'Save Changes'}
        </Button>

        <Button
          type="button"
          variant="outline"
          onClick={() => router.push('/profile')}
        >
          Cancel
        </Button>
      </div>
    </form>
  );
}
```

### Server Action

```typescript
// app/actions/updateProfile.ts
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

interface UpdateProfileInput {
  avatar_url?: string;
  bio?: string | null;
  location?: string | null;
}

export async function updateProfile(userId: string, data: UpdateProfileInput) {
  const supabase = await createClient();

  const { error } = await supabase.from('users').update(data).eq('id', userId);

  if (error) {
    console.error('Profile update error:', error);
    return { success: false, error: 'Failed to update profile' };
  }

  revalidatePath('/profile');
  revalidatePath(`/profile/${userId}`);

  return { success: true };
}
```

---

## Tasks & Subtasks

### Task 1: Create Profile Pages

- [ ] Create `/app/[locale]/profile/page.tsx` (own profile)
- [ ] Create `/app/[locale]/profile/[username]/page.tsx` (public)
- [ ] Create `/app/[locale]/profile/edit/page.tsx`
- [ ] Add authentication checks
- [ ] Handle private profiles (404 if private and not owner)

### Task 2: Create Profile Components

- [ ] Create ProfileHeader component
- [ ] Create ProfileContent component (placeholder)
- [ ] Create ProfileEditForm component
- [ ] Add avatar upload functionality
- [ ] Add bio character counter

### Task 3: Implement Avatar Upload

- [ ] Reuse uploadPhoto Server Action
- [ ] Add file size validation (2MB max)
- [ ] Crop to square (400x400px)
- [ ] Upload to avatars bucket
- [ ] Update users.avatar_url

### Task 4: Create Server Actions

- [ ] Create updateProfile Server Action
- [ ] Add revalidation for profile pages
- [ ] Handle errors gracefully

### Task 5: Navigation Integration

- [ ] Add profile link to navigation menu
- [ ] Add dropdown menu with:
  - View Profile
  - Edit Profile
  - Settings
  - Logout

### Task 6: Testing

- [ ] Unit tests for ProfileHeader
- [ ] Unit tests for ProfileEditForm
- [ ] Test avatar upload flow
- [ ] Test bio character limit
- [ ] E2E test: Edit profile and save
- [ ] E2E test: Upload avatar

---

## Dependencies

- **Blocked by:**
  - Story 0.4 (uploadPhoto Server Action) ✅ COMPLETE
  - Story 1.4.1 (Authentication) ✅ COMPLETE
- **Blocks:**
  - Story 2.2.2 (Impact metrics need profile page)
  - Story 2.2.4 (Activity feed on profile)
- **Related:**
  - Story 2.1.7 (Settings link)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Profile pages created (own + public)
- [ ] Edit profile page functional
- [ ] Avatar upload working with EXIF stripping
- [ ] Bio editor with character counter
- [ ] Private profile handling (404)
- [ ] Navigation links working
- [ ] Unit tests written and passing
- [ ] E2E tests verify editing
- [ ] Mobile responsive
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.2.1" epic="2.2" points="3" sprint="2">
  <title>User Profile Page Foundation</title>
  <goal>Create foundation for user profiles with edit capabilities</goal>

  <components>
    <create file="app/[locale]/profile/page.tsx"/>
    <create file="app/[locale]/profile/[username]/page.tsx"/>
    <create file="app/[locale]/profile/edit/page.tsx"/>
    <create file="components/profile/ProfileHeader.tsx"/>
    <create file="components/profile/ProfileEditForm.tsx"/>
    <create file="app/actions/updateProfile.ts"/>
  </components>

  <routes>
    <route path="/profile" type="own-profile" auth="required"/>
    <route path="/profile/[username]" type="public-profile" auth="optional"/>
    <route path="/profile/edit" type="edit-form" auth="required"/>
  </routes>
</story>
```
