# Story 2.2.4: Contribution Timeline & Activity Feed

**Epic:** 2.2 User Profiles with Tangible Impact  
**Story Points:** 4  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user viewing a profile  
**I want** to see a timeline of recent contributions  
**So that** I can understand the user's community engagement

---

## Acceptance Criteria

- [ ] Profile page displays "Recent Activity" section below Impact Metrics
- [ ] Activity feed shows last 20 activities (paginated, load more)
- [ ] Activity types displayed:
  - Issue reported: "Reported a waste issue in Nairobi CBD" + photo thumbnail + timestamp
  - Issue verified: "Verified a drainage issue" + location + timestamp
  - Issue resolved: "A waste issue you reported was resolved!" + photo thumbnail + timestamp
- [ ] Each activity card shows:
  - Icon (camera, checkmark, trophy)
  - Activity description
  - Location (truncated to 30 chars)
  - Relative timestamp ("2 days ago" using date-fns)
  - Photo thumbnail (if applicable)
  - Link to issue details (if applicable)
- [ ] Activity feed design:
  - Timeline connector line (vertical)
  - Chronological order (newest first)
  - Card hover state
  - Click to view issue details
- [ ] **Filter tabs (optional for MVP, can defer):**
  - All / Reports / Verifications / Resolutions
- [ ] Empty state: "No activity yet. Start by reporting an issue!"
- [ ] Loading state: Skeleton cards
- [ ] "Load More" button at bottom (pagination)
- [ ] Mobile responsive (single column, compact cards)

---

## Technical Implementation

### Database Query

```typescript
// lib/profile/getActivityFeed.ts
import { createClient } from '@/lib/supabase/server';

export type ActivityType = 'issue_reported' | 'issue_verified' | 'issue_resolved';

export interface Activity {
  id: string;
  type: ActivityType;
  created_at: string;
  issue_id: string;
  location: string;
  category: 'waste' | 'drainage' | 'pollution';
  photo_url?: string;
  description?: string;
}

export async function getActivityFeed(
  userId: string,
  limit: number = 20,
  offset: number = 0
): Promise<Activity[]> {
  const supabase = await createClient();

  // Query 1: Issues reported by user
  const { data: reportedIssues } = await supabase
    .from('issues')
    .select('id, created_at, location, category, photo_url, description')
    .eq('user_id', userId)
    .order('created_at', { ascending: false })
    .limit(limit);

  const reportedActivities: Activity[] = (reportedIssues || []).map((issue) => ({
    id: `report-${issue.id}`,
    type: 'issue_reported',
    created_at: issue.created_at,
    issue_id: issue.id,
    location: issue.location,
    category: issue.category,
    photo_url: issue.photo_url,
    description: issue.description,
  }));

  // Query 2: Verifications given by user
  const { data: verifications } = await supabase
    .from('verifications')
    .select(
      `
      id,
      created_at,
      issue:issues (
        id,
        location,
        category,
        photo_url
      )
    `
    )
    .eq('verifier_id', userId)
    .order('created_at', { ascending: false })
    .limit(limit);

  const verificationActivities: Activity[] = (verifications || [])
    .filter((v) => v.issue) // Ensure issue exists
    .map((v) => ({
      id: `verify-${v.id}`,
      type: 'issue_verified',
      created_at: v.created_at,
      issue_id: v.issue.id,
      location: v.issue.location,
      category: v.issue.category,
      photo_url: v.issue.photo_url,
    }));

  // Query 3: Resolutions of user's reports
  const { data: resolvedIssues } = await supabase
    .from('issues')
    .select('id, updated_at, location, category, photo_url')
    .eq('user_id', userId)
    .eq('status', 'resolved')
    .order('updated_at', { ascending: false })
    .limit(limit);

  const resolutionActivities: Activity[] = (resolvedIssues || []).map((issue) => ({
    id: `resolved-${issue.id}`,
    type: 'issue_resolved',
    created_at: issue.updated_at,
    issue_id: issue.id,
    location: issue.location,
    category: issue.category,
    photo_url: issue.photo_url,
  }));

  // Combine and sort by timestamp
  const allActivities = [
    ...reportedActivities,
    ...verificationActivities,
    ...resolutionActivities,
  ].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

  // Paginate
  return allActivities.slice(offset, offset + limit);
}
```

### ActivityFeed Component

```typescript
// components/profile/ActivityFeed.tsx
'use client';
import { useState, useEffect } from 'react';
import { formatDistanceToNow } from 'date-fns';
import { Camera01, CheckmarkCircle01, Trophy } from '@hugeicons/react';
import Image from 'next/image';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import type { Activity } from '@/lib/profile/getActivityFeed';

interface ActivityFeedProps {
  userId: string;
  initialActivities: Activity[];
}

export function ActivityFeed({ userId, initialActivities }: ActivityFeedProps) {
  const [activities, setActivities] = useState<Activity[]>(initialActivities);
  const [loading, setLoading] = useState(false);
  const [hasMore, setHasMore] = useState(initialActivities.length === 20);

  const loadMore = async () => {
    setLoading(true);

    try {
      const res = await fetch(
        `/api/users/${userId}/activity?offset=${activities.length}&limit=20`
      );
      const newActivities = await res.json();

      setActivities([...activities, ...newActivities]);
      setHasMore(newActivities.length === 20);
    } catch (error) {
      console.error('Failed to load more activities:', error);
    } finally {
      setLoading(false);
    }
  };

  if (activities.length === 0) {
    return (
      <div className="text-center py-12 bg-gray-50 rounded-lg">
        <h3 className="text-lg font-semibold mb-2">No Activity Yet</h3>
        <p className="text-gray-600 mb-4">
          Start by reporting an issue!
        </p>
        <Button asChild>
          <Link href="/">Report an Issue</Link>
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-bold">Recent Activity</h2>

      <div className="relative">
        {/* Timeline connector line */}
        <div className="absolute left-6 top-0 bottom-0 w-0.5 bg-gray-200" />

        <div className="space-y-4">
          {activities.map((activity) => (
            <ActivityCard key={activity.id} activity={activity} />
          ))}
        </div>
      </div>

      {hasMore && (
        <div className="flex justify-center pt-4">
          <Button
            onClick={loadMore}
            disabled={loading}
            variant="outline"
          >
            {loading ? 'Loading...' : 'Load More'}
          </Button>
        </div>
      )}
    </div>
  );
}

function ActivityCard({ activity }: { activity: Activity }) {
  const getActivityConfig = () => {
    switch (activity.type) {
      case 'issue_reported':
        return {
          icon: <Camera01 size={20} className="text-blue-600" />,
          iconBg: 'bg-blue-50',
          text: `Reported a ${activity.category} issue`,
        };
      case 'issue_verified':
        return {
          icon: <CheckmarkCircle01 size={20} className="text-green-600" />,
          iconBg: 'bg-green-50',
          text: `Verified a ${activity.category} issue`,
        };
      case 'issue_resolved':
        return {
          icon: <Trophy size={20} className="text-orange-600" />,
          iconBg: 'bg-orange-50',
          text: `A ${activity.category} issue you reported was resolved!`,
        };
    }
  };

  const config = getActivityConfig();
  const truncatedLocation =
    activity.location.length > 30
      ? activity.location.substring(0, 30) + '...'
      : activity.location;

  return (
    <Link
      href={`/issues/${activity.issue_id}`}
      className="relative flex gap-4 p-4 rounded-lg border hover:bg-gray-50 transition-colors"
    >
      {/* Icon */}
      <div className={`flex-shrink-0 w-12 h-12 rounded-full ${config.iconBg} flex items-center justify-center z-10`}>
        {config.icon}
      </div>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <p className="font-medium text-gray-900">{config.text}</p>
        <p className="text-sm text-gray-600 mt-1">{truncatedLocation}</p>
        <p className="text-xs text-gray-500 mt-1">
          {formatDistanceToNow(new Date(activity.created_at), { addSuffix: true })}
        </p>
      </div>

      {/* Photo thumbnail */}
      {activity.photo_url && (
        <div className="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden">
          <Image
            src={activity.photo_url}
            alt="Activity thumbnail"
            width={64}
            height={64}
            className="object-cover w-full h-full"
          />
        </div>
      )}
    </Link>
  );
}

function ActivityFeedSkeleton() {
  return (
    <div className="space-y-6">
      <div className="h-8 w-48 bg-gray-200 rounded animate-pulse" />
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex gap-4 p-4 rounded-lg border">
            <div className="w-12 h-12 bg-gray-200 rounded-full animate-pulse" />
            <div className="flex-1 space-y-2">
              <div className="h-4 w-3/4 bg-gray-200 rounded animate-pulse" />
              <div className="h-3 w-1/2 bg-gray-200 rounded animate-pulse" />
              <div className="h-3 w-1/4 bg-gray-200 rounded animate-pulse" />
            </div>
            <div className="w-16 h-16 bg-gray-200 rounded-lg animate-pulse" />
          </div>
        ))}
      </div>
    </div>
  );
}
```

### API Route

```typescript
// app/api/users/[id]/activity/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getActivityFeed } from '@/lib/profile/getActivityFeed';

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const searchParams = request.nextUrl.searchParams;
  const offset = parseInt(searchParams.get('offset') || '0');
  const limit = parseInt(searchParams.get('limit') || '20');

  try {
    const activities = await getActivityFeed(params.id, limit, offset);
    return NextResponse.json(activities);
  } catch (error) {
    console.error('Activity feed error:', error);
    return NextResponse.json({ error: 'Failed to fetch activity feed' }, { status: 500 });
  }
}
```

### Integration into Profile Page

```typescript
// app/[locale]/profile/[username]/page.tsx (updated)
import { getActivityFeed } from '@/lib/profile/getActivityFeed';
import { ActivityFeed } from '@/components/profile/ActivityFeed';

export default async function ProfilePage({ params }: { params: { username: string } }) {
  // ... existing profile loading ...

  const initialActivities = await getActivityFeed(user.id, 20, 0);

  return (
    <div className="container max-w-4xl py-8 space-y-8">
      <ProfileHeader user={user} />
      <ImpactMetrics userId={user.id} />
      <ActivityFeed userId={user.id} initialActivities={initialActivities} />
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create Activity Feed Query

- [ ] Create `/lib/profile/getActivityFeed.ts`
- [ ] Query reported issues
- [ ] Query verifications given
- [ ] Query resolved issues
- [ ] Combine and sort by timestamp
- [ ] Add pagination logic

### Task 2: Create ActivityFeed Component

- [ ] Create `/components/profile/ActivityFeed.tsx`
- [ ] Display timeline with connector line
- [ ] Render ActivityCard for each item
- [ ] Add "Load More" button
- [ ] Add empty state
- [ ] Add loading skeleton

### Task 3: Create API Route

- [ ] Create `/app/api/users/[id]/activity/route.ts`
- [ ] Handle offset/limit query params
- [ ] Return JSON response

### Task 4: Integrate into Profile Page

- [ ] Load initial 20 activities server-side
- [ ] Pass to ActivityFeed component
- [ ] Position below ImpactMetrics

### Task 5: Testing

- [ ] Test activity query
- [ ] Test pagination
- [ ] Test empty state
- [ ] E2E test: View activity feed

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (Verifications data)
  - Story 2.2.1 (Profile page)
- **Blocks:** None

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Activity feed query functional
- [ ] ActivityFeed component renders correctly
- [ ] Timeline design with connector line
- [ ] Pagination working
- [ ] Empty state displays
- [ ] API route working
- [ ] Mobile responsive
- [ ] Unit tests passing
- [ ] E2E tests verify display
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.2.4" epic="2.2" points="4" sprint="2">
  <title>Contribution Timeline & Activity Feed</title>
  <goal>Display user's recent community contributions in chronological order</goal>

  <activity-types>
    <type name="issue_reported" icon="camera" color="blue"/>
    <type name="issue_verified" icon="checkmark" color="green"/>
    <type name="issue_resolved" icon="trophy" color="orange"/>
  </activity-types>

  <pagination>
    <initial-load>20</initial-load>
    <load-more>20</load-more>
  </pagination>
</story>
```
