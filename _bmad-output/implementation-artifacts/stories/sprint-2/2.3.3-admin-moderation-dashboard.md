# Story 2.3.3: Admin Moderation Dashboard

**Epic:** 2.3 Community-Driven Content Flagging  
**Story Points:** 2  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As an** administrator  
**I want** a dashboard to review flagged content  
**So that** I can moderate the community and unhide legitimate content

---

## Acceptance Criteria

- [ ] **MVP Approach:** Use Supabase Table Editor for moderation (no custom UI in Sprint 2)
  - Admins access Supabase Dashboard → Table Editor → `flags` table
  - Filter by `status = 'pending'`
  - View flag reason, comment, target_type, target_id
  - Click target_id to view content in new tab
  - Update flag `status` to 'reviewed' or 'dismissed'
  - Manually update `issues.status` to unhide content
- [ ] **Future (Phase 2):** Custom moderation dashboard in app with:
  - Flagged content queue
  - Flag count badge
  - Quick actions: Approve/Dismiss/Ban User
  - Flag analytics (Story 2.3.4)
- [ ] **Admin role definition:**
  - Store admin role in `auth.users` metadata (or separate `user_roles` table)
  - RLS policy: Only admins can SELECT from flags table
  - Admin access to hidden issues (Story 2.3.2)
- [ ] **Unhiding content:**
  - Admin updates `issues.status` from 'flagged_hidden' to 'active' (or previous status)
  - Content reappears on map/lists
  - Flags remain in database (status = 'dismissed')
- [ ] **Banning users (optional for MVP):**
  - Future: Admin can ban users via `users.is_banned` flag
  - Banned users cannot create reports, verifications, flags

---

## Technical Implementation

### Admin Role Setup

```sql
-- migrations/009_admin_role.sql

-- Option 1: Use Supabase Auth metadata
-- Set admin role via Supabase Dashboard → Authentication → Users → Edit user → App metadata
-- { "role": "admin" }

-- Option 2: Separate user_roles table (more scalable)
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role TEXT NOT NULL, -- 'admin', 'moderator', 'user'
  granted_at TIMESTAMPTZ DEFAULT NOW(),
  granted_by UUID REFERENCES auth.users(id),

  UNIQUE(user_id, role)
);

-- RLS Policies
ALTER TABLE user_roles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own roles"
  ON user_roles FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can manage roles"
  ON user_roles FOR ALL
  USING (
    auth.uid() IN (
      SELECT user_id FROM user_roles WHERE role = 'admin'
    )
  );

-- Helper function to check if user is admin
CREATE OR REPLACE FUNCTION is_admin(uid UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_roles
    WHERE user_id = uid AND role = 'admin'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Update flags RLS policy
DROP POLICY IF EXISTS "Users can read own flags" ON flags;

CREATE POLICY "Users can read own flags"
  ON flags FOR SELECT
  USING (
    auth.uid() = user_id OR is_admin(auth.uid())
  );

-- Update issues RLS policy (allow admins to see hidden content)
CREATE POLICY "Admins can view all issues"
  ON issues FOR SELECT
  USING (is_admin(auth.uid()));
```

### Admin Check Utility

```typescript
// lib/auth/isAdmin.ts
import { createClient } from '@/lib/supabase/server';

export async function isAdmin(userId?: string): Promise<boolean> {
  const supabase = await createClient();

  const uid = userId || (await supabase.auth.getUser()).data.user?.id;
  if (!uid) return false;

  const { data } = await supabase.rpc('is_admin', { uid });

  return data || false;
}
```

### Moderation Instructions (Documentation)

````markdown
<!-- docs/admin-moderation-guide.md -->

# Admin Moderation Guide

## Accessing Flagged Content

**Option 1: Supabase Table Editor (MVP)**

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Navigate to **Table Editor** → `flags`
4. Filter by `status = 'pending'`
5. Review each flag:
   - `target_type`: 'issue' or 'verification'
   - `target_id`: UUID of flagged content
   - `reason`: Flag reason (spam, offensive, etc.)
   - `comment`: Additional context from flagger
6. Click `target_id` → Copy UUID
7. Visit `/issues/{target_id}` to view content
8. Determine action:
   - **Legitimate flag:** Keep content hidden
     - Update `flags.status` to 'reviewed'
   - **False flag:** Unhide content
     - Update `issues.status` to 'active' (or 'verified')
     - Update `flags.status` to 'dismissed'

**Option 2: Direct Database Query (Advanced)**

```sql
-- View all pending flags with issue details
SELECT
  f.id AS flag_id,
  f.reason,
  f.comment,
  f.created_at,
  i.id AS issue_id,
  i.location,
  i.category,
  i.status,
  i.photo_url
FROM flags f
JOIN issues i ON f.target_id = i.id
WHERE f.status = 'pending'
  AND f.target_type = 'issue'
ORDER BY f.created_at DESC;
```
````

## Unhiding Content

```sql
-- Unhide an issue (restore to active status)
UPDATE issues
SET status = 'active' -- or 'verified' if it had verifications
WHERE id = '{issue_id}';

-- Mark flag as dismissed
UPDATE flags
SET status = 'dismissed', reviewed_at = NOW(), reviewed_by = auth.uid()
WHERE id = '{flag_id}';
```

## Banning Users (Future)

```sql
-- Ban a user
UPDATE auth.users
SET banned_until = '2024-12-31 23:59:59'
WHERE id = '{user_id}';
```

## Monitoring Flag Trends

See [Story 2.3.4 - Flag Analytics](#story-234) for spam rate monitoring queries.

````

### Future: Custom Moderation Dashboard (Deferred to Phase 2)

```typescript
// app/admin/moderation/page.tsx (FUTURE)
import { isAdmin } from '@/lib/auth/isAdmin';
import { redirect } from 'next/navigation';

export default async function ModerationDashboard() {
  const admin = await isAdmin();

  if (!admin) {
    redirect('/');
  }

  // Load pending flags
  const supabase = await createClient();
  const { data: flags } = await supabase
    .from('flags')
    .select(`
      *,
      issue:issues(*),
      verification:verifications(*)
    `)
    .eq('status', 'pending')
    .order('created_at', { ascending: false });

  return (
    <div className="container max-w-6xl py-8">
      <h1 className="text-2xl font-bold mb-6">Moderation Dashboard</h1>

      <div className="space-y-4">
        {flags.map((flag) => (
          <FlagReviewCard key={flag.id} flag={flag} />
        ))}
      </div>
    </div>
  );
}
````

---

## Tasks & Subtasks

### Task 1: Define Admin Role

- [ ] Decide: Auth metadata OR user_roles table
- [ ] Create migration if using user_roles table
- [ ] Create `is_admin()` helper function
- [ ] Update RLS policies

### Task 2: Create Admin Check Utility

- [ ] Create `/lib/auth/isAdmin.ts`
- [ ] Test admin detection

### Task 3: Document Moderation Process

- [ ] Create `/docs/admin-moderation-guide.md`
- [ ] Write step-by-step instructions for Supabase Table Editor
- [ ] Include SQL queries for common tasks

### Task 4: Test Admin Access

- [ ] Test admin can view hidden issues
- [ ] Test admin can unhide issues
- [ ] Test non-admin cannot access flags table

### Task 5: (Optional) Create Custom Dashboard

- [ ] Defer to Phase 2 unless time permits
- [ ] Create `/app/admin/moderation/page.tsx`
- [ ] Create FlagReviewCard component

---

## Dependencies

- **Blocked by:**
  - Story 2.3.1 (Flags table)
  - Story 2.3.2 (Hidden content logic)
- **Blocks:** None

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Admin role defined (metadata or table)
- [ ] `is_admin()` helper function created
- [ ] RLS policies allow admin access to flags
- [ ] Moderation guide documented
- [ ] Admins can view hidden issues
- [ ] Admins can unhide content via Supabase Table Editor
- [ ] Tested with admin and non-admin users
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.3.3" epic="2.3" points="2" sprint="2">
  <title>Admin Moderation Dashboard</title>
  <goal>Enable admins to review and moderate flagged content</goal>

  <mvp-approach>
    <tool>Supabase Table Editor</tool>
    <workflow>Filter flags → View content → Update status</workflow>
  </mvp-approach>

  <future-enhancements>
    <custom-dashboard>In-app moderation UI</custom-dashboard>
    <quick-actions>Approve/Dismiss/Ban User</quick-actions>
    <analytics>Flag trends and spam rate</analytics>
  </future-enhancements>
</story>
```
