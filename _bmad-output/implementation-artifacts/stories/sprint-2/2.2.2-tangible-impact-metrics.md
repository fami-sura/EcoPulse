# Story 2.2.2: Tangible Impact Metrics (NO Gamification Points)

**Epic:** 2.2 User Profiles with Tangible Impact  
**Story Points:** 7 (COMPLEX - Hybrid metrics calculation)  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to see my verified tangible impact on the environment  
**So that** I understand my real contribution (not abstract points)

---

## Acceptance Criteria

- [ ] **CRITICAL:** NO points/badges/leaderboards displayed anywhere in UI (per stakeholder directive)
- [ ] **YES** "You saved 15 kg of waste from landfills!" messages
- [ ] Profile displays verified impact metrics (hybrid Sprint 2 + Sprint 3 data):
  - **Issues Reported & Verified:** "Your 12 verified reports identified ~180 kg of waste" (Sprint 2: estimated impact, clearly labeled)
  - **Community Cleanups Participated:** "You helped remove 45 kg of waste at 3 cleanups!" (Sprint 3: actual measured impact from Action Cards)
  - **Drains Cleared:** "You contributed to clearing 3 drainage blockages!" (count of verified drainage resolutions user participated in)
  - **Volunteer Hours:** "You volunteered 8 hours at Action Card events!" (Sprint 3: tracked from Action Card sign-ins)
- [ ] Impact metrics section header: "Your Environmental Impact"
- [ ] **Sprint 2 UX:** Community Cleanups and Volunteer Hours show "Join Action Cards to start cleaning up!" CTA (data available in Sprint 3)
- [ ] **Labeling clarity:** Estimated metrics clearly marked with "~" symbol and "estimated" label to maintain NGO/funder credibility
- [ ] Each metric includes:
  - Icon (trash can, drainage, cleanup, clock)
  - Value with unit (kg, count, hours)
  - Celebratory message (NOT competitive language)
- [ ] **Calculation logic (hybrid Sprint 2 + Sprint 3):**
  - **Sprint 2 - Estimated Waste (reporting impact):**
    - Count: `SELECT COUNT(*) FROM issues WHERE user_id = uid AND category = 'waste' AND verifications_count >= 2`
    - Estimated kg: `count × 15kg` (clearly labeled as ESTIMATE)
    - Display: "Your 12 verified reports identified ~180 kg of waste"
  - **Sprint 3 - Actual Waste (cleanup impact):**
    - Count: `SELECT COUNT(*) FROM action_card_participants WHERE user_id = uid AND action_card.status = 'completed' AND category = 'waste'`
    - Measured kg: `SUM(action_card.waste_removed_kg)` (actual measured from Action Card completion)
    - Display: "You helped remove 45 kg of waste at 3 cleanups!"
  - Drains cleared: Count of drainage issues user VERIFIED (not just reported) that reached 'resolved' status
  - Volunteer hours: `SUM(action_card.duration_hours)` from completed Action Cards user participated in (Sprint 3)
- [ ] **Verification requirement:** Only count VERIFIED data (verifications_count >= 2 for reports, status = 'completed' for Action Cards)
- [ ] Impact timeline: Monthly breakdown chart (optional for MVP, can defer to Phase 2)
- [ ] **Messaging tone:** Community-focused, NOT competitive
  - ✅ "You saved 15 kg of waste from landfills!"
  - ❌ "You ranked #3 in waste collection!"
- [ ] Empty state: "Start contributing to see your environmental impact!"

---

## Technical Implementation

### PostgreSQL Function for Impact Metrics

```sql
-- migrations/005_user_impact_function.sql

CREATE OR REPLACE FUNCTION get_user_impact(uid UUID)
RETURNS JSON AS $$
DECLARE
  result JSON;
BEGIN
  SELECT json_build_object(
    -- Sprint 2: Estimated impact from verified reports
    'verified_reports_count', (
      SELECT COUNT(*) FROM issues
      WHERE user_id = uid AND verifications_count >= 2
    ),
    'estimated_waste_kg', (
      SELECT COUNT(*) * 15 -- Estimated 15kg per verified waste report
      FROM issues
      WHERE user_id = uid
        AND category = 'waste'
        AND verifications_count >= 2
    ),

    -- Sprint 3: Actual impact from Action Card participation
    -- These will return 0 in Sprint 2 (tables don't exist yet)
    'actual_waste_removed_kg', COALESCE((
      SELECT SUM(ac.waste_removed_kg)
      FROM action_card_participants acp
      JOIN action_cards ac ON acp.action_card_id = ac.id
      WHERE acp.user_id = uid
        AND ac.status = 'completed'
        AND ac.category = 'waste'
    ), 0),

    'cleanups_participated', COALESCE((
      SELECT COUNT(DISTINCT acp.action_card_id)
      FROM action_card_participants acp
      JOIN action_cards ac ON acp.action_card_id = ac.id
      WHERE acp.user_id = uid AND ac.status = 'completed'
    ), 0),

    'drains_cleared', (
      SELECT COUNT(DISTINCT i.id)
      FROM issues i
      WHERE i.status = 'resolved'
        AND i.category = 'drainage'
        AND EXISTS (
          SELECT 1 FROM verifications v
          WHERE v.issue_id = i.id AND v.verifier_id = uid
        )
    ),

    'volunteer_hours', COALESCE((
      SELECT SUM(ac.duration_hours)
      FROM action_card_participants acp
      JOIN action_cards ac ON acp.action_card_id = ac.id
      WHERE acp.user_id = uid AND ac.status = 'completed'
    ), 0)
  ) INTO result;

  RETURN result;
END;
$$ LANGUAGE plpgsql;
```

### Impact Metrics Component

```typescript
// components/profile/ImpactMetrics.tsx
'use client';
import { useEffect, useState } from 'react';
import { Trash02, Droplet, UsersProfiles, Clock } from '@hugeicons/react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

interface ImpactData {
  verified_reports_count: number;
  estimated_waste_kg: number;
  actual_waste_removed_kg: number;
  cleanups_participated: number;
  drains_cleared: number;
  volunteer_hours: number;
}

interface ImpactMetricsProps {
  userId: string;
}

export function ImpactMetrics({ userId }: ImpactMetricsProps) {
  const [impact, setImpact] = useState<ImpactData | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchImpact();
  }, [userId]);

  const fetchImpact = async () => {
    try {
      const res = await fetch(`/api/users/${userId}/impact`);
      const data = await res.json();
      setImpact(data);
    } catch (error) {
      console.error('Failed to fetch impact:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <ImpactMetricsSkeleton />;
  }

  if (!impact) {
    return <div>Unable to load impact metrics</div>;
  }

  const hasNoImpact =
    impact.verified_reports_count === 0 &&
    impact.cleanups_participated === 0 &&
    impact.drains_cleared === 0;

  if (hasNoImpact) {
    return (
      <div className="text-center py-12 bg-gray-50 rounded-lg">
        <h3 className="text-lg font-semibold mb-2">Your Environmental Impact</h3>
        <p className="text-gray-600 mb-4">
          Start contributing to see your environmental impact!
        </p>
        <Button asChild>
          <Link href="/">Report an Issue</Link>
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <h2 className="text-xl font-bold">Your Environmental Impact</h2>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Sprint 2: Estimated Waste from Reports */}
        {impact.verified_reports_count > 0 && (
          <ImpactCard
            icon={<Trash02 size={32} />}
            value={`~${impact.estimated_waste_kg} kg`}
            label="Waste Identified (estimated)"
            message={`Your ${impact.verified_reports_count} verified reports identified waste in your community!`}
            color="green"
          />
        )}

        {/* Sprint 3: Actual Waste Removed (shows CTA in Sprint 2) */}
        {impact.actual_waste_removed_kg > 0 ? (
          <ImpactCard
            icon={<Trash02 size={32} />}
            value={`${impact.actual_waste_removed_kg} kg`}
            label="Waste Removed (measured)"
            message={`You helped remove ${impact.actual_waste_removed_kg} kg of waste at ${impact.cleanups_participated} cleanups!`}
            color="green"
          />
        ) : (
          <ImpactCardCTA
            icon={<UsersProfiles size={32} />}
            label="Community Cleanups"
            message="Join Action Cards to start cleaning up!"
            linkText="Browse Action Cards"
            linkHref="/action-cards"
            color="blue"
          />
        )}

        {/* Drains Cleared */}
        {impact.drains_cleared > 0 && (
          <ImpactCard
            icon={<Droplet size={32} />}
            value={impact.drains_cleared.toString()}
            label="Drains Cleared"
            message={`You contributed to clearing ${impact.drains_cleared} drainage blockage${impact.drains_cleared > 1 ? 's' : ''}!`}
            color="blue"
          />
        )}

        {/* Sprint 3: Volunteer Hours (shows CTA in Sprint 2) */}
        {impact.volunteer_hours > 0 ? (
          <ImpactCard
            icon={<Clock size={32} />}
            value={`${impact.volunteer_hours} hours`}
            label="Volunteer Time"
            message={`You volunteered ${impact.volunteer_hours} hours at Action Card events!`}
            color="purple"
          />
        ) : (
          <ImpactCardCTA
            icon={<Clock size={32} />}
            label="Volunteer Hours"
            message="Join Action Cards to track your volunteer time!"
            linkText="Learn About Action Cards"
            linkHref="/action-cards"
            color="purple"
          />
        )}
      </div>
    </div>
  );
}

interface ImpactCardProps {
  icon: React.ReactNode;
  value: string;
  label: string;
  message: string;
  color: 'green' | 'blue' | 'purple' | 'orange';
}

function ImpactCard({ icon, value, label, message, color }: ImpactCardProps) {
  const colorClasses = {
    green: 'bg-green-50 text-green-600 border-green-200',
    blue: 'bg-blue-50 text-blue-600 border-blue-200',
    purple: 'bg-purple-50 text-purple-600 border-purple-200',
    orange: 'bg-orange-50 text-orange-600 border-orange-200',
  };

  return (
    <div className="border rounded-lg p-6 space-y-3">
      <div className={`inline-flex p-3 rounded-lg ${colorClasses[color]}`}>
        {icon}
      </div>

      <div>
        <div className="text-3xl font-bold">{value}</div>
        <div className="text-sm font-medium text-gray-600">{label}</div>
      </div>

      <p className="text-sm text-gray-700">{message}</p>
    </div>
  );
}

function ImpactCardCTA({ icon, label, message, linkText, linkHref, color }) {
  const colorClasses = {
    green: 'bg-green-50 text-green-600 border-green-200',
    blue: 'bg-blue-50 text-blue-600 border-blue-200',
    purple: 'bg-purple-50 text-purple-600 border-purple-200',
    orange: 'bg-orange-50 text-orange-600 border-orange-200',
  };

  return (
    <div className="border border-dashed rounded-lg p-6 space-y-3 bg-gray-50">
      <div className={`inline-flex p-3 rounded-lg ${colorClasses[color]} opacity-50`}>
        {icon}
      </div>

      <div>
        <div className="text-sm font-medium text-gray-600">{label}</div>
        <p className="text-sm text-gray-500 mt-1">{message}</p>
      </div>

      <Button variant="outline" size="sm" asChild>
        <Link href={linkHref}>{linkText}</Link>
      </Button>
    </div>
  );
}

function ImpactMetricsSkeleton() {
  return (
    <div className="space-y-6">
      <div className="h-8 w-64 bg-gray-200 rounded animate-pulse" />
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {[...Array(4)].map((_, i) => (
          <div key={i} className="border rounded-lg p-6 space-y-3">
            <div className="h-16 w-16 bg-gray-200 rounded-lg animate-pulse" />
            <div className="h-10 w-32 bg-gray-200 rounded animate-pulse" />
            <div className="h-4 w-full bg-gray-200 rounded animate-pulse" />
          </div>
        ))}
      </div>
    </div>
  );
}
```

### API Route

```typescript
// app/api/users/[id]/impact/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = await createClient();

  try {
    const { data, error } = await supabase.rpc('get_user_impact', {
      uid: params.id,
    });

    if (error) throw error;

    return NextResponse.json(data);
  } catch (error) {
    console.error('Impact metrics error:', error);
    return NextResponse.json({ error: 'Failed to fetch impact metrics' }, { status: 500 });
  }
}
```

---

## Tasks & Subtasks

### Task 1: Create PostgreSQL Function

- [ ] Create migration: `005_user_impact_function.sql`
- [ ] Define `get_user_impact(uid)` function
- [ ] Calculate estimated waste (count × 15kg)
- [ ] Add placeholders for Sprint 3 metrics (return 0)
- [ ] Test function with sample data

### Task 2: Create ImpactMetrics Component

- [ ] Create `/components/profile/ImpactMetrics.tsx`
- [ ] Display 4 impact cards
- [ ] Add CTA cards for Sprint 3 features
- [ ] Add empty state
- [ ] Add loading skeleton

### Task 3: Create API Route

- [ ] Create `/app/api/users/[id]/impact/route.ts`
- [ ] Call PostgreSQL function
- [ ] Return JSON response
- [ ] Handle errors

### Task 4: Integrate into Profile Page

- [ ] Add ImpactMetrics to ProfileContent
- [ ] Position below profile header
- [ ] Pass userId prop

### Task 5: Messaging & Labeling

- [ ] Add "~" symbol for estimated metrics
- [ ] Add "(estimated)" label for clarity
- [ ] Use community-focused language (not competitive)
- [ ] Add celebratory messages (not points)

### Task 6: Testing

- [ ] Unit tests for impact calculation
- [ ] Test estimated waste formula (count × 15kg)
- [ ] Test drains cleared logic
- [ ] Test empty state
- [ ] E2E test: View impact on profile

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (Verifications data)
  - Story 2.2.1 (Profile page)
- **Blocks:** None
- **Related:**
  - Sprint 3 Action Cards (provides actual measured data)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] PostgreSQL function created
- [ ] ImpactMetrics component functional
- [ ] NO points/badges/leaderboards anywhere
- [ ] Estimated metrics clearly labeled
- [ ] Community-focused messaging
- [ ] CTA cards for Sprint 3 features
- [ ] Empty state displays
- [ ] API route working
- [ ] Unit tests written and passing
- [ ] E2E tests verify display
- [ ] Mobile responsive
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.2.2" epic="2.2" points="7" sprint="2">
  <title>Tangible Impact Metrics (NO Gamification Points)</title>
  <goal>Display verified environmental impact with tangible metrics</goal>

  <critical-requirement>
    <no-gamification>NO points, badges, or leaderboards</no-gamification>
    <tangible-impact>Show real-world impact (kg waste, drains, hours)</tangible-impact>
    <clear-labeling>Estimated metrics marked with "~" symbol</clear-labeling>
  </critical-requirement>

  <metrics>
    <metric type="sprint-2" name="estimated_waste" formula="verified_reports × 15kg" label="estimated"/>
    <metric type="sprint-3" name="actual_waste" source="action_cards.waste_removed_kg" label="measured"/>
    <metric type="both" name="drains_cleared" formula="COUNT(verified_resolutions)"/>
    <metric type="sprint-3" name="volunteer_hours" source="action_cards.duration_hours"/>
  </metrics>
</story>
```
