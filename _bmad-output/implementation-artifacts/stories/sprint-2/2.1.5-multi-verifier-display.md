# Story 2.1.5: Multi-Verifier Display & Photo Gallery

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user viewing an issue  
**I want** to see all verification photos and notes  
**So that** I can understand community consensus on the issue

---

## Acceptance Criteria

- [ ] Issue detail page shows verification section below report details
- [ ] Display verification count badge: "2 verifications" with green checkmark icon
- [ ] List all verifiers with usernames and timestamps:
  - "Verified by @ola_lagos 2 hours ago"
  - "Verified by @chidi_abuja yesterday"
- [ ] Display verification photos in horizontal gallery (swipeable on mobile)
- [ ] Each verification card shows:
  - Verifier username (linked to profile)
  - Verification photo (tappable to expand full-screen)
  - Verification note (if provided)
  - Timestamp (relative: "2 hours ago", "yesterday")
  - Location accuracy indicator if >100m from report location
- [ ] Photo gallery:
  - Horizontal scroll on mobile (snap to each photo)
  - Grid view on desktop (2-3 photos per row)
  - Lightbox/modal on tap (full-screen photo view)
- [ ] "Verify This Issue" button positioned above verification list if not yet verified by user
- [ ] Empty state if no verifications: "No verifications yet. Be the first to verify!"
- [ ] Loading skeleton while fetching verifications
- [ ] Error handling: "Unable to load verifications. Refresh page."

---

## Technical Implementation

### Components to Create

```typescript
// components/verification/VerificationList.tsx
'use client';
import { useEffect, useState } from 'react';
import { CheckCircle } from '@hugeicons/react';
import { formatDistanceToNow } from 'date-fns';
import { VerificationCard } from './VerificationCard';
import { PhotoLightbox } from './PhotoLightbox';

interface Verification {
  id: string;
  photo_url: string;
  note: string | null;
  lat: number;
  lng: number;
  created_at: string;
  verifier: {
    username: string;
    avatar_url: string | null;
  };
}

interface VerificationListProps {
  issueId: string;
  issueLocation: { lat: number; lng: number };
}

export function VerificationList({ issueId, issueLocation }: VerificationListProps) {
  const [verifications, setVerifications] = useState<Verification[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [lightboxPhoto, setLightboxPhoto] = useState<string | null>(null);

  useEffect(() => {
    fetchVerifications();
  }, [issueId]);

  const fetchVerifications = async () => {
    try {
      const res = await fetch(`/api/issues/${issueId}/verifications`);
      const data = await res.json();

      if (!res.ok) throw new Error(data.error);

      setVerifications(data.verifications);
    } catch (err) {
      setError('Unable to load verifications. Refresh page.');
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <VerificationListSkeleton />;
  }

  if (error) {
    return (
      <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
        <p className="text-red-600 text-sm">{error}</p>
      </div>
    );
  }

  if (verifications.length === 0) {
    return (
      <div className="text-center py-8 text-gray-500">
        <CheckCircle size={48} className="mx-auto mb-2 text-gray-300" />
        <p>No verifications yet. Be the first to verify!</p>
      </div>
    );
  }

  return (
    <div className="space-y-4">
      {/* Verification Count Badge */}
      <div className="flex items-center gap-2 text-green-600 font-medium">
        <CheckCircle size={20} />
        <span>{verifications.length} verification{verifications.length > 1 ? 's' : ''}</span>
      </div>

      {/* Verification Cards */}
      <div className="space-y-4">
        {verifications.map(verification => (
          <VerificationCard
            key={verification.id}
            verification={verification}
            issueLocation={issueLocation}
            onPhotoClick={(url) => setLightboxPhoto(url)}
          />
        ))}
      </div>

      {/* Photo Lightbox */}
      {lightboxPhoto && (
        <PhotoLightbox
          photoUrl={lightboxPhoto}
          onClose={() => setLightboxPhoto(null)}
        />
      )}
    </div>
  );
}
```

```typescript
// components/verification/VerificationCard.tsx
import Link from 'next/link';
import Image from 'next/image';
import { formatDistanceToNow } from 'date-fns';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { MapPin } from '@hugeicons/react';

interface VerificationCardProps {
  verification: Verification;
  issueLocation: { lat: number; lng: number };
  onPhotoClick: (url: string) => void;
}

export function VerificationCard({
  verification,
  issueLocation,
  onPhotoClick
}: VerificationCardProps) {
  const distance = calculateDistance(
    verification.lat,
    verification.lng,
    issueLocation.lat,
    issueLocation.lng
  );

  const isDistant = distance > 100; // More than 100m from issue

  return (
    <div className="border rounded-lg p-4 space-y-3">
      {/* Verifier Info */}
      <div className="flex items-center gap-3">
        <Avatar className="h-10 w-10">
          <AvatarImage src={verification.verifier.avatar_url || undefined} />
          <AvatarFallback>
            {verification.verifier.username.slice(0, 2).toUpperCase()}
          </AvatarFallback>
        </Avatar>

        <div className="flex-1">
          <div className="flex items-center gap-2">
            <Link
              href={`/profile/${verification.verifier.username}`}
              className="font-medium hover:underline"
            >
              @{verification.verifier.username}
            </Link>
            <span className="text-sm text-gray-500">
              {formatDistanceToNow(new Date(verification.created_at), {
                addSuffix: true
              })}
            </span>
          </div>

          {isDistant && (
            <div className="flex items-center gap-1 text-xs text-amber-600">
              <MapPin size={12} />
              <span>{Math.round(distance)}m from issue location</span>
            </div>
          )}
        </div>
      </div>

      {/* Verification Photo */}
      <div
        className="relative aspect-video rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition-opacity"
        onClick={() => onPhotoClick(verification.photo_url)}
      >
        <Image
          src={verification.photo_url}
          alt="Verification photo"
          fill
          className="object-cover"
        />
      </div>

      {/* Verification Note */}
      {verification.note && (
        <p className="text-sm text-gray-700">
          "{verification.note}"
        </p>
      )}
    </div>
  );
}

function calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {
  // Haversine formula (same as Story 2.1.3)
  const R = 6371e3;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lng2 - lng1) * Math.PI / 180;

  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

  return R * c;
}
```

```typescript
// components/verification/PhotoLightbox.tsx
'use client';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import Image from 'next/image';
import { X } from '@hugeicons/react';

interface PhotoLightboxProps {
  photoUrl: string;
  onClose: () => void;
}

export function PhotoLightbox({ photoUrl, onClose }: PhotoLightboxProps) {
  return (
    <Dialog open={true} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl w-full p-0">
        <button
          onClick={onClose}
          className="absolute top-4 right-4 z-10 p-2 bg-black/50 rounded-full text-white hover:bg-black/70"
          aria-label="Close"
        >
          <X size={24} />
        </button>

        <div className="relative w-full aspect-video">
          <Image
            src={photoUrl}
            alt="Verification photo full size"
            fill
            className="object-contain"
          />
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

### API Route

```typescript
// app/api/issues/[id]/verifications/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';

export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const supabase = await createClient();

  const { data: verifications, error } = await supabase
    .from('verifications')
    .select(
      `
      id,
      photo_url,
      note,
      lat,
      lng,
      created_at,
      verifier:users!verifier_id (
        username,
        avatar_url
      )
    `
    )
    .eq('issue_id', params.id)
    .order('created_at', { ascending: false });

  if (error) {
    return NextResponse.json({ error: 'Failed to fetch verifications' }, { status: 500 });
  }

  return NextResponse.json({ verifications });
}
```

---

## Tasks & Subtasks

### Task 1: Create VerificationList Component

- [ ] Create `/components/verification/VerificationList.tsx`
- [ ] Fetch verifications from API route
- [ ] Display verification count badge
- [ ] Handle loading and error states
- [ ] Show empty state if no verifications

### Task 2: Create VerificationCard Component

- [ ] Create `/components/verification/VerificationCard.tsx`
- [ ] Display verifier avatar and username
- [ ] Show relative timestamp (date-fns)
- [ ] Calculate distance from issue location
- [ ] Show distance warning if >100m
- [ ] Display verification photo (clickable)
- [ ] Display verification note

### Task 3: Create PhotoLightbox Component

- [ ] Create `/components/verification/PhotoLightbox.tsx`
- [ ] Full-screen photo modal
- [ ] Close button (X icon)
- [ ] Click outside to close
- [ ] Keyboard navigation (ESC to close)

### Task 4: Create API Route

- [ ] Create `/app/api/issues/[id]/verifications/route.ts`
- [ ] Query verifications with verifier data
- [ ] Order by created_at descending
- [ ] Return JSON response
- [ ] Handle errors

### Task 5: Integrate into Issue Detail Page

- [ ] Add VerificationList to issue detail page
- [ ] Pass issue location for distance calculation
- [ ] Position below issue details, above "Verify" button

### Task 6: Testing

- [ ] Unit tests for VerificationCard
- [ ] Test distance calculation
- [ ] Test relative timestamps
- [ ] Mock API route
- [ ] E2E test: View verifications on issue page
- [ ] E2E test: Open photo lightbox

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (Verification records exist) → IN PROGRESS
  - Story 1.3.7 (Issue Detail Page) ✅ COMPLETE
- **Blocks:** None
- **Related:**
  - Story 2.2.1 (Profile links)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] VerificationList displays all verifications
- [ ] Verification count badge shows correct count
- [ ] Verifier usernames link to profiles
- [ ] Relative timestamps working (date-fns)
- [ ] Distance warning shows if >100m
- [ ] Photo gallery swipeable on mobile
- [ ] Photo lightbox working (full-screen)
- [ ] Empty state displays correctly
- [ ] API route functional
- [ ] Unit tests written and passing
- [ ] E2E tests verify display
- [ ] Works on Chrome, Safari, Firefox
- [ ] Mobile horizontal scroll smooth
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.1.5" epic="2.1" points="3" sprint="2">
  <title>Multi-Verifier Display & Photo Gallery</title>
  <goal>Display all verification photos and notes for community transparency</goal>

  <components>
    <create file="components/verification/VerificationList.tsx"/>
    <create file="components/verification/VerificationCard.tsx"/>
    <create file="components/verification/PhotoLightbox.tsx"/>
    <create file="app/api/issues/[id]/verifications/route.ts"/>
  </components>

  <features>
    <photo-gallery layout="horizontal-scroll" mobile="snap" desktop="grid"/>
    <lightbox trigger="click" close="outside,escape,button"/>
    <timestamps format="relative" library="date-fns"/>
    <distance-warning threshold="100m"/>
  </features>
</story>
```
