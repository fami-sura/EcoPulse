# Story 2.3.4: Flag Analytics & Spam Rate Monitoring

**Epic:** 2.3 Community-Driven Content Flagging  
**Story Points:** 4  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As an** administrator  
**I want** to monitor flag trends and spam rates  
**So that** I can ensure the community-driven moderation system is healthy

---

## Acceptance Criteria

- [ ] **Spam rate metric:** `(flagged_hidden_count / total_reports) × 100`
  - Target: < 5% spam rate
  - Warning threshold: > 10% spam rate
- [ ] **Analytics queries** (SQL-based for MVP):
  - Total flags submitted (last 7 days, 30 days, all time)
  - Flags by reason (spam, offensive, inaccurate_location, duplicate, other)
  - Spam rate trend (daily, weekly, monthly)
  - Top flagged users (to identify serial spammers)
  - Flag review time (average time from flag submission to review)
- [ ] **Dashboard view (Supabase SQL Editor for MVP):**
  - Copy-paste SQL queries from documentation
  - Export results to CSV
  - Future: Custom analytics dashboard in app
- [ ] **Alert mechanism (optional for MVP):**
  - Email admin if spam rate > 10%
  - Slack webhook if spam rate > 15%
- [ ] **Documentation:**
  - SQL queries in `/docs/admin-analytics-queries.md`
  - Interpretation guide (what metrics mean)

---

## Technical Implementation

### Analytics SQL Queries

```sql
-- docs/admin-analytics-queries.sql

-- ==============================================
-- FLAG ANALYTICS QUERIES
-- ==============================================

-- 1. Total flags by time period
-- Usage: Monitor flag volume trends
SELECT
  COUNT(*) AS total_flags,
  COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '7 days') AS flags_last_7_days,
  COUNT(*) FILTER (WHERE created_at >= NOW() - INTERVAL '30 days') AS flags_last_30_days
FROM flags;

-- 2. Flags by reason
-- Usage: Identify most common flag reasons
SELECT
  reason,
  COUNT(*) AS count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage
FROM flags
GROUP BY reason
ORDER BY count DESC;

-- 3. Spam rate calculation
-- Usage: Track platform health (target < 5%)
SELECT
  COUNT(DISTINCT i.id) FILTER (WHERE i.status = 'flagged_hidden') AS hidden_issues,
  COUNT(DISTINCT i.id) AS total_issues,
  ROUND(
    COUNT(DISTINCT i.id) FILTER (WHERE i.status = 'flagged_hidden') * 100.0 /
    NULLIF(COUNT(DISTINCT i.id), 0),
    2
  ) AS spam_rate_percentage
FROM issues i;

-- 4. Spam rate trend (daily)
-- Usage: Identify spam rate spikes
SELECT
  DATE(created_at) AS date,
  COUNT(*) AS reports_created,
  COUNT(*) FILTER (WHERE status = 'flagged_hidden') AS reports_hidden,
  ROUND(
    COUNT(*) FILTER (WHERE status = 'flagged_hidden') * 100.0 /
    NULLIF(COUNT(*), 0),
    2
  ) AS spam_rate_percentage
FROM issues
WHERE created_at >= NOW() - INTERVAL '30 days'
GROUP BY DATE(created_at)
ORDER BY date DESC;

-- 5. Top flagged users (to identify serial spammers)
-- Usage: Find users creating spam reports
SELECT
  u.email,
  u.id AS user_id,
  COUNT(DISTINCT i.id) AS total_reports,
  COUNT(DISTINCT i.id) FILTER (WHERE i.status = 'flagged_hidden') AS hidden_reports,
  ROUND(
    COUNT(DISTINCT i.id) FILTER (WHERE i.status = 'flagged_hidden') * 100.0 /
    NULLIF(COUNT(DISTINCT i.id), 0),
    2
  ) AS spam_rate_percentage
FROM auth.users u
LEFT JOIN issues i ON i.user_id = u.id
GROUP BY u.id, u.email
HAVING COUNT(DISTINCT i.id) FILTER (WHERE i.status = 'flagged_hidden') > 0
ORDER BY hidden_reports DESC
LIMIT 20;

-- 6. Flag review time (efficiency metric)
-- Usage: Monitor moderation team responsiveness
SELECT
  AVG(EXTRACT(EPOCH FROM (reviewed_at - created_at)) / 3600) AS avg_review_time_hours,
  MIN(EXTRACT(EPOCH FROM (reviewed_at - created_at)) / 3600) AS min_review_time_hours,
  MAX(EXTRACT(EPOCH FROM (reviewed_at - created_at)) / 3600) AS max_review_time_hours
FROM flags
WHERE reviewed_at IS NOT NULL;

-- 7. Pending flags count
-- Usage: Monitor moderation queue backlog
SELECT
  COUNT(*) AS pending_flags,
  COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '24 hours') AS pending_over_24h,
  COUNT(*) FILTER (WHERE created_at < NOW() - INTERVAL '7 days') AS pending_over_7_days
FROM flags
WHERE status = 'pending';

-- 8. Flags by target type
-- Usage: Understand what content is being flagged
SELECT
  target_type,
  COUNT(*) AS count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage
FROM flags
GROUP BY target_type;

-- 9. Anonymous vs authenticated flagging
-- Usage: Monitor Sybil attack risk
SELECT
  CASE
    WHEN user_id IS NOT NULL THEN 'Authenticated'
    WHEN session_id IS NOT NULL THEN 'Anonymous'
    ELSE 'Unknown'
  END AS flagger_type,
  COUNT(*) AS count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) AS percentage
FROM flags
GROUP BY flagger_type;

-- 10. Weekly flag trend
-- Usage: Identify long-term patterns
SELECT
  DATE_TRUNC('week', created_at) AS week,
  COUNT(*) AS flags_submitted,
  COUNT(*) FILTER (WHERE status = 'reviewed') AS flags_reviewed,
  COUNT(*) FILTER (WHERE status = 'pending') AS flags_pending
FROM flags
WHERE created_at >= NOW() - INTERVAL '12 weeks'
GROUP BY week
ORDER BY week DESC;
```

### Analytics Documentation

```markdown
<!-- docs/admin-analytics-queries.md -->

# Flag Analytics & Spam Rate Monitoring

## Overview

This document contains SQL queries for monitoring the health of the community-driven moderation system. Run these queries in the **Supabase SQL Editor** to get real-time insights.

## Key Metrics

### 1. Spam Rate

**Target:** < 5%  
**Warning:** > 10%  
**Critical:** > 15%

**Formula:** `(flagged_hidden_issues / total_issues) × 100`

**Interpretation:**

- **< 5%:** Healthy community, minimal spam
- **5-10%:** Monitor closely, may need better spam detection
- **> 10%:** Action required: Review flagging thresholds, implement CAPTCHA, or investigate coordinated spam
- **> 15%:** Critical: Platform trust at risk, immediate intervention needed

### 2. Flag Volume

**Normal:** 1-5% of reports get flagged  
**Anomaly:** Sudden spike (10x increase) may indicate:

- Coordinated spam attack
- Policy change confusion
- Bug in auto-hide logic

### 3. Review Time

**Target:** < 24 hours  
**Warning:** > 72 hours

Slow review times reduce community trust in moderation.

### 4. Pending Queue

**Healthy:** < 20 pending flags  
**Overloaded:** > 100 pending flags

Consider adding more moderators or automating review for obvious spam.

## Running Queries

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Select your project
3. Navigate to **SQL Editor**
4. Copy a query from `admin-analytics-queries.sql`
5. Click **Run** or press `Cmd/Ctrl + Enter`
6. Export results to CSV if needed

## Weekly Review Checklist

- [ ] Check spam rate (Query #3)
- [ ] Review spam rate trend (Query #4)
- [ ] Identify top flagged users (Query #5)
- [ ] Check pending flags count (Query #7)
- [ ] Monitor flag volume (Query #1)
- [ ] Review flag reasons distribution (Query #2)
- [ ] Check average review time (Query #6)

## Alert Triggers

If any of these conditions occur, notify the admin team:

- ✅ **Spam rate > 10%** → Investigate recent reports
- ✅ **Pending flags > 50** → Add moderator shifts
- ✅ **Review time > 48 hours** → Prioritize moderation
- ✅ **Flag volume spike (3x baseline)** → Check for spam attack

## Future Enhancements (Phase 2)

- Automated email alerts for critical thresholds
- Real-time dashboard with charts (Recharts)
- Slack webhook integration
- Weekly digest email to admins
```

### PostgreSQL View for Quick Access

```sql
-- migrations/010_flag_analytics_views.sql

-- View: Flag summary by reason
CREATE OR REPLACE VIEW flag_summary AS
SELECT
  reason,
  COUNT(*) AS total_flags,
  COUNT(*) FILTER (WHERE status = 'pending') AS pending,
  COUNT(*) FILTER (WHERE status = 'reviewed') AS reviewed,
  COUNT(*) FILTER (WHERE status = 'dismissed') AS dismissed,
  AVG(EXTRACT(EPOCH FROM (reviewed_at - created_at)) / 3600) FILTER (WHERE reviewed_at IS NOT NULL) AS avg_review_hours
FROM flags
GROUP BY reason;

-- View: Current spam rate
CREATE OR REPLACE VIEW spam_rate_current AS
SELECT
  COUNT(DISTINCT id) FILTER (WHERE status = 'flagged_hidden') AS hidden_count,
  COUNT(DISTINCT id) AS total_count,
  ROUND(
    COUNT(DISTINCT id) FILTER (WHERE status = 'flagged_hidden') * 100.0 /
    NULLIF(COUNT(DISTINCT id), 0),
    2
  ) AS spam_rate_percentage,
  NOW() AS calculated_at
FROM issues;

-- Grant SELECT to admins only
GRANT SELECT ON flag_summary TO authenticated;
GRANT SELECT ON spam_rate_current TO authenticated;

-- RLS policies (optional: restrict to admins only)
ALTER VIEW flag_summary OWNER TO postgres;
ALTER VIEW spam_rate_current OWNER TO postgres;
```

### Future: Alert Function (Deferred)

```sql
-- migrations/011_spam_rate_alert.sql (FUTURE)

CREATE OR REPLACE FUNCTION check_spam_rate_alert()
RETURNS TRIGGER AS $$
DECLARE
  spam_rate NUMERIC;
BEGIN
  -- Calculate current spam rate
  SELECT spam_rate_percentage INTO spam_rate FROM spam_rate_current;

  -- If spam rate > 10%, send alert (Supabase Edge Function webhook)
  IF spam_rate > 10 THEN
    -- Future: Call Edge Function to send email/Slack alert
    PERFORM http_post(
      'https://your-project.supabase.co/functions/v1/spam-alert',
      json_build_object('spam_rate', spam_rate)::text,
      'application/json'
    );
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger: Check spam rate after each flag insertion
CREATE TRIGGER trigger_spam_rate_alert
  AFTER INSERT ON flags
  FOR EACH STATEMENT
  EXECUTE FUNCTION check_spam_rate_alert();
```

---

## Tasks & Subtasks

### Task 1: Create Analytics Queries

- [ ] Create `/docs/admin-analytics-queries.sql`
- [ ] Write 10 core analytics queries
- [ ] Test queries on sample data

### Task 2: Create Documentation

- [ ] Create `/docs/admin-analytics-queries.md`
- [ ] Explain each metric
- [ ] Add interpretation guide
- [ ] Add weekly review checklist

### Task 3: Create PostgreSQL Views

- [ ] Create `010_flag_analytics_views.sql`
- [ ] Define `flag_summary` view
- [ ] Define `spam_rate_current` view
- [ ] Grant permissions

### Task 4: Test Analytics

- [ ] Run queries on test data
- [ ] Verify spam rate calculation
- [ ] Verify flag volume trends

### Task 5: (Optional) Create Alert Function

- [ ] Defer to Phase 2 unless time permits
- [ ] Create `011_spam_rate_alert.sql`
- [ ] Implement webhook to Edge Function

---

## Dependencies

- **Blocked by:**
  - Story 2.3.1 (Flags table)
  - Story 2.3.2 (Hidden content data)
- **Blocks:** None

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Analytics SQL queries documented
- [ ] Queries tested on sample data
- [ ] Interpretation guide written
- [ ] PostgreSQL views created
- [ ] Weekly review checklist created
- [ ] Spam rate calculation accurate
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.3.4" epic="2.3" points="4" sprint="2">
  <title>Flag Analytics & Spam Rate Monitoring</title>
  <goal>Monitor community moderation health via analytics</goal>

  <metrics>
    <metric name="spam_rate" target="<5%" warning=">10%" critical=">15%"/>
    <metric name="flag_volume" normal="1-5%" anomaly="10x_spike"/>
    <metric name="review_time" target="<24h" warning=">72h"/>
    <metric name="pending_queue" healthy="<20" overloaded=">100"/>
  </metrics>

  <queries>
    <query id="1">Total flags by time period</query>
    <query id="2">Flags by reason</query>
    <query id="3">Spam rate calculation</query>
    <query id="4">Spam rate trend</query>
    <query id="5">Top flagged users</query>
    <query id="6">Flag review time</query>
    <query id="7">Pending flags count</query>
    <query id="8">Flags by target type</query>
    <query id="9">Anonymous vs authenticated</query>
    <query id="10">Weekly flag trend</query>
  </queries>
</story>
```
