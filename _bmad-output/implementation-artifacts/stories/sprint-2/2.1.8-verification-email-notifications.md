# Story 2.1.8: Verification Notifications (Email)

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** report submitter  
**I want** to be notified when my report is verified  
**So that** I know the community validated my observation

---

## Acceptance Criteria

- [ ] Email sent to reporter when verification threshold reached (2nd verification)
- [ ] Email subject: "Your report has been verified by the community!"
- [ ] Email body includes:
  - Issue location and category
  - Verification count: "2 community members verified your report"
  - Tangible impact message: "Your report is helping clean up your community!"
  - Link to issue detail page
  - Verifier usernames (optional, privacy consideration)
- [ ] Email template uses React Email (professional formatting)
- [ ] Email provider: Resend (configured in Supabase Auth settings)
- [ ] Email sent within 5 minutes of verification (NFR81)
- [ ] No email sent to anonymous reporters (no email address available)
- [ ] **Email preference check:** Query `users.email_verified_reports` preference (from Story 2.1.7)
- [ ] Only send email if `user.email_verified_reports = true` (default: true for new users)
- [ ] Error handling:
  - Email send failed: Log error, don't block verification submission
  - Retry mechanism: Supabase Edge Function with 3 retries

---

## Technical Implementation

### React Email Template

```tsx
// emails/verification-notification.tsx
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Link,
  Preview,
  Section,
  Text,
} from '@react-email/components';

interface VerificationEmailProps {
  reporterName: string;
  issueLocation: string;
  issueCategory: 'waste' | 'drainage';
  verificationCount: number;
  issueUrl: string;
  verifierUsernames?: string[];
}

export default function VerificationEmail({
  reporterName,
  issueLocation,
  issueCategory,
  verificationCount,
  issueUrl,
  verifierUsernames = [],
}: VerificationEmailProps) {
  const preview = `Your ${issueCategory} report has been verified by ${verificationCount} community members`;

  return (
    <Html>
      <Head />
      <Preview>{preview}</Preview>
      <Body style={main}>
        <Container style={container}>
          <Heading style={h1}>Your Report Has Been Verified! âœ“</Heading>

          <Text style={text}>Hi {reporterName},</Text>

          <Text style={text}>
            Great news! Your <strong>{issueCategory}</strong> report at{' '}
            <strong>{issueLocation}</strong> has been verified by{' '}
            <strong>{verificationCount} community members</strong>.
          </Text>

          {verifierUsernames.length > 0 && (
            <Text style={text}>
              Verified by: {verifierUsernames.map((u) => `@${u}`).join(', ')}
            </Text>
          )}

          <Section style={impactBox}>
            <Text style={impactText}>ðŸŒ¿ Your report is helping clean up your community!</Text>
          </Section>

          <Section style={buttonContainer}>
            <Link href={issueUrl} style={button}>
              View Report Details
            </Link>
          </Section>

          <Text style={footer}>
            You received this email because you reported an environmental issue on EcoPulse.
            <br />
            To manage your email preferences,{' '}
            <Link href={`${process.env.NEXT_PUBLIC_APP_URL}/profile/settings`}>click here</Link>.
          </Text>
        </Container>
      </Body>
    </Html>
  );
}

const main = {
  backgroundColor: '#f6f9fc',
  fontFamily:
    '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Ubuntu,sans-serif',
};

const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 0 48px',
  marginBottom: '64px',
};

const h1 = {
  color: '#059669',
  fontSize: '24px',
  fontWeight: 'bold',
  margin: '40px 0',
  padding: '0 40px',
};

const text = {
  color: '#374151',
  fontSize: '16px',
  lineHeight: '24px',
  margin: '16px 0',
  padding: '0 40px',
};

const impactBox = {
  backgroundColor: '#ECFDF5',
  borderRadius: '8px',
  margin: '24px 40px',
  padding: '16px',
};

const impactText = {
  color: '#059669',
  fontSize: '16px',
  fontWeight: '600',
  margin: 0,
  textAlign: 'center' as const,
};

const buttonContainer = {
  margin: '24px 0',
  textAlign: 'center' as const,
};

const button = {
  backgroundColor: '#059669',
  borderRadius: '6px',
  color: '#ffffff',
  fontSize: '16px',
  fontWeight: '600',
  textDecoration: 'none',
  textAlign: 'center' as const,
  display: 'inline-block',
  padding: '12px 24px',
};

const footer = {
  color: '#6B7280',
  fontSize: '12px',
  lineHeight: '16px',
  margin: '32px 0 0',
  padding: '0 40px',
};
```

### Email Sending Function

```typescript
// lib/email/sendVerificationEmail.ts
import { Resend } from 'resend';
import VerificationEmail from '@/emails/verification-notification';

const resend = new Resend(process.env.RESEND_API_KEY);

interface SendVerificationEmailParams {
  to: string;
  reporterName: string;
  issueId: string;
  issueLocation: string;
  issueCategory: 'waste' | 'drainage';
  verificationCount: number;
  verifierUsernames?: string[];
}

export async function sendVerificationEmail(params: SendVerificationEmailParams) {
  const issueUrl = `${process.env.NEXT_PUBLIC_APP_URL}/issues/${params.issueId}`;

  try {
    const { data, error } = await resend.emails.send({
      from: 'EcoPulse <notifications@ecopulse.ng>',
      to: params.to,
      subject: 'Your report has been verified by the community!',
      react: VerificationEmail({
        reporterName: params.reporterName,
        issueLocation: params.issueLocation,
        issueCategory: params.issueCategory,
        verificationCount: params.verificationCount,
        issueUrl,
        verifierUsernames: params.verifierUsernames,
      }),
    });

    if (error) {
      console.error('Resend email error:', error);
      return { success: false, error: error.message };
    }

    console.log('Verification email sent:', data?.id);
    return { success: true, emailId: data?.id };
  } catch (error) {
    console.error('Unexpected email send error:', error);
    return { success: false, error: 'Unexpected error' };
  }
}
```

### Update createVerification Server Action

```typescript
// app/actions/createVerification.ts (UPDATE - add email notification)
'use server';

import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';
import { sendVerificationEmail } from '@/lib/email/sendVerificationEmail';

export async function createVerification(input: CreateVerificationInput) {
  // ... existing validation and verification logic ...

  // Step 5: Atomic increment + threshold check
  const newCount = issue.verifications_count + 1;
  let newStatus = issue.status;

  // If we hit 2 verifications and status is pending, promote to verified
  if (newCount >= 2 && issue.status === 'pending') {
    newStatus = 'verified';

    // Update issue status
    await supabase
      .from('issues')
      .update({
        verifications_count: newCount,
        status: newStatus,
        updated_at: new Date().toISOString(),
      })
      .eq('id', input.issue_id);

    // Send email notification (non-blocking)
    if (issue.user_id) {
      // Fetch reporter email and preferences
      const { data: reporter } = await supabase
        .from('users')
        .select('email, username, email_verified_reports')
        .eq('id', issue.user_id)
        .single();

      // Only send if user has email notifications enabled
      if (reporter?.email && reporter.email_verified_reports) {
        // Fetch verifier usernames
        const { data: verifications } = await supabase
          .from('verifications')
          .select(
            `
            verifier:users!verifier_id (username)
          `
          )
          .eq('issue_id', input.issue_id)
          .limit(5);

        const verifierUsernames =
          verifications?.map((v) => v.verifier?.username).filter(Boolean) || [];

        // Send email (don't await - fire and forget)
        sendVerificationEmail({
          to: reporter.email,
          reporterName: reporter.username,
          issueId: input.issue_id,
          issueLocation: issue.address || `${issue.lat}, ${issue.lng}`,
          issueCategory: issue.category,
          verificationCount: newCount,
          verifierUsernames,
        }).catch((error) => {
          // Log but don't fail verification
          console.error('Failed to send verification email:', error);
        });
      }
    }
  }

  // ... rest of function ...
}
```

---

## Tasks & Subtasks

### Task 1: Set Up Resend Account

- [ ] Sign up for Resend account (free tier: 100 emails/day)
- [ ] Get API key from Resend dashboard
- [ ] Add API key to `.env.local`: `RESEND_API_KEY=`
- [ ] Configure sender email: `notifications@ecopulse.ng`
- [ ] Verify domain in Resend (or use test domain for MVP)

### Task 2: Install Dependencies

- [ ] Install Resend SDK: `npm install resend`
- [ ] Install React Email: `npm install @react-email/components`
- [ ] Add scripts to package.json for email preview

### Task 3: Create Email Template

- [ ] Create `/emails/verification-notification.tsx`
- [ ] Design professional email layout
- [ ] Add dynamic content (reporter name, location, etc.)
- [ ] Add tangible impact messaging
- [ ] Add link to issue detail page
- [ ] Add email preferences link in footer

### Task 4: Create Email Sending Function

- [ ] Create `/lib/email/sendVerificationEmail.ts`
- [ ] Integrate Resend SDK
- [ ] Render React Email template
- [ ] Add error handling with logging
- [ ] Don't throw errors (fire-and-forget pattern)

### Task 5: Update createVerification Server Action

- [ ] Check if threshold reached (2 verifications)
- [ ] Fetch reporter email and preferences
- [ ] Only send if `email_verified_reports = true`
- [ ] Fetch verifier usernames for email
- [ ] Call sendVerificationEmail (non-blocking)
- [ ] Log failures, don't block verification

### Task 6: Testing

- [ ] Unit test email template rendering
- [ ] Test email sending function (mock Resend)
- [ ] Test preference check (don't send if OFF)
- [ ] Test no email sent to anonymous reporters
- [ ] E2E test: Verify email sent on 2nd verification
- [ ] Manual test: Send real email to test account

---

## Dependencies

- **Blocked by:**
  - Story 2.1.4 (createVerification Server Action)
  - Story 2.1.7 (Email preferences) â†’ IN PROGRESS
- **Blocks:** None
- **Related:**
  - Sprint 3 Action Card reminders (similar email pattern)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Resend account configured
- [ ] React Email template created
- [ ] Email sent on 2nd verification
- [ ] Email preference check working
- [ ] No emails sent to anonymous users
- [ ] Professional email design
- [ ] Link to issue works
- [ ] Email preferences link in footer
- [ ] Error logging implemented
- [ ] Email sending non-blocking
- [ ] Unit tests written and passing
- [ ] E2E test verifies email trigger
- [ ] Manual email sent successfully
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Notes

### Resend Configuration

- **Free tier:** 100 emails/day (sufficient for MVP)
- **Domain verification:** Use Resend test domain for MVP
- **Production:** Verify custom domain (ecopulse.ng)

### Email Best Practices

- Clear subject line (action-oriented)
- Personalized greeting (use username)
- Tangible impact messaging (not points)
- Clear CTA (View Report Details)
- Unsubscribe option (link to settings)

### Non-Blocking Pattern

- Email send failures don't block verification
- Fire-and-forget: `sendEmail().catch(log)`
- Retry mechanism in Phase 2 (queue system)

### Privacy Considerations

- Show verifier usernames (public contribution)
- Respect email preferences (default: ON)
- No emails to anonymous reporters (no email)

---

## Story Context XML

```xml
<story id="2.1.8" epic="2.1" points="3" sprint="2">
  <title>Verification Notifications (Email)</title>
  <goal>Notify reporters when their reports are verified by community</goal>

  <components>
    <create file="emails/verification-notification.tsx" reason="React Email template"/>
    <create file="lib/email/sendVerificationEmail.ts" reason="Email sending function"/>
    <update file="app/actions/createVerification.ts" reason="Trigger email on threshold"/>
  </components>

  <email>
    <provider name="Resend"/>
    <subject text="Your report has been verified by the community!"/>
    <trigger event="threshold-reached" count="2"/>
    <preference-check field="email_verified_reports"/>
    <pattern type="fire-and-forget"/>
  </email>

  <testing>
    <unit component="email-template"/>
    <unit component="send-function"/>
    <e2e scenario="email-trigger-on-verification"/>
  </testing>
</story>
```
