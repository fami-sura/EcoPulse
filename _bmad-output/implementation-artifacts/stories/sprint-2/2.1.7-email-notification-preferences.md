# Story 2.1.7: Email Notification Preferences

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to control email notification preferences  
**So that** I receive only the notifications I want

---

## Acceptance Criteria

- [ ] Profile settings page: `/profile/settings`
- [ ] Email notification preferences section:
  - "Email me when my reports are verified" (default: ON)
  - "Email me when Action Cards I signed up for are approaching" (default: ON)
  - "Email me monthly impact summary" (default: OFF)
- [ ] Settings auto-save on toggle change (debounced)
- [ ] Success toast: "Settings saved"
- [ ] Error handling: "Save failed. Try again."
- [ ] Database columns added to `users` table:
  - `email_verified_reports` (boolean, default: true)
  - `email_action_cards` (boolean, default: true)
  - `email_monthly_summary` (boolean, default: false)
- [ ] Profile privacy toggle: "Make profile public" (default: ON)
  - Public profile: Anyone can view `/profile/[username]`
  - Private profile: Only user can view, returns 404 to others
  - Verifications still attributed (username shown), but profile not clickable

---

## Technical Implementation

### Profile Settings Page

```typescript
// app/[locale]/profile/settings/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { EmailPreferencesForm } from '@/components/profile/EmailPreferencesForm';

export default async function ProfileSettingsPage() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect('/login');
  }

  const { data: profile } = await supabase
    .from('users')
    .select('email_verified_reports, email_action_cards, email_monthly_summary, profile_public')
    .eq('id', user.id)
    .single();

  return (
    <div className="container max-w-2xl mx-auto px-4 py-8">
      <h1 className="text-2xl font-bold mb-6">Settings</h1>

      <EmailPreferencesForm
        userId={user.id}
        initialPreferences={profile}
      />
    </div>
  );
}
```

### Email Preferences Form

```typescript
// components/profile/EmailPreferencesForm.tsx
'use client';
import { useState } from 'react';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { useToast } from '@/hooks/use-toast';
import { updateProfileSettings } from '@/app/actions/updateProfileSettings';
import { useDebouncedCallback } from 'use-debounce';

interface EmailPreferencesFormProps {
  userId: string;
  initialPreferences: {
    email_verified_reports: boolean;
    email_action_cards: boolean;
    email_monthly_summary: boolean;
    profile_public: boolean;
  };
}

export function EmailPreferencesForm({ userId, initialPreferences }: EmailPreferencesFormProps) {
  const [preferences, setPreferences] = useState(initialPreferences);
  const [isSaving, setIsSaving] = useState(false);
  const { toast } = useToast();

  const debouncedSave = useDebouncedCallback(
    async (newPreferences) => {
      setIsSaving(true);

      try {
        const result = await updateProfileSettings(userId, newPreferences);

        if (result.success) {
          toast({
            title: "Settings saved",
            description: "Your preferences have been updated",
          });
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        toast({
          title: "Save failed",
          description: "Try again",
          variant: "destructive",
        });

        // Revert to previous state
        setPreferences(initialPreferences);
      } finally {
        setIsSaving(false);
      }
    },
    1000
  );

  const handleToggle = (field: keyof typeof preferences) => (checked: boolean) => {
    const newPreferences = { ...preferences, [field]: checked };
    setPreferences(newPreferences);
    debouncedSave(newPreferences);
  };

  return (
    <div className="space-y-6">
      {/* Email Notifications Section */}
      <div className="space-y-4">
        <h2 className="text-lg font-semibold">Email Notifications</h2>

        <div className="flex items-center justify-between py-3 border-b">
          <div className="space-y-0.5">
            <Label htmlFor="email-verified">Report Verifications</Label>
            <p className="text-sm text-gray-500">
              Get notified when your reports are verified by the community
            </p>
          </div>
          <Switch
            id="email-verified"
            checked={preferences.email_verified_reports}
            onCheckedChange={handleToggle('email_verified_reports')}
            disabled={isSaving}
          />
        </div>

        <div className="flex items-center justify-between py-3 border-b">
          <div className="space-y-0.5">
            <Label htmlFor="email-action-cards">Action Card Reminders</Label>
            <p className="text-sm text-gray-500">
              Reminders for upcoming Action Cards you've joined
            </p>
          </div>
          <Switch
            id="email-action-cards"
            checked={preferences.email_action_cards}
            onCheckedChange={handleToggle('email_action_cards')}
            disabled={isSaving}
          />
        </div>

        <div className="flex items-center justify-between py-3 border-b">
          <div className="space-y-0.5">
            <Label htmlFor="email-monthly">Monthly Impact Summary</Label>
            <p className="text-sm text-gray-500">
              Monthly recap of your environmental impact
            </p>
          </div>
          <Switch
            id="email-monthly"
            checked={preferences.email_monthly_summary}
            onCheckedChange={handleToggle('email_monthly_summary')}
            disabled={isSaving}
          />
        </div>
      </div>

      {/* Privacy Section */}
      <div className="space-y-4 pt-4">
        <h2 className="text-lg font-semibold">Privacy</h2>

        <div className="flex items-center justify-between py-3 border-b">
          <div className="space-y-0.5">
            <Label htmlFor="profile-public">Public Profile</Label>
            <p className="text-sm text-gray-500">
              Allow others to view your profile and contributions
            </p>
          </div>
          <Switch
            id="profile-public"
            checked={preferences.profile_public}
            onCheckedChange={handleToggle('profile_public')}
            disabled={isSaving}
          />
        </div>
      </div>

      {isSaving && (
        <p className="text-sm text-gray-500">Saving...</p>
      )}
    </div>
  );
}
```

### Server Action

```typescript
// app/actions/updateProfileSettings.ts
'use server';

import { createClient } from '@/lib/supabase/server';

interface ProfileSettings {
  email_verified_reports?: boolean;
  email_action_cards?: boolean;
  email_monthly_summary?: boolean;
  profile_public?: boolean;
}

export async function updateProfileSettings(userId: string, settings: ProfileSettings) {
  const supabase = await createClient();

  const { error } = await supabase.from('users').update(settings).eq('id', userId);

  if (error) {
    console.error('Profile settings update error:', error);
    return { success: false, error: 'Failed to update settings' };
  }

  return { success: true };
}
```

### Database Migration

```sql
-- migrations/004_email_preferences.sql

-- Add email preference columns to users table
ALTER TABLE users
ADD COLUMN IF NOT EXISTS email_verified_reports BOOLEAN DEFAULT true,
ADD COLUMN IF NOT EXISTS email_action_cards BOOLEAN DEFAULT true,
ADD COLUMN IF NOT EXISTS email_monthly_summary BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS profile_public BOOLEAN DEFAULT true;

-- Create index for public profile filtering
CREATE INDEX IF NOT EXISTS idx_users_profile_public
ON users(profile_public) WHERE profile_public = true;
```

---

## Tasks & Subtasks

### Task 1: Database Migration

- [ ] Create migration file: `004_email_preferences.sql`
- [ ] Add email preference columns
- [ ] Add profile_public column
- [ ] Create index on profile_public
- [ ] Run migration: `npx supabase migration up`
- [ ] Verify columns in Supabase dashboard

### Task 2: Create Settings Page

- [ ] Create `/app/[locale]/profile/settings/page.tsx`
- [ ] Add authentication check (redirect if not logged in)
- [ ] Fetch user preferences
- [ ] Render EmailPreferencesForm

### Task 3: Create EmailPreferencesForm Component

- [ ] Create `/components/profile/EmailPreferencesForm.tsx`
- [ ] Add Switch components for each preference
- [ ] Implement debounced auto-save (1 second)
- [ ] Add loading state during save
- [ ] Show success/error toast notifications

### Task 4: Create Server Action

- [ ] Create `/app/actions/updateProfileSettings.ts`
- [ ] Update users table with new settings
- [ ] Handle errors gracefully
- [ ] Return success/error response

### Task 5: Navigation Integration

- [ ] Add "Settings" link to profile dropdown menu
- [ ] Add "Settings" link to profile page sidebar
- [ ] Ensure route protection (authenticated only)

### Task 6: Testing

- [ ] Unit tests for EmailPreferencesForm
- [ ] Test debounced save logic
- [ ] Test error handling and revert
- [ ] Mock updateProfileSettings Server Action
- [ ] E2E test: Toggle preferences and verify save
- [ ] E2E test: Profile privacy toggle

---

## Dependencies

- **Blocked by:**
  - Story 1.4.1 (Authentication) âœ… COMPLETE
- **Blocks:**
  - Story 2.1.8 (Email Notifications - needs preferences check)
- **Related:**
  - Story 2.2.1 (Profile page - settings link)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Settings page created and accessible
- [ ] Email preferences auto-save (debounced 1s)
- [ ] Success/error toasts working
- [ ] Database migration applied
- [ ] Profile privacy toggle functional
- [ ] Settings persist across sessions
- [ ] Unit tests written and passing
- [ ] E2E tests verify save functionality
- [ ] Works on Chrome, Safari, Firefox
- [ ] Mobile responsive
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Notes

### Debounced Auto-Save

- **Why 1 second?** Balance between UX and API calls
- **Why debounce?** Prevent API spam on rapid toggles
- Uses `use-debounce` library

### Default Values

- Most users want verification emails: default ON
- Monthly summaries can be annoying: default OFF
- Public profiles encourage community: default ON

### Privacy Considerations

- Private profiles: `/profile/username` returns 404
- Verifications still show username (public contribution)
- Profile link not clickable if private

### Design Decisions

- Auto-save vs Save button: Auto-save for better UX
- Toast notifications for feedback
- Revert on error prevents confusion

---

## Story Context XML

```xml
<story id="2.1.7" epic="2.1" points="3" sprint="2">
  <title>Email Notification Preferences</title>
  <goal>Allow users to control which email notifications they receive</goal>

  <components>
    <create file="app/[locale]/profile/settings/page.tsx"/>
    <create file="components/profile/EmailPreferencesForm.tsx"/>
    <create file="app/actions/updateProfileSettings.ts"/>
    <create file="supabase/migrations/004_email_preferences.sql"/>
  </components>

  <preferences>
    <setting name="email_verified_reports" default="true"/>
    <setting name="email_action_cards" default="true"/>
    <setting name="email_monthly_summary" default="false"/>
    <setting name="profile_public" default="true"/>
  </preferences>

  <behavior>
    <auto-save debounce="1000ms"/>
    <revert-on-error enabled="true"/>
    <toast success="Settings saved" error="Save failed. Try again."/>
  </behavior>
</story>
```
