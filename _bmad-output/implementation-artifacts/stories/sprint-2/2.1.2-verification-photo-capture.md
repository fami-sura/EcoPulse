# Story 2.1.2: Verification Photo Capture with Angle Validation

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** verifier  
**I want** to upload a verification photo from the same location  
**So that** I can provide proof that the issue exists

---

## Acceptance Criteria

- [ ] Verification modal shows camera button (same as report photo capture)
- [ ] Photo captured using `<input type="file" accept="image/*" capture="environment">`
- [ ] Single photo required (1 photo minimum, max 3 for additional context)
- [ ] Photo uploaded with EXIF stripping (reuse uploadPhoto Server Action from Story 0.4)
- [ ] Photo size limit: 10MB per photo
- [ ] Compression: max 1920x1080, 85% JPEG quality
- [ ] Upload to Supabase Storage: `verification-photos/{userId}/{verificationId}.jpg`
- [ ] **Angle validation (basic):** Display warning if photo appears identical to original report photo
- [ ] **Screenshot detection (client-side):** If photo file size matches original within 5%, show warning
  - Warning: "Photo appears to be a screenshot. Please take a new photo from the location."
  - Allow override: "Submit Anyway" button (adds friction to lazy spam)
- [ ] Loading state: Progress bar during upload (<5s target on 3G)
- [ ] Error handling:
  - File too large: "Photo too large. Max 10MB."
  - Upload failed: Retry button + "Upload failed. Check connection and retry."
  - EXIF strip failed: Reject upload + "Privacy error. Try again or contact support."
- [ ] Success feedback: Green checkmark + "Photo uploaded"
- [ ] Photo preview with crop/rotate tools (optional, can defer)

---

## Technical Implementation

### Components to Create/Update

**Updated Components:**

- `/components/verification/VerificationModal.tsx` - Add photo capture UI
- `/components/verification/PhotoCapture.tsx` - NEW: Reusable photo capture component
- `/components/verification/__tests__/PhotoCapture.test.tsx` - Unit tests

**Server Actions:**

- Reuse `/app/actions/uploadPhoto.ts` from Story 0.4

### Code Structure

```typescript
// components/verification/PhotoCapture.tsx
'use client';
import { useState } from 'react';
import { Camera01 } from '@hugeicons/react';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { uploadPhoto } from '@/app/actions/uploadPhoto';
import { Progress } from '@/components/ui/progress';

interface PhotoCaptureProps {
  onPhotoUploaded: (url: string) => void;
  originalPhotoSize?: number; // For screenshot detection
  maxPhotos?: number;
}

export function PhotoCapture({
  onPhotoUploaded,
  originalPhotoSize,
  maxPhotos = 3
}: PhotoCaptureProps) {
  const [uploadedPhotos, setUploadedPhotos] = useState<string[]>([]);
  const [isUploading, setIsUploading] = useState(false);
  const [uploadProgress, setUploadProgress] = useState(0);
  const [error, setError] = useState<string | null>(null);
  const [screenshotWarning, setScreenshotWarning] = useState(false);
  const [pendingFile, setPendingFile] = useState<File | null>(null);

  const checkPotentialScreenshot = (fileSize: number): boolean => {
    if (!originalPhotoSize) return false;

    const sizeDiff = Math.abs(fileSize - originalPhotoSize);
    const percentDiff = (sizeDiff / originalPhotoSize) * 100;

    return percentDiff < 5; // Less than 5% difference suggests screenshot
  };

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Validate file size (10MB max)
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    if (file.size > MAX_SIZE) {
      setError("Photo too large. Max 10MB.");
      return;
    }

    // Check for potential screenshot
    if (checkPotentialScreenshot(file.size)) {
      setScreenshotWarning(true);
      setPendingFile(file);
      return;
    }

    await uploadPhotoFile(file);
  };

  const uploadPhotoFile = async (file: File) => {
    setIsUploading(true);
    setError(null);
    setScreenshotWarning(false);
    setPendingFile(null);

    try {
      const formData = new FormData();
      formData.append('photo', file);

      // Simulate progress (real progress tracking in Phase 2)
      const progressInterval = setInterval(() => {
        setUploadProgress(prev => Math.min(prev + 10, 90));
      }, 200);

      const result = await uploadPhoto(formData, {
        bucket: 'verification-photos',
        resize: { width: 1920, height: 1080 },
        quality: 85,
        stripExif: true
      });

      clearInterval(progressInterval);
      setUploadProgress(100);

      if (result.success && result.url) {
        setUploadedPhotos(prev => [...prev, result.url!]);
        onPhotoUploaded(result.url);

        // Reset after 1 second
        setTimeout(() => {
          setUploadProgress(0);
          setIsUploading(false);
        }, 1000);
      } else {
        throw new Error(result.error || 'Upload failed');
      }
    } catch (err) {
      setError('Upload failed. Check connection and retry.');
      setIsUploading(false);
      setUploadProgress(0);
    }
  };

  const handleScreenshotOverride = () => {
    if (pendingFile) {
      uploadPhotoFile(pendingFile);
    }
  };

  const canAddMore = uploadedPhotos.length < maxPhotos;

  return (
    <div className="space-y-4">
      {/* Screenshot Warning */}
      {screenshotWarning && (
        <Alert variant="warning">
          <AlertDescription>
            Photo appears to be a screenshot. Please take a new photo from the location.
            <div className="mt-2 flex gap-2">
              <Button
                size="sm"
                variant="outline"
                onClick={() => {
                  setScreenshotWarning(false);
                  setPendingFile(null);
                }}
              >
                Cancel
              </Button>
              <Button
                size="sm"
                onClick={handleScreenshotOverride}
              >
                Submit Anyway
              </Button>
            </div>
          </AlertDescription>
        </Alert>
      )}

      {/* Error Alert */}
      {error && (
        <Alert variant="destructive">
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {/* Upload Progress */}
      {isUploading && (
        <div className="space-y-2">
          <Progress value={uploadProgress} />
          <p className="text-sm text-gray-600">Uploading... {uploadProgress}%</p>
        </div>
      )}

      {/* Photo Previews */}
      {uploadedPhotos.length > 0 && (
        <div className="grid grid-cols-3 gap-2">
          {uploadedPhotos.map((url, idx) => (
            <div key={idx} className="relative aspect-square">
              <img
                src={url}
                alt={`Verification photo ${idx + 1}`}
                className="w-full h-full object-cover rounded-lg"
              />
              <div className="absolute top-1 right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                <span className="text-white text-xs">✓</span>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Camera Button */}
      {canAddMore && (
        <label className="block">
          <input
            type="file"
            accept="image/*"
            capture="environment"
            className="hidden"
            onChange={handleFileChange}
            disabled={isUploading}
          />
          <Button
            type="button"
            variant="outline"
            className="w-full flex items-center gap-2"
            disabled={isUploading}
            asChild
          >
            <span>
              <Camera01 size={20} />
              {uploadedPhotos.length === 0
                ? 'Take Verification Photo'
                : `Add Photo (${uploadedPhotos.length}/${maxPhotos})`
              }
            </span>
          </Button>
        </label>
      )}

      <p className="text-xs text-gray-500">
        {uploadedPhotos.length === 0
          ? 'Required: Take a photo from the same location to verify the issue'
          : `Optional: Add up to ${maxPhotos - uploadedPhotos.length} more photos for context`
        }
      </p>
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create PhotoCapture Component

- [ ] Create `/components/verification/PhotoCapture.tsx`
- [ ] Add file input with camera capture
- [ ] Implement file size validation (10MB max)
- [ ] Add screenshot detection logic (5% size difference)
- [ ] Add screenshot warning alert with override option
- [ ] Show upload progress bar
- [ ] Display photo previews (grid layout)
- [ ] Support multiple photos (1 required, max 3)

### Task 2: Integrate uploadPhoto Server Action

- [ ] Reuse `/app/actions/uploadPhoto.ts` from Story 0.4
- [ ] Configure for verification-photos bucket
- [ ] Set resize parameters: 1920x1080, 85% quality
- [ ] Ensure EXIF stripping enabled
- [ ] Handle upload errors and retries

### Task 3: Update VerificationModal

- [ ] Add PhotoCapture component to modal
- [ ] Pass originalPhotoSize for screenshot detection
- [ ] Store uploaded photo URLs in state
- [ ] Validate at least 1 photo before submit enabled

### Task 4: Error Handling & UX

- [ ] Add error alerts for all failure modes
- [ ] Add retry button for failed uploads
- [ ] Add loading skeleton during upload
- [ ] Add success feedback (checkmark icon)
- [ ] Add helpful error messages

### Task 5: Testing

- [ ] Write unit tests for PhotoCapture
- [ ] Test file size validation
- [ ] Test screenshot detection logic
- [ ] Test upload progress simulation
- [ ] Test multiple photo uploads
- [ ] Mock uploadPhoto Server Action
- [ ] E2E test: Upload verification photo
- [ ] E2E test: Screenshot warning flow

---

## Dependencies

- **Blocked by:**
  - Story 0.4 (uploadPhoto Server Action) ✅ COMPLETE
  - Story 2.1.1 (Verification Modal) → IN PROGRESS
- **Blocks:**
  - Story 2.1.4 (Create Verification Server Action)
- **Related:**
  - Story 1.3.2 (Photo Capture from report flow)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] PhotoCapture component created and functional
- [ ] Screenshot detection working (5% threshold)
- [ ] EXIF stripping confirmed on all uploads
- [ ] Photo compression working (1920x1080, 85%)
- [ ] Upload progress indicator visible
- [ ] Error handling for all failure modes
- [ ] Multiple photos supported (max 3)
- [ ] Unit tests written and passing (80% coverage)
- [ ] E2E tests verify photo upload flow
- [ ] Works on Chrome, Safari, Firefox (desktop + mobile)
- [ ] Mobile camera capture works on iOS/Android
- [ ] No console errors or warnings
- [ ] Code reviewed and approved
- [ ] Deployed to Vercel preview environment

---

## Notes

### Screenshot Detection

- **Why 5% threshold?** Screenshots often have exact file size matches
- **Why allow override?** Some legitimate photos might trigger false positives
- **Spam logging:** All "Submit Anyway" clicks logged for Sprint 4 analysis

### Photo Quality

- **Why 1920x1080?** Balance between quality and file size
- **Why 85% JPEG?** Minimal quality loss, significant size reduction
- **Why max 3 photos?** More context helpful, but prevents abuse

### Design Decisions

- Reuse uploadPhoto from Story 0.4 for consistency
- Client-side validation before server upload (faster feedback)
- Progress bar improves perceived performance on slow networks

### Performance Considerations

- Photo compression happens server-side (Sharp library)
- Upload progress simulated (real tracking in Phase 2)
- Photos load lazy (not eager) in preview grid

### Accessibility

- File input has proper label
- Error messages announced to screen readers
- Upload progress communicated via aria-live region
- Photos have descriptive alt text

---

## Story Context XML

```xml
<story id="2.1.2" epic="2.1" points="3" sprint="2">
  <title>Verification Photo Capture with Angle Validation</title>
  <goal>Enable verifiers to upload photo proof from same location with spam detection</goal>

  <components>
    <create file="components/verification/PhotoCapture.tsx" reason="Reusable photo capture"/>
    <update file="components/verification/VerificationModal.tsx" reason="Add photo upload"/>
    <reuse file="app/actions/uploadPhoto.ts" reason="EXIF stripping and compression"/>
  </components>

  <validation>
    <rule type="file-size" max="10MB"/>
    <rule type="screenshot-detection" threshold="5%"/>
    <rule type="photo-count" min="1" max="3"/>
    <rule type="exif-stripping" required="true"/>
  </validation>

  <storage>
    <bucket name="verification-photos"/>
    <path pattern="{userId}/{verificationId}.jpg"/>
    <compression width="1920" height="1080" quality="85"/>
  </storage>

  <testing>
    <unit component="PhotoCapture" scenarios="5"/>
    <e2e scenario="photo-upload-flow"/>
    <e2e scenario="screenshot-warning"/>
  </testing>
</story>
```
