# Story 2.3.2: Auto-Hide Issues After Flag Threshold

**Epic:** 2.3 Community-Driven Content Flagging  
**Story Points:** 4  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** platform administrator  
**I want** content with excessive flags to be automatically hidden  
**So that** spam/inappropriate content is removed without manual intervention

---

## Acceptance Criteria

- [ ] **Flag threshold for auto-hide:** 3 flags from UNIQUE users (not session_ids)
  - Rationale: Prevent Sybil attacks (multiple anonymous flags from same attacker)
  - Anonymous flags (session_id) count toward threshold BUT with lower weight
- [ ] **Weighted flag scoring:**
  - Authenticated user flag: 1.0 point
  - Anonymous session flag: 0.3 points
  - Auto-hide threshold: 3.0 points
  - Example: 3 authenticated flags = 3.0 points (hidden) OR 10 anonymous flags = 3.0 points (hidden)
- [ ] **Database trigger:** Automatically update `issues.status` to 'flagged_hidden' when threshold reached
- [ ] Hidden issues:
  - **Do NOT appear** on map
  - **Do NOT appear** in issue lists
  - **Do appear** in admin moderation dashboard
  - Show "This content has been hidden due to community flags" message if accessed via direct link
- [ ] **RLS filters:** Apply `WHERE status != 'flagged_hidden'` to all public issue queries
- [ ] **Verification photos:** Individual photos with 3+ flags are hidden (blurred with overlay message)
- [ ] **Reversibility:** Admins can unhide content in moderation dashboard (Story 2.3.3)
- [ ] **Notification:** Email admin when content is auto-hidden (optional for MVP)
- [ ] **Flag count badge:** Display flag count in admin dashboard (Story 2.3.3)

---

## Technical Implementation

### Database Migration

```sql
-- migrations/008_auto_hide_flagged_content.sql

-- Add 'flagged_hidden' status to issues
ALTER TABLE issues
  DROP CONSTRAINT IF EXISTS issues_status_check;

ALTER TABLE issues
  ADD CONSTRAINT issues_status_check
  CHECK (status IN ('active', 'verified', 'resolved', 'flagged_hidden'));

-- Function to calculate weighted flag score
CREATE OR REPLACE FUNCTION calculate_flag_score(
  target_type_param TEXT,
  target_id_param UUID
) RETURNS NUMERIC AS $$
DECLARE
  score NUMERIC := 0;
BEGIN
  SELECT
    SUM(CASE
      WHEN user_id IS NOT NULL THEN 1.0  -- Authenticated user
      WHEN session_id IS NOT NULL THEN 0.3  -- Anonymous session
      ELSE 0
    END)
  INTO score
  FROM flags
  WHERE target_type = target_type_param
    AND target_id = target_id_param
    AND status = 'pending'; -- Only count pending flags

  RETURN COALESCE(score, 0);
END;
$$ LANGUAGE plpgsql;

-- Trigger function to auto-hide issues when flag threshold reached
CREATE OR REPLACE FUNCTION auto_hide_flagged_content()
RETURNS TRIGGER AS $$
DECLARE
  flag_score NUMERIC;
  threshold NUMERIC := 3.0;
BEGIN
  -- Calculate flag score for the target
  flag_score := calculate_flag_score(NEW.target_type, NEW.target_id);

  -- If threshold reached, hide content
  IF flag_score >= threshold THEN
    IF NEW.target_type = 'issue' THEN
      UPDATE issues
      SET status = 'flagged_hidden'
      WHERE id = NEW.target_id
        AND status != 'flagged_hidden'; -- Avoid duplicate updates
    END IF;

    -- For verification photos, we don't delete but rely on RLS filtering
    -- (Story 2.3.3 will handle photo hiding in UI)
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger on flags table
CREATE TRIGGER trigger_auto_hide_flagged_content
  AFTER INSERT ON flags
  FOR EACH ROW
  EXECUTE FUNCTION auto_hide_flagged_content();

-- Update RLS policies to exclude flagged_hidden issues
DROP POLICY IF EXISTS "Anyone can view active issues" ON issues;

CREATE POLICY "Anyone can view active issues"
  ON issues FOR SELECT
  USING (status != 'flagged_hidden');

CREATE POLICY "Admins can view all issues"
  ON issues FOR SELECT
  USING (
    auth.uid() IN (SELECT id FROM auth.users WHERE role = 'admin')
  );
```

### Helper Function: Get Flag Score

```typescript
// lib/flags/getFlagScore.ts
import { createClient } from '@/lib/supabase/server';

export async function getFlagScore(
  targetType: 'issue' | 'verification',
  targetId: string
): Promise<number> {
  const supabase = await createClient();

  const { data, error } = await supabase.rpc('calculate_flag_score', {
    target_type_param: targetType,
    target_id_param: targetId,
  });

  if (error) {
    console.error('Flag score calculation error:', error);
    return 0;
  }

  return data || 0;
}
```

### Hidden Content Component

```typescript
// components/flags/HiddenContentMessage.tsx
import { EyeSlash } from '@hugeicons/react';

export function HiddenContentMessage() {
  return (
    <div className="flex flex-col items-center justify-center p-12 bg-gray-50 rounded-lg border border-gray-300">
      <EyeSlash size={48} className="text-gray-400 mb-4" />
      <h3 className="text-lg font-semibold text-gray-700 mb-2">
        Content Hidden
      </h3>
      <p className="text-gray-600 text-center max-w-md">
        This content has been hidden due to community flags. Our moderation team is reviewing it.
      </p>
    </div>
  );
}
```

### Updated Issue Detail Page

```typescript
// app/[locale]/issues/[id]/page.tsx (updated)
import { HiddenContentMessage } from '@/components/flags/HiddenContentMessage';

export default async function IssueDetailPage({ params }: { params: { id: string } }) {
  const supabase = await createClient();

  // Try to load issue (even if hidden, for showing hidden message)
  const { data: issue } = await supabase
    .from('issues')
    .select('*')
    .eq('id', params.id)
    .single();

  if (!issue) {
    notFound();
  }

  // Check if issue is hidden
  if (issue.status === 'flagged_hidden') {
    // Only admins can see hidden content
    const { data: { user } } = await supabase.auth.getUser();
    const isAdmin = user?.role === 'admin'; // Assuming role stored in user metadata

    if (!isAdmin) {
      return (
        <div className="container max-w-4xl py-8">
          <HiddenContentMessage />
        </div>
      );
    }

    // Admin sees content with warning banner
    return (
      <div className="container max-w-4xl py-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800 font-medium">
            ⚠️ This content is hidden due to flags. Only admins can see it.
          </p>
        </div>

        {/* Normal issue content */}
      </div>
    );
  }

  // Normal issue display
  return <div>...</div>;
}
```

### Hidden Verification Photo Component

```typescript
// components/verifications/VerificationPhotoGallery.tsx (updated)
'use client';
import { useState, useEffect } from 'react';
import Image from 'next/image';
import { EyeSlash } from '@hugeicons/react';
import { getFlagScore } from '@/lib/flags/getFlagScore';

interface VerificationPhoto {
  id: string;
  photo_url: string;
  verifier_username: string;
  created_at: string;
}

export function VerificationPhotoGallery({ photos }: { photos: VerificationPhoto[] }) {
  const [flagScores, setFlagScores] = useState<Record<string, number>>({});

  useEffect(() => {
    // Fetch flag scores for all photos
    async function fetchFlagScores() {
      const scores: Record<string, number> = {};

      for (const photo of photos) {
        const score = await getFlagScore('verification', photo.id);
        scores[photo.id] = score;
      }

      setFlagScores(scores);
    }

    fetchFlagScores();
  }, [photos]);

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
      {photos.map((photo) => {
        const isHidden = (flagScores[photo.id] || 0) >= 3.0;

        return (
          <div key={photo.id} className="relative aspect-square rounded-lg overflow-hidden border">
            {isHidden ? (
              <div className="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center p-4">
                <EyeSlash size={32} className="text-gray-400 mb-2" />
                <p className="text-xs text-gray-600 text-center">
                  Photo hidden due to flags
                </p>
              </div>
            ) : (
              <>
                <Image
                  src={photo.photo_url}
                  alt={`Verification by ${photo.verifier_username}`}
                  fill
                  className="object-cover"
                />

                {/* Flag button (Story 2.3.1) */}
              </>
            )}
          </div>
        );
      })}
    </div>
  );
}
```

### Map Filter (Exclude Hidden Issues)

```typescript
// lib/map/getMapIssues.ts (updated)
export async function getMapIssues(bounds: LatLngBounds) {
  const supabase = await createClient();

  const { data: issues, error } = await supabase
    .from('issues')
    .select('*')
    .neq('status', 'flagged_hidden') // Exclude hidden issues
    .gte('latitude', bounds.south)
    .lte('latitude', bounds.north)
    .gte('longitude', bounds.west)
    .lte('longitude', bounds.east);

  if (error) throw error;

  return issues;
}
```

---

## Tasks & Subtasks

### Task 1: Update Database Schema

- [ ] Create `008_auto_hide_flagged_content.sql`
- [ ] Add 'flagged_hidden' status to issues
- [ ] Create `calculate_flag_score()` function
- [ ] Create `auto_hide_flagged_content()` trigger function
- [ ] Add trigger on flags table
- [ ] Update RLS policies

### Task 2: Create Flag Score Utility

- [ ] Create `/lib/flags/getFlagScore.ts`
- [ ] Call PostgreSQL function
- [ ] Return numeric score

### Task 3: Create HiddenContentMessage Component

- [ ] Create `/components/flags/HiddenContentMessage.tsx`
- [ ] Display icon + message

### Task 4: Update Issue Detail Page

- [ ] Show HiddenContentMessage for non-admins
- [ ] Show warning banner for admins
- [ ] Load issue regardless of status (for admin access)

### Task 5: Update Verification Photo Gallery

- [ ] Fetch flag scores for photos
- [ ] Blur photos with score >= 3.0
- [ ] Show "Photo hidden" overlay

### Task 6: Update Map Query

- [ ] Exclude `status = 'flagged_hidden'` in map issues query
- [ ] Test map filtering

### Task 7: Testing

- [ ] Test weighted scoring (authenticated vs anonymous)
- [ ] Test auto-hide trigger
- [ ] Test RLS filtering
- [ ] Test admin access to hidden content
- [ ] E2E test: Flag content until hidden

---

## Dependencies

- **Blocked by:**
  - Story 2.3.1 (Flags table)
- **Blocks:**
  - Story 2.3.3 (Admin dashboard needs flag data)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Weighted flag scoring implemented
- [ ] Auto-hide trigger functional
- [ ] RLS policies exclude hidden content
- [ ] HiddenContentMessage component working
- [ ] Issue detail page handles hidden content
- [ ] Verification photos blur when flagged
- [ ] Map excludes hidden issues
- [ ] Admin override working
- [ ] Unit tests passing
- [ ] E2E tests verify auto-hide
- [ ] No console errors
- [ ] Code reviewed and approved

---

## Story Context XML

```xml
<story id="2.3.2" epic="2.3" points="4" sprint="2">
  <title>Auto-Hide Issues After Flag Threshold</title>
  <goal>Automatically hide content when community flags reach threshold</goal>

  <weighted-scoring>
    <user-flag weight="1.0">Authenticated user flag</user-flag>
    <session-flag weight="0.3">Anonymous session flag</session-flag>
    <threshold value="3.0">Auto-hide threshold</threshold>
  </weighted-scoring>

  <hidden-behavior>
    <map>Excluded from map</map>
    <lists>Excluded from issue lists</lists>
    <direct-link>Show "hidden" message</direct-link>
    <admin>Show with warning banner</admin>
  </hidden-behavior>
</story>
```
