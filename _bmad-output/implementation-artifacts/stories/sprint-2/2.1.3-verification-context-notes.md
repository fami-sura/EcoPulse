# Story 2.1.3: Verification Context Notes & Timestamp

**Epic:** 2.1 Community Verification Flow  
**Story Points:** 3  
**Sprint:** 2  
**Status:** Not Started

---

## User Story

**As a** verifier  
**I want** to add context notes to my verification  
**So that** I can provide additional details about what I observed

---

## Acceptance Criteria

- [ ] Text area for verification notes (optional, 0-500 characters)
- [ ] Placeholder: "What did you observe? Any additional context?"
- [ ] Character counter: "0/500 characters"
- [ ] Voice note option (optional, reuse voice recording from Story 1.3.6)
- [ ] Notes NOT required (can submit with photo only)
- [ ] **Auto-capture metadata:**
  - Timestamp: `created_at` (automatic)
  - GPS coordinates: Use browser Geolocation API (same as report submission)
  - Verifier username: Fetched from `users` table
- [ ] Geolocation accuracy indicator: "Accurate within 20 meters"
- [ ] Geolocation timeout: 5 seconds (then use report's coordinates as fallback)
- [ ] Display verification location on small map preview (150x150px)
- [ ] Location validation: Warn if verifier >500 meters from original report location
  - Warning message: "You're far from the issue location. Please verify in person."
  - Allow override: "Submit Anyway" button (trust community for MVP)
- [ ] Error handling:
  - Geolocation denied: "Location required for verification. Please enable."
  - Geolocation timeout: "Location detection slow. Using report location instead."
  - Network error: "Cannot submit. Check connection and retry."

---

## Technical Implementation

### Components to Create/Update

**Updated Components:**

- `/components/verification/VerificationModal.tsx` - Add context notes form
- `/components/verification/VerificationForm.tsx` - NEW: Complete verification form
- `/components/verification/LocationCapture.tsx` - NEW: Geolocation with map preview

### Code Structure

```typescript
// components/verification/VerificationForm.tsx
'use client';
import { useState } from 'react';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { PhotoCapture } from './PhotoCapture';
import { LocationCapture } from './LocationCapture';

interface VerificationFormProps {
  issueId: string;
  issueLocation: { lat: number; lng: number };
  verifierSessionId: string | null;
  onSubmit: (data: VerificationData) => Promise<void>;
}

interface VerificationData {
  photoUrls: string[];
  note: string;
  lat: number;
  lng: number;
}

export function VerificationForm({
  issueId,
  issueLocation,
  verifierSessionId,
  onSubmit
}: VerificationFormProps) {
  const [photoUrls, setPhotoUrls] = useState<string[]>([]);
  const [note, setNote] = useState('');
  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null);
  const [locationWarning, setLocationWarning] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  const MAX_NOTE_LENGTH = 500;

  const handlePhotoUploaded = (url: string) => {
    setPhotoUrls(prev => [...prev, url]);
  };

  const handleLocationCaptured = (coords: { lat: number; lng: number }) => {
    setLocation(coords);

    // Calculate distance from issue location
    const distance = calculateDistance(
      coords.lat, coords.lng,
      issueLocation.lat, issueLocation.lng
    );

    // Warn if > 500 meters away
    if (distance > 500) {
      setLocationWarning(true);
    } else {
      setLocationWarning(false);
    }
  };

  const calculateDistance = (lat1: number, lng1: number, lat2: number, lng2: number): number => {
    // Haversine formula for distance in meters
    const R = 6371e3; // Earth radius in meters
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lng2 - lng1) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distance in meters
  };

  const handleSubmit = async () => {
    if (photoUrls.length === 0) {
      alert('Please upload at least one photo');
      return;
    }

    if (!location) {
      alert('Location required for verification');
      return;
    }

    setIsSubmitting(true);

    try {
      await onSubmit({
        photoUrls,
        note,
        lat: location.lat,
        lng: location.lng
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  const canSubmit = photoUrls.length > 0 && location !== null;

  return (
    <div className="space-y-6">
      {/* Photo Capture */}
      <div>
        <Label>Verification Photo *</Label>
        <PhotoCapture
          onPhotoUploaded={handlePhotoUploaded}
          maxPhotos={3}
        />
      </div>

      {/* Location Capture */}
      <div>
        <Label>Location *</Label>
        <LocationCapture
          issueLocation={issueLocation}
          onLocationCaptured={handleLocationCaptured}
        />

        {locationWarning && (
          <Alert variant="warning" className="mt-2">
            <AlertDescription>
              You're far from the issue location. Please verify in person.
            </AlertDescription>
          </Alert>
        )}
      </div>

      {/* Context Notes */}
      <div>
        <Label htmlFor="verification-note">
          Additional Context (Optional)
        </Label>
        <Textarea
          id="verification-note"
          placeholder="What did you observe? Any additional context?"
          value={note}
          onChange={(e) => setNote(e.target.value.slice(0, MAX_NOTE_LENGTH))}
          className="mt-1 min-h-24"
        />
        <p className="mt-1 text-sm text-gray-500">
          {note.length}/{MAX_NOTE_LENGTH} characters
        </p>
      </div>

      {/* Submit Button */}
      <Button
        onClick={handleSubmit}
        disabled={!canSubmit || isSubmitting}
        className="w-full"
      >
        {isSubmitting ? 'Submitting...' : 'Submit Verification'}
      </Button>
    </div>
  );
}
```

```typescript
// components/verification/LocationCapture.tsx
'use client';
import { useState, useEffect } from 'react';
import { MapPinned, Loader2 } from '@hugeicons/react';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';

interface LocationCaptureProps {
  issueLocation: { lat: number; lng: number };
  onLocationCaptured: (coords: { lat: number; lng: number }) => void;
}

export function LocationCapture({
  issueLocation,
  onLocationCaptured
}: LocationCaptureProps) {
  const [status, setStatus] = useState<'idle' | 'loading' | 'success' | 'error'>('idle');
  const [error, setError] = useState<string | null>(null);
  const [accuracy, setAccuracy] = useState<number | null>(null);
  const [coords, setCoords] = useState<{ lat: number; lng: number } | null>(null);

  const requestLocation = () => {
    setStatus('loading');
    setError(null);

    const timeout = setTimeout(() => {
      // Fallback to issue location after 5 seconds
      setStatus('success');
      setCoords(issueLocation);
      onLocationCaptured(issueLocation);
      setError('Location detection slow. Using report location instead.');
    }, 5000);

    navigator.geolocation.getCurrentPosition(
      (position) => {
        clearTimeout(timeout);
        const { latitude, longitude, accuracy: acc } = position.coords;

        setStatus('success');
        setCoords({ lat: latitude, lng: longitude });
        setAccuracy(acc);
        onLocationCaptured({ lat: latitude, lng: longitude });
      },
      (err) => {
        clearTimeout(timeout);
        setStatus('error');

        if (err.code === err.PERMISSION_DENIED) {
          setError('Location required for verification. Please enable.');
        } else {
          setError('Location detection failed. Try again.');
        }
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      }
    );
  };

  return (
    <div className="space-y-3">
      {status === 'idle' && (
        <Button
          type="button"
          variant="outline"
          onClick={requestLocation}
          className="w-full"
        >
          <MapPinned size={20} className="mr-2" />
          Capture Current Location
        </Button>
      )}

      {status === 'loading' && (
        <div className="flex items-center justify-center py-4">
          <Loader2 size={24} className="animate-spin text-gray-400" />
          <span className="ml-2 text-sm text-gray-600">Getting location...</span>
        </div>
      )}

      {status === 'success' && coords && (
        <div className="space-y-2">
          <div className="flex items-center text-sm text-green-600">
            <MapPinned size={16} className="mr-1" />
            Location captured
            {accuracy && (
              <span className="ml-2 text-gray-500">
                (Accurate within {Math.round(accuracy)}m)
              </span>
            )}
          </div>

          {/* Mini map preview */}
          <div className="w-full h-32 bg-gray-100 rounded-lg overflow-hidden">
            <iframe
              src={`https://www.openstreetmap.org/export/embed.html?bbox=${coords.lng-0.01},${coords.lat-0.01},${coords.lng+0.01},${coords.lat+0.01}&layer=mapnik&marker=${coords.lat},${coords.lng}`}
              className="w-full h-full border-0"
              title="Verification location preview"
            />
          </div>

          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={requestLocation}
          >
            Re-capture Location
          </Button>
        </div>
      )}

      {error && (
        <Alert variant={status === 'error' ? 'destructive' : 'warning'}>
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create VerificationForm Component

- [ ] Create `/components/verification/VerificationForm.tsx`
- [ ] Add textarea for context notes (0-500 chars)
- [ ] Add character counter
- [ ] Integrate PhotoCapture component
- [ ] Integrate LocationCapture component
- [ ] Add distance calculation (Haversine formula)
- [ ] Show warning if >500m from issue location
- [ ] Add submit button with validation

### Task 2: Create LocationCapture Component

- [ ] Create `/components/verification/LocationCapture.tsx`
- [ ] Use browser Geolocation API
- [ ] Add 5-second timeout with fallback
- [ ] Show loading state while fetching
- [ ] Display accuracy indicator
- [ ] Show mini map preview (150x150px)
- [ ] Add re-capture button
- [ ] Handle permission denied error

### Task 3: Geolocation & Distance Validation

- [ ] Implement Haversine distance formula
- [ ] Calculate distance from issue location
- [ ] Show warning if >500 meters away
- [ ] Allow override (trust community for MVP)
- [ ] Use high accuracy mode for GPS

### Task 4: Update VerificationModal

- [ ] Replace placeholder with VerificationForm
- [ ] Pass issue location coordinates
- [ ] Handle form submission
- [ ] Show success/error states

### Task 5: Testing

- [ ] Write unit tests for VerificationForm
- [ ] Test distance calculation (Haversine)
- [ ] Test character counter
- [ ] Test location timeout fallback
- [ ] Mock Geolocation API
- [ ] E2E test: Complete verification flow
- [ ] E2E test: Location warning when far away

---

## Dependencies

- **Blocked by:**
  - Story 2.1.1 (Verification Modal) → IN PROGRESS
  - Story 2.1.2 (Photo Capture) → IN PROGRESS
- **Blocks:**
  - Story 2.1.4 (Create Verification Server Action)
- **Related:**
  - Story 1.3.3a (Auto-location detection from report flow)

---

## Definition of Done

- [ ] All acceptance criteria met
- [ ] VerificationForm component functional
- [ ] LocationCapture with geolocation working
- [ ] Context notes optional (0-500 chars)
- [ ] Character counter working
- [ ] Distance validation working (>500m warning)
- [ ] Location timeout fallback (5 seconds)
- [ ] Mini map preview displays
- [ ] Unit tests written and passing (80% coverage)
- [ ] E2E tests verify complete flow
- [ ] Works on Chrome, Safari, Firefox (desktop + mobile)
- [ ] Geolocation works on iOS/Android
- [ ] No console errors or warnings
- [ ] Code reviewed and approved
- [ ] Deployed to Vercel preview environment

---

## Notes

### Geolocation Accuracy

- **enableHighAccuracy: true** - More accurate but slower, drains battery
- **timeout: 5000ms** - Fallback after 5 seconds prevents UX blocking
- **maximumAge: 0** - Always get fresh location, no cached data

### Distance Validation

- **Why 500 meters?** Walking distance, prevents remote verification
- **Why allow override?** Trust community, some legitimate edge cases
- Haversine formula accurate enough for <10km distances

### Design Decisions

- Notes optional (photo is primary proof)
- Voice notes deferred to Phase 2 (complexity)
- Mini map preview builds trust in location accuracy

### Performance Considerations

- Geolocation request on component mount (auto-trigger)
- Timeout prevents indefinite loading
- OpenStreetMap embed lightweight (<100KB)

### Accessibility

- Textarea has proper label and ID
- Character counter aria-live for screen readers
- Location errors announced
- Keyboard navigation fully supported

---

## Story Context XML

```xml
<story id="2.1.3" epic="2.1" points="3" sprint="2">
  <title>Verification Context Notes & Timestamp</title>
  <goal>Capture additional context and location metadata for verification proof</goal>

  <components>
    <create file="components/verification/VerificationForm.tsx" reason="Complete form"/>
    <create file="components/verification/LocationCapture.tsx" reason="Geolocation capture"/>
    <update file="components/verification/VerificationModal.tsx" reason="Integrate form"/>
  </components>

  <geolocation>
    <accuracy mode="high"/>
    <timeout value="5000ms"/>
    <fallback use="issue-location"/>
    <validation threshold="500m" action="warn"/>
  </geolocation>

  <form>
    <field name="note" type="textarea" maxLength="500" required="false"/>
    <field name="photoUrls" type="array" minItems="1" required="true"/>
    <field name="location" type="coordinates" required="true"/>
    <field name="timestamp" type="datetime" auto="true"/>
  </form>

  <testing>
    <unit component="VerificationForm" scenarios="4"/>
    <unit component="LocationCapture" scenarios="3"/>
    <e2e scenario="complete-verification-flow"/>
  </testing>
</story>
```
