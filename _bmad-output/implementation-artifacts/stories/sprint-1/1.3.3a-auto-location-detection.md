# Story 1.3.3a: Auto-Location Detection

**Epic:** 1.3 60-Second Report Submission Flow  
**Story Points:** 3  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** my location auto-detected when reporting  
**So that** I don't need to manually enter an address

---

## Acceptance Criteria

- [ ] Auto-detect location using browser Geolocation API on form open
- [ ] Request permission modal: "Allow ecoPulse to access your location?"
- [ ] Success: Display detected location with accuracy indicator ("Accurate within 20 meters")
- [ ] Store lat/lng in form state (Zustand)
- [ ] Reverse geocoding using OpenStreetMap Nominatim API (free):
  - API: `https://nominatim.openstreetmap.org/reverse?format=json&lat={lat}&lon={lng}`
  - Display address: "2430 Telegraph Ave, Oakland, CA 94612"
  - Rate limit compliance: 1 request/second (Nominatim policy)
- [ ] "Use Current Location" button to re-trigger geolocation (if user moves)
- [ ] Fallback if geolocation denied:
  - Show map centered on Lagos, Nigeria default
  - User must manually place pin (Story 1.3.3b)
  - Message: "Location access denied. Please place pin on map manually."
- [ ] Comprehensive error handling
- [ ] Loading spinner while detecting location
- [ ] Accessibility: Screen reader announces location status

---

## Technical Implementation

### Components to Create

- `/components/report/LocationDetector.tsx`
- `/components/report/__tests__/LocationDetector.test.tsx`

### Hooks to Create

- `/hooks/useGeolocation.ts`

### Code Structure

```typescript
'use client';
import { useEffect, useState } from 'react';
import { MapPin01, Loader } from '@hugeicons/react';

const reverseGeocode = async (lat: number, lng: number) => {
  const response = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const data = await response.json();
  return data.display_name;
};

export function LocationDetector({ onLocationDetected }) {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [location, setLocation] = useState<{lat: number, lng: number, accuracy: number} | null>(null);
  const [address, setAddress] = useState<string>('');

  useEffect(() => {
    detectLocation();
  }, []);

  const detectLocation = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude, accuracy } = position.coords;
          setLocation({ lat: latitude, lng: longitude, accuracy });

          // Reverse geocoding (debounced)
          const address = await reverseGeocode(latitude, longitude);
          setAddress(address);

          onLocationDetected({ lat: latitude, lng: longitude, address, accuracy });
          setLoading(false);
        },
        (error) => {
          setError('Unable to detect location. Please place pin manually.');
          setLoading(false);
        },
        { timeout: 5000, enableHighAccuracy: true }
      );
    } else {
      setError('Geolocation not supported. Please place pin manually.');
      setLoading(false);
    }
  };

  return (
    <div className="location-detector">
      {/* Implementation */}
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create LocationDetector Component

- [ ] Create `/components/report/LocationDetector.tsx` file
- [ ] Use browser Geolocation API
- [ ] Request user's current position
- [ ] Set timeout to 5 seconds
- [ ] Enable high accuracy mode

### Task 2: Implement Geolocation Detection

- [ ] Call `navigator.geolocation.getCurrentPosition()`
- [ ] Handle success: Store lat/lng/accuracy
- [ ] Handle error: Show error message
- [ ] Handle timeout: Show timeout message
- [ ] Handle browser without geolocation: Show unsupported message

### Task 3: Implement Reverse Geocoding

- [ ] Create `reverseGeocode(lat, lng)` function
- [ ] Call Nominatim API
- [ ] Parse response and extract address
- [ ] Rate limit compliance: 1 request/second (debounce)
- [ ] Handle API errors gracefully

### Task 4: Create useGeolocation Hook

- [ ] Create `/hooks/useGeolocation.ts` file
- [ ] Extract geolocation logic into reusable hook
- [ ] Return `{ location, address, accuracy, loading, error, refetch }`
- [ ] Debounce reverse geocoding (1s delay)

### Task 5: Implement "Use Current Location" Button

- [ ] Add button to re-trigger geolocation
- [ ] Useful if user moves after initial detection
- [ ] Show loading state during re-detection
- [ ] Update location and address on success

### Task 6: Implement Error Handling

- [ ] Geolocation timeout (5s): "Unable to detect location. Please try again or place pin manually."
- [ ] Nominatim rate limit: Debounce requests (1s delay)
- [ ] Nominatim API error: Show lat/lng without address, allow manual pin
- [ ] Generic error: "Something went wrong. Please try again."
- [ ] Browser without geolocation: "Geolocation not supported. Please place pin manually."

### Task 7: Display Location Information

- [ ] Show address if reverse geocoding succeeds
- [ ] Show lat/lng if reverse geocoding fails
- [ ] Show accuracy: "Accurate within 20 meters"
- [ ] Show loading spinner while detecting

### Task 8: Accessibility Implementation

- [ ] ARIA live region for status announcements
- [ ] Announce "Location detected" or "Location detection failed"
- [ ] Keyboard accessible "Use Current Location" button

### Task 9: Testing

- [ ] Write unit tests for LocationDetector component
- [ ] Mock Geolocation API
- [ ] Test successful detection
- [ ] Test geolocation error
- [ ] Test timeout scenario
- [ ] Test reverse geocoding
- [ ] Test Nominatim API error handling
- [ ] E2E test: Location auto-detected on form open

---

## Dependencies

- **Blocked by:** Story 1.3.1 (FAB trigger)
- **Blocks:** Story 1.3.3b (Manual pin adjustment)
- **Related:** Story 1.2.1 (Reuses geolocation logic)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Geolocation working on HTTPS
- [x] Reverse geocoding working with Nominatim
- [x] Rate limit compliance verified (1 req/sec)
- [x] Error handling tested for all scenarios
- [x] Accessibility tested (screen reader)
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Nominatim API is free but requires rate limiting (1 req/sec)
- Nominatim Usage Policy: https://operations.osmfoundation.org/policies/nominatim/
- Geolocation only works on HTTPS (or localhost)
- High accuracy mode uses GPS (slower but more accurate)
- Accuracy typically 5-50 meters in urban areas
