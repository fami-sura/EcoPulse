# Story 1.1.3: Role-Based Menu Visibility

**Epic:** 1.1 Responsive Navigation & Layout  
**Story Points:** 2  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** system  
**I want** to show/hide menu items based on user role  
**So that** anonymous users, members, NGO coordinators, and government staff see appropriate options

---

## Acceptance Criteria

- [ ] Anonymous users see: Map, Login/Signup icons only
- [ ] Authenticated members see: Map, My Reports, Actions, Profile, Logout
- [ ] NGO coordinators also see: NGO Dashboard icon (Building icon from Hugeicons)
- [ ] Government staff also see: Gov Dashboard icon (Government icon - Phase 2 placeholder)
- [ ] Role fetched from Supabase Auth JWT
- [ ] Check `users` table: `select role from users where id = auth.uid()`
- [ ] Menu updates immediately after login (no page refresh, use Zustand store)
- [ ] Loading skeleton while fetching role (avoid flash of wrong menu)

---

## Technical Implementation

### Components to Create

- `/hooks/useUserRole.ts`
- `/hooks/__tests__/useUserRole.test.ts`

### State Management

- Zustand store: `useAuthStore({ user, role, isAuthenticated })`

### Type Definitions

```typescript
type UserRole = 'member' | 'ngo_coordinator' | 'government_staff' | 'admin';
```

### Code Structure

```typescript
// /hooks/useUserRole.ts
import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';
import { useAuthStore } from '@/stores/authStore';

export function useUserRole() {
  const [role, setRole] = useState<UserRole | null>(null);
  const [loading, setLoading] = useState(true);
  const { user } = useAuthStore();

  useEffect(() => {
    const fetchRole = async () => {
      const supabase = createClient();
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (user) {
        const { data } = await supabase.from('users').select('role').eq('id', user.id).single();

        setRole(data?.role || 'member');
      }
      setLoading(false);
    };

    fetchRole();
  }, [user]);

  return { role, loading };
}
```

---

## Tasks & Subtasks

### Task 1: Create useUserRole Hook

- [ ] Create `/hooks/useUserRole.ts` file
- [ ] Implement role fetching from Supabase
- [ ] Return `{ role, loading }` state
- [ ] Handle anonymous users (role = null)
- [ ] Add error handling for database failures

### Task 2: Implement Role Caching in Zustand

- [ ] Update `/stores/authStore.ts` with role state
- [ ] Add `role` to auth store
- [ ] Add `setRole` action
- [ ] Cache role after first fetch to avoid repeated queries
- [ ] Clear role on logout

### Task 3: Update Navigation Components

- [ ] Update DesktopNav to use `useUserRole` hook
- [ ] Update MobileMenu to use `useUserRole` hook
- [ ] Conditionally render menu items based on role
- [ ] Add loading skeleton while fetching role

### Task 4: Define Menu Visibility Rules

- [ ] Anonymous: Only Map, Login/Signup
- [ ] Member: Map, My Reports, Actions, Profile, Logout
- [ ] NGO Coordinator: + NGO Dashboard (Building icon)
- [ ] Government Staff: + Gov Dashboard (Government icon)
- [ ] Admin: All menu items

### Task 5: Implement Real-Time Role Updates

- [ ] Listen to auth state changes in Zustand
- [ ] Refresh role when user logs in
- [ ] Clear role when user logs out
- [ ] Test menu updates without page refresh

### Task 6: Testing

- [ ] Write unit tests for useUserRole hook
- [ ] Test role fetching for all user types
- [ ] Test loading states
- [ ] Test role caching in Zustand
- [ ] Test menu visibility for each role
- [ ] E2E test: Login → menu updates immediately

---

## Dependencies

- **Blocked by:** Story 1.1.1, 1.1.2, Story 0.2 (Supabase client) ✅, Story 1.4.1 (authentication)
- **Blocks:** None
- **Related:** Epic 1.4 (User Authentication)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] E2E test for role-based visibility
- [x] No flash of wrong menu content
- [x] Performance: Role cached to avoid repeated DB queries
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- **Performance Optimization:** Cache role in Zustand after first fetch
- Role should update immediately on login/logout without page refresh
- Loading skeleton prevents flash of incorrect menu items
