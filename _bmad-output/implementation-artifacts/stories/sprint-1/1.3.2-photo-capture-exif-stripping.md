# Story 1.3.2: Photo Capture & EXIF Stripping with Error Handling

**Epic:** 1.3 60-Second Report Submission Flow  
**Story Points:** 5  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to take/upload a photo of the issue  
**So that** I can provide visual evidence while protecting my location privacy

---

## Acceptance Criteria

- [ ] Mobile: Opens native camera directly via `<input type="file" accept="image/*" capture="environment">`
- [ ] Desktop: File picker with "Use Camera" and "Choose File" options
- [ ] Photo preview with crop/rotate tools (optional for MVP, can defer)
- [ ] Multiple photos supported: 1-5 photos per report
- [ ] "Add Another Photo" button after first photo (max 5 total)
- [ ] Photo size limit: 10MB per photo (client-side validation before upload)
- [ ] Calls `uploadPhoto` Server Action from Story 0.4
- [ ] Server strips ALL EXIF metadata (GPS, device info, timestamp) using `sharp`
- [ ] Compression: resize to max 1920x1080, 85% JPEG quality
- [ ] Upload to Supabase Storage: `issue-photos/{userId}/{timestamp}.jpg`
- [ ] Client-side validation: file type (jpg, png, heic, webp), size
- [ ] Loading state: Progress bar during upload (<5s target on 3G)
- [ ] Comprehensive error handling with retry mechanism
- [ ] Success feedback: Green checkmark + "Photo uploaded" message

---

## Technical Implementation

### Components to Create

- `/components/report/PhotoCapture.tsx`
- `/components/report/__tests__/PhotoCapture.test.tsx`

### Code Structure

```typescript
'use client';
import { useState } from 'react';
import { uploadPhoto } from '@/app/actions/uploadPhoto';
import { Camera01, CheckCircle, AlertCircle } from '@hugeicons/react';

export function PhotoCapture({ onPhotosChange }) {
  const [photoUrls, setPhotoUrls] = useState<string[]>([]);
  const [uploading, setUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // Client-side validation
    if (file.size > 10 * 1024 * 1024) {
      setError('Photo too large. Maximum 10MB per photo.');
      return;
    }

    const validTypes = ['image/jpeg', 'image/png', 'image/heic', 'image/webp'];
    if (!validTypes.includes(file.type)) {
      setError('Please upload a valid image (JPG, PNG, HEIC, WebP).');
      return;
    }

    // Upload with EXIF stripping
    setUploading(true);
    setError(null);

    const formData = new FormData();
    formData.append('photo', file);

    const result = await uploadPhoto(formData);

    if (!result.success) {
      setError(result.error);
      setUploading(false);
      return;
    }

    setPhotoUrls([...photoUrls, result.url]);
    onPhotosChange([...photoUrls, result.url]);
    setUploading(false);
  };

  return (
    <div className="photo-capture">
      {/* Implementation */}
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create PhotoCapture Component

- [ ] Create `/components/report/PhotoCapture.tsx` file
- [ ] Import uploadPhoto Server Action from Story 0.4
- [ ] Create file input with camera capture
- [ ] Mobile: `capture="environment"` for rear camera
- [ ] Desktop: Standard file picker

### Task 2: Implement Client-Side Validation

- [ ] Validate file size (<10MB)
- [ ] Validate file type (jpg, png, heic, webp)
- [ ] Show error message for invalid files
- [ ] Prevent upload if validation fails

### Task 3: Implement Photo Upload Flow

- [ ] Create FormData with file
- [ ] Call uploadPhoto Server Action
- [ ] Handle loading state (show progress indicator)
- [ ] Handle success (add URL to photoUrls array)
- [ ] Handle error (show error message with retry)

### Task 4: Implement Error Handling

- [ ] File too large (>10MB): "Photo too large. Maximum 10MB per photo."
- [ ] Invalid file type: "Please upload a valid image (JPG, PNG, HEIC, WebP)."
- [ ] EXIF stripping failed: "Photo processing failed. Please try a different photo."
- [ ] Upload failed (network): "Upload failed. Please check your connection and try again." + Retry button
- [ ] Supabase error: "Unable to upload photo. Please try again later."
- [ ] Add retry mechanism (max 3 attempts)

### Task 5: Implement Multiple Photo Upload

- [ ] Allow 1-5 photos per report
- [ ] Show "Add Another Photo" button after first upload
- [ ] Display uploaded photos as thumbnails
- [ ] Allow removing uploaded photos
- [ ] Disable "Add Another Photo" after 5 photos

### Task 6: Implement Loading State

- [ ] Show progress bar during upload
- [ ] Disable file input while uploading
- [ ] Display "Uploading..." message
- [ ] Show percentage if possible (or indeterminate progress)

### Task 7: Implement Success Feedback

- [ ] Show green checkmark icon
- [ ] Display "Photo uploaded" message
- [ ] Show photo thumbnail with preview

### Task 8: Race Condition Prevention

- [ ] Disable "Submit Report" button until all uploads complete
- [ ] Track upload status for each photo
- [ ] Show "Uploading photos..." in submit button when in progress

### Task 9: Testing

- [ ] Write unit tests for PhotoCapture component
- [ ] Test client-side validation (size, type)
- [ ] Test successful upload
- [ ] Test error scenarios (network, validation, server)
- [ ] Test retry mechanism
- [ ] Test multiple photo upload (1-5)
- [ ] Test race condition prevention
- [ ] E2E test: Upload photo → verify EXIF stripped

---

## Dependencies

- **Blocked by:** Story 1.3.1 (FAB trigger), Story 0.4 (uploadPhoto Server Action) ✅
- **Blocks:** Story 1.3.6 (Report Submission)
- **Related:** Story 0.4 (Photo processing pipeline)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] EXIF stripping verified (GPS metadata removed)
- [x] Error handling tested for all scenarios
- [x] Upload completes <5s on 3G simulation
- [x] Multiple photo upload working (1-5 photos)
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- **CRITICAL:** EXIF stripping happens server-side (Story 0.4)
- uploadPhoto Server Action uses `sharp` library
- Client-side compression optional (can defer to Sprint 2)
- Race condition: Disable submit until all photos finish uploading
- Retry mechanism prevents temporary network issues from blocking reports
