# Story 1.4.1: Email/Password Signup & Login (with Error Handling)

**Epic:** 1.4 User Authentication & Profile  
**Story Points:** 3  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to create an account and login with email and password  
**So that** I can claim ownership of my reports and earn points

---

## Acceptance Criteria

- [ ] Signup form with fields: email, password, username (display name)
- [ ] Password requirements: min 8 characters, validation feedback
- [ ] Email validation: valid format, not already registered
- [ ] Username validation: 3-20 characters, alphanumeric + underscore
- [ ] Login form with fields: email, password
- [ ] "Forgot Password" link (triggers password reset email)
- [ ] Supabase Auth handles: password hashing (bcrypt), email verification, session management
- [ ] Success redirect: Returns to previous page or map home
- [ ] Comprehensive error handling with clear messages
- [ ] Loading states on submit buttons (disable while processing)
- [ ] Forms use React Hook Form + Zod validation
- [ ] Accessibility: keyboard navigable, screen reader labels, focus management

---

## Technical Implementation

### Components to Create

- `/components/auth/SignupForm.tsx`
- `/components/auth/LoginForm.tsx`
- `/components/auth/__tests__/SignupForm.test.tsx`
- `/components/auth/__tests__/LoginForm.test.tsx`

### Pages to Create

- `/app/auth/signup/page.tsx`
- `/app/auth/login/page.tsx`

### Code Structure

```typescript
'use client';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { createClient } from '@/lib/supabase/client';
import { useRouter } from 'next/navigation';

const signupSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
  username: z.string()
    .min(3, 'Username must be at least 3 characters')
    .max(20, 'Username must be less than 20 characters')
    .regex(/^[a-zA-Z0-9_]+$/, 'Username can only contain letters, numbers, and underscores'),
});

export function SignupForm() {
  const router = useRouter();
  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm({
    resolver: zodResolver(signupSchema),
  });

  const onSubmit = async (data) => {
    const supabase = createClient();

    const { error } = await supabase.auth.signUp({
      email: data.email,
      password: data.password,
      options: {
        data: { username: data.username },
      },
    });

    if (error) {
      // Handle error
      return;
    }

    router.push('/');
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      {/* Form fields */}
    </form>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create Signup Form Component

- [ ] Create `/components/auth/SignupForm.tsx` file
- [ ] Install dependencies: `pnpm add react-hook-form @hookform/resolvers/zod zod`
- [ ] Create Zod schema for signup validation
- [ ] Set up React Hook Form
- [ ] Create form fields: email, password, username

### Task 2: Implement Signup Logic

- [ ] Call Supabase Auth signUp method
- [ ] Pass email, password, username (in metadata)
- [ ] Handle success: Redirect to home page
- [ ] Handle error: Display error message
- [ ] Create user record in `users` table after signup

### Task 3: Create Login Form Component

- [ ] Create `/components/auth/LoginForm.tsx` file
- [ ] Create Zod schema for login validation
- [ ] Set up React Hook Form
- [ ] Create form fields: email, password

### Task 4: Implement Login Logic

- [ ] Call Supabase Auth signInWithPassword method
- [ ] Pass email, password
- [ ] Handle success: Redirect to previous page or home
- [ ] Handle error: Display error message
- [ ] Update auth store with user data

### Task 5: Implement Password Validation

- [ ] Minimum 8 characters
- [ ] Show real-time validation feedback
- [ ] Password strength indicator (optional)
- [ ] Toggle password visibility (eye icon)

### Task 6: Implement Email Validation

- [ ] Valid email format
- [ ] Check if email already registered (on signup)
- [ ] Show validation feedback

### Task 7: Implement Username Validation

- [ ] 3-20 characters
- [ ] Alphanumeric + underscore only
- [ ] Check if username already taken (optional for MVP)
- [ ] Show validation feedback

### Task 8: Implement Comprehensive Error Handling

- [ ] Email already registered: "Email already registered" + link to login
- [ ] Invalid credentials: "Invalid email or password"
- [ ] Email not verified: "Check your email for verification link" + resend button
- [ ] Weak password: "Password must be at least 8 characters"
- [ ] Network error: "Connection failed. Check internet and try again."
- [ ] Supabase service down: "Authentication service unavailable. Try again in a moment."
- [ ] Generic error: "Something went wrong. Please try again."

### Task 9: Implement "Forgot Password" Flow

- [ ] Add "Forgot Password" link on login form
- [ ] Create password reset page
- [ ] Call Supabase Auth resetPasswordForEmail
- [ ] Show success message: "Check your email for reset link"
- [ ] Handle reset link click → update password

### Task 10: Create Auth Pages

- [ ] Create `/app/auth/signup/page.tsx`
- [ ] Create `/app/auth/login/page.tsx`
- [ ] Add page layouts with branding
- [ ] Add links between signup/login pages

### Task 11: Update Auth Store with User Data

- [ ] Update `/stores/authStore.ts`
- [ ] Add `user` state
- [ ] Add `isAuthenticated` computed state
- [ ] Add `setUser` action
- [ ] Add `clearUser` action (for logout)

### Task 12: Implement Loading States

- [ ] Disable submit button while processing
- [ ] Show spinner in submit button
- [ ] Prevent double submission

### Task 13: Implement Accessibility

- [ ] Keyboard navigable forms
- [ ] Proper label associations
- [ ] Error messages announced to screen readers
- [ ] Focus management (errors, success states)

### Task 14: Testing

- [ ] Write unit tests for SignupForm component
- [ ] Write unit tests for LoginForm component
- [ ] Test validation logic
- [ ] Test successful signup
- [ ] Test successful login
- [ ] Test all error scenarios
- [ ] Test password reset flow
- [ ] E2E test: Signup → verify email → login

---

## Dependencies

- **Blocked by:** Story 0.2 (Supabase Auth configured) ✅
- **Blocks:** Story 1.1.3 (Role-based menu visibility), Story 1.4.3 (Anonymous conversion)
- **Related:** Story 1.4.2 (Magic Link Auth - alternative login method)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Supabase Auth working (signup, login, password reset)
- [x] Error handling tested for all scenarios
- [x] Forms validated with Zod schemas
- [x] Accessibility tested (keyboard + screen reader)
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Supabase Auth handles password hashing (bcrypt) automatically
- Email verification required before full account access
- Username stored in Supabase Auth metadata and `users` table
- Session managed by Supabase Auth (JWT tokens)
- React Hook Form provides excellent form validation DX
