# Story 1.2.2: Display Issue Pins on Map

**Epic:** 1.2 Interactive Map with Clustering & Filters  
**Story Points:** 5  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to see colored pins representing issue reports  
**So that** I can visually identify report locations and status

---

## Acceptance Criteria

- [ ] Fetch issue data from Supabase `issues` table (Server Action)
- [ ] Display pins at lat/lng coordinates using IssueMarker from Story 0.3
- [ ] Pin colors based on status:
  - âšª Gray: Pending verification (status = 'pending')
  - ðŸŸ¢ Green: Verified (status = 'verified')
  - ðŸ”µ Blue: In Progress (status = 'in_progress')
  - âœ… Green checkmark: Resolved (status = 'resolved')
- [ ] Query limited to map bounds for performance:
  - Mobile (<1024px): Max 50 pins
  - Desktop (â‰¥1024px): Max 100 pins
- [ ] Server Action: `/app/actions/getMapIssues.ts`
- [ ] RLS policy enforced: Only show non-flagged issues (`is_flagged = false`)
- [ ] Tap pin opens issue summary card:
  - Mobile: Bottom sheet slides up (50% screen height)
  - Desktop: Popover next to pin
- [ ] Loading spinner while fetching pins
- [ ] Error handling: "Unable to load issues. Please try again."

---

## Technical Implementation

### Files to Create

- `/app/actions/getMapIssues.ts` (Server Action)
- `/app/actions/__tests__/getMapIssues.test.ts`
- `/components/map/IssuePinLayer.tsx`

### State Management

- Zustand store: `useMapStore({ pins, selectedPin })`

### Server Action Structure

```typescript
'use server';
import { createClient } from '@/lib/supabase/server';

export async function getMapIssues(bounds, limit = 50) {
  const supabase = await createClient();

  const { data, error } = await supabase
    .from('issues')
    .select('id, lat, lng, status, category, photos, created_at')
    .eq('is_flagged', false)
    .gte('lat', bounds.sw_lat)
    .lte('lat', bounds.ne_lat)
    .gte('lng', bounds.sw_lng)
    .lte('lng', bounds.ne_lng)
    .limit(limit);

  if (error) return { success: false, error: error.message };
  return { success: true, data };
}
```

---

## Tasks & Subtasks

### Task 1: Create Server Action for Fetching Issues

- [ ] Create `/app/actions/getMapIssues.ts` file
- [ ] Implement `getMapIssues(bounds, limit)` function
- [ ] Query Supabase `issues` table
- [ ] Filter by map bounds (sw_lat, sw_lng, ne_lat, ne_lng)
- [ ] Enforce RLS: `is_flagged = false`
- [ ] Limit results: 50 (mobile), 100 (desktop)
- [ ] Return structured response: `{ success, data/error }`

### Task 2: Create IssuePinLayer Component

- [ ] Create `/components/map/IssuePinLayer.tsx` file
- [ ] Fetch issues on mount using getMapIssues
- [ ] Map over issues array
- [ ] Render IssueMarker for each issue
- [ ] Handle loading state (spinner)
- [ ] Handle error state (error message)

### Task 3: Implement Pin Color Logic

- [ ] Gray pin for 'pending' status
- [ ] Green pin for 'verified' status
- [ ] Blue pin for 'in_progress' status
- [ ] Green checkmark for 'resolved' status
- [ ] Update IssueMarker component to accept status prop

### Task 4: Implement Pin Click Handler

- [ ] Add onClick handler to IssueMarker
- [ ] Store selected pin in Zustand: `setSelectedPin(issue)`
- [ ] Mobile: Show bottom sheet with issue summary
- [ ] Desktop: Show popover next to pin
- [ ] Issue summary includes: photo, category, severity, created date

### Task 5: Optimize Query with Map Bounds

- [ ] Get map bounds from Leaflet map instance
- [ ] Pass bounds to getMapIssues Server Action
- [ ] Detect viewport size (mobile vs desktop)
- [ ] Set limit: 50 (mobile), 100 (desktop)
- [ ] Re-fetch when map bounds change (pan/zoom)

### Task 6: State Management with Zustand

- [ ] Update `/stores/mapStore.ts` with pins state
- [ ] Add `pins: Issue[]` state
- [ ] Add `selectedPin: Issue | null` state
- [ ] Add `setPins` action
- [ ] Add `setSelectedPin` action

### Task 7: Testing

- [ ] Write unit tests for getMapIssues Server Action
- [ ] Mock Supabase queries
- [ ] Test bounds filtering
- [ ] Test RLS enforcement (is_flagged = false)
- [ ] Test limit parameter
- [ ] Test error handling
- [ ] E2E test: Map loads with pins displayed

---

## Dependencies

- **Blocked by:** Story 1.2.1 (map setup), Story 0.1 (database schema) âœ…, Story 0.2 (Supabase client) âœ…, Story 0.3 (IssueMarker) âœ…
- **Blocks:** Story 1.2.3 (Client-Side Pin Clustering)
- **Related:** Story 1.2.4 (Map Filters UI)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Server Action tested with mock data
- [x] RLS policies verified
- [x] Performance: <500ms to fetch and render 100 pins
- [x] Error handling tested
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- RLS policies ensure only non-flagged issues are visible
- Bounds filtering improves performance by only loading visible pins
- Mobile limit (50) prevents overwhelming smaller screens
- Desktop limit (100) provides better overview on larger displays
