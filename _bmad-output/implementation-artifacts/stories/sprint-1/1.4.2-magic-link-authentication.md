# Story 1.4.2: Magic Link Authentication

**Epic:** 1.4 User Authentication & Profile  
**Story Points:** 2  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user who doesn't want to remember passwords  
**I want** to login with a magic link sent to my email  
**So that** I can access my account securely without a password

---

## Acceptance Criteria

- [ ] Magic link form with single field: email
- [ ] Email validation: valid format
- [ ] On submit: Supabase sends magic link to email
- [ ] Success message: "Check your email! We sent you a login link."
- [ ] Email contains clickable link that logs user in
- [ ] Magic link expires after 1 hour (Supabase default)
- [ ] On magic link click: User logged in and redirected to home page
- [ ] Error handling: Invalid email, network errors, expired links
- [ ] Loading state while sending email
- [ ] Option to "Resend magic link" if email not received

---

## Technical Implementation

### Components to Create

- `/components/auth/MagicLinkForm.tsx`
- `/components/auth/__tests__/MagicLinkForm.test.tsx`

### Pages to Create

- `/app/auth/magic-link/page.tsx`

### Code Structure

```typescript
'use client';
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { createClient } from '@/lib/supabase/client';

const magicLinkSchema = z.object({
  email: z.string().email('Invalid email address'),
});

export function MagicLinkForm() {
  const [sent, setSent] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const { register, handleSubmit, formState: { errors, isSubmitting } } = useForm({
    resolver: zodResolver(magicLinkSchema),
  });

  const onSubmit = async (data) => {
    const supabase = createClient();

    const { error } = await supabase.auth.signInWithOtp({
      email: data.email,
      options: {
        emailRedirectTo: `${window.location.origin}/auth/callback`,
      },
    });

    if (error) {
      setError(error.message);
      return;
    }

    setSent(true);
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      {sent ? (
        <div className="success-message">
          Check your email! We sent you a login link.
        </div>
      ) : (
        <>
          {/* Email input */}
          {/* Submit button */}
        </>
      )}
    </form>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create MagicLinkForm Component

- [ ] Create `/components/auth/MagicLinkForm.tsx` file
- [ ] Create Zod schema for email validation
- [ ] Set up React Hook Form
- [ ] Create email input field

### Task 2: Implement Magic Link Send Logic

- [ ] Call Supabase Auth signInWithOtp method
- [ ] Pass email address
- [ ] Set emailRedirectTo: `/auth/callback`
- [ ] Handle success: Show success message
- [ ] Handle error: Display error message

### Task 3: Create Auth Callback Handler

- [ ] Create `/app/auth/callback/route.ts`
- [ ] Verify magic link token
- [ ] Create user session
- [ ] Redirect to home page
- [ ] Handle expired/invalid tokens

### Task 4: Implement Success State

- [ ] Show success message after sending
- [ ] Hide form after success
- [ ] Display "Didn't receive email?" with resend option
- [ ] Add "Check spam folder" tip

### Task 5: Implement Resend Logic

- [ ] Add "Resend magic link" button
- [ ] Call signInWithOtp again
- [ ] Show confirmation: "Link resent!"
- [ ] Prevent spam: Rate limit resends (1 per minute)

### Task 6: Implement Error Handling

- [ ] Invalid email: "Invalid email address"
- [ ] Network error: "Connection failed. Check internet and try again."
- [ ] Supabase error: "Unable to send magic link. Try again in a moment."
- [ ] Expired link: "This link has expired. Request a new one."
- [ ] Generic error: "Something went wrong. Please try again."

### Task 7: Create Magic Link Page

- [ ] Create `/app/auth/magic-link/page.tsx`
- [ ] Add page layout with branding
- [ ] Add link to traditional login
- [ ] Add explanation: "We'll send you a secure login link"

### Task 8: Implement Loading State

- [ ] Disable submit button while sending
- [ ] Show spinner in submit button
- [ ] Display "Sending magic link..." message

### Task 9: Implement Accessibility

- [ ] Keyboard navigable form
- [ ] Proper label for email input
- [ ] Success/error messages announced to screen readers
- [ ] Focus management

### Task 10: Testing

- [ ] Write unit tests for MagicLinkForm component
- [ ] Test email validation
- [ ] Test successful magic link send
- [ ] Test error scenarios
- [ ] Test resend functionality
- [ ] Test callback handler
- [ ] E2E test: Request magic link → click link in email → logged in

---

## Dependencies

- **Blocked by:** Story 1.4.1 (Auth setup)
- **Blocks:** None
- **Related:** Story 1.4.1 (Alternative to password auth)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Magic link email sending working
- [x] Callback handler working
- [x] Error handling tested for all scenarios
- [x] Resend functionality working
- [x] Accessibility tested (keyboard + screen reader)
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Magic links expire after 1 hour (Supabase default)
- Supabase sends email automatically (no custom SMTP needed for MVP)
- Callback route verifies token and creates session
- More user-friendly than passwords for mobile users
- Consider custom email template in Phase 2
