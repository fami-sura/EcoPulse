# Story 1.2.3: Client-Side Pin Clustering (Simplified)

**Epic:** 1.2 Interactive Map with Clustering & Filters  
**Story Points:** 3  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to see cluster badges when many pins are close together  
**So that** the map remains readable with hundreds of reports

---

## Acceptance Criteria

- [ ] Install dependency: `npm install react-leaflet-cluster`
- [ ] Wrap markers in `<MarkerClusterGroup>` component (client-side clustering)
- [ ] Cluster badge shows count: "23 reports"
- [ ] Cluster badge color: gray background with green text (#059669)
- [ ] Cluster badge size scales with count (small: <10, medium: 10-50, large: 50+)
- [ ] Tap cluster badge zooms in one level (reveals individual pins or smaller clusters)
- [ ] Performance: Client-side clustering handles up to 500 pins without lag (<16ms frame time)
- [ ] Performance Testing: Test with 500 pins on budget Android device
- [ ] Mobile: max 50 pins rendered (filtering done server-side in Story 1.2.2)
- [ ] Desktop: max 100 pins rendered
- [ ] Clustering respects map zoom level (higher zoom = less clustering)

---

## Technical Implementation

### Dependencies to Install

```bash
pnpm add react-leaflet-cluster
```

### Code Structure

```typescript
'use client';
import MarkerClusterGroup from 'react-leaflet-cluster';
import { divIcon } from 'leaflet';

export function ClusteredMarkers({ pins }) {
  const createClusterIcon = (cluster) => {
    const count = cluster.getChildCount();

    let size = 'small';
    if (count >= 50) size = 'large';
    else if (count >= 10) size = 'medium';

    return divIcon({
      html: `<div class="cluster-icon cluster-${size}">${count}</div>`,
      className: 'custom-cluster',
      iconSize: [40, 40],
    });
  };

  return (
    <MarkerClusterGroup
      chunkedLoading
      maxClusterRadius={80}
      spiderfyOnMaxZoom={true}
      showCoverageOnHover={false}
      iconCreateFunction={createClusterIcon}
    >
      {pins.map((issue) => (
        <IssueMarker key={issue.id} {...issue} />
      ))}
    </MarkerClusterGroup>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Install react-leaflet-cluster

- [ ] Run: `pnpm add react-leaflet-cluster`
- [ ] Verify installation in package.json
- [ ] Import MarkerClusterGroup in component

### Task 2: Create ClusteredMarkers Component

- [ ] Create `/components/map/ClusteredMarkers.tsx` file
- [ ] Wrap existing IssueMarker components in MarkerClusterGroup
- [ ] Configure clustering options:
  - `chunkedLoading`: true (better performance)
  - `maxClusterRadius`: 80px
  - `spiderfyOnMaxZoom`: true
  - `showCoverageOnHover`: false

### Task 3: Implement Custom Cluster Icon

- [ ] Create `iconCreateFunction` for custom cluster badges
- [ ] Display count inside cluster badge
- [ ] Scale badge size based on count:
  - Small (<10): 40x40px
  - Medium (10-50): 50x50px
  - Large (50+): 60x60px
- [ ] Style with green text (#059669) on gray background

### Task 4: Add CSS Styling for Clusters

- [ ] Create cluster styles in globals.css
- [ ] Gray background with green text
- [ ] Border radius for circular badge
- [ ] Font weight and size
- [ ] Hover state (darken background)

```css
.cluster-icon {
  background: rgba(100, 116, 139, 0.2);
  border: 2px solid #059669;
  border-radius: 50%;
  color: #059669;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cluster-small {
  width: 40px;
  height: 40px;
  font-size: 14px;
}
.cluster-medium {
  width: 50px;
  height: 50px;
  font-size: 16px;
}
.cluster-large {
  width: 60px;
  height: 60px;
  font-size: 18px;
}
```

### Task 5: Performance Testing

- [ ] Generate 500 test pins with random coordinates
- [ ] Test on budget Android device (or Chrome DevTools mobile emulation)
- [ ] Measure frame rate during pan/zoom (target: 60fps)
- [ ] Measure initial render time (target: <2s)
- [ ] Verify no jank during cluster expand/collapse
- [ ] Monitor memory usage

### Task 6: Testing

- [ ] Write unit tests for ClusteredMarkers component
- [ ] Test cluster icon creation
- [ ] Test cluster size scaling
- [ ] Test cluster click behavior (zoom in)
- [ ] Load test with 500 pins
- [ ] Verify clustering respects zoom level
- [ ] E2E test: Tap cluster → zooms in → reveals pins

---

## Dependencies

- **Blocked by:** Story 1.2.2 (needs pins to cluster)
- **Blocks:** None
- **Related:** Story 1.2.4 (Map Filters UI)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing
- [x] Performance tested with 500 pins (60fps on mobile)
- [x] Cluster badges styled correctly
- [x] No console errors or warnings
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Client-side clustering is simpler than server-side PostGIS approach
- react-leaflet-cluster handles all clustering logic out of the box
- Server-side clustering with PostGIS deferred to Phase 2
- Max pins limited server-side (50 mobile, 100 desktop) in Story 1.2.2
- Performance target: <16ms frame time (60fps)
