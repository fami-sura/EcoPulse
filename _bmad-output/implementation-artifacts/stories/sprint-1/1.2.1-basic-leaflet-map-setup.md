# Story 1.2.1: Basic Leaflet Map Setup

**Epic:** 1.2 Interactive Map with Clustering & Filters  
**Story Points:** 3  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to see an interactive map centered on my location  
**So that** I can view environmental issues in my area

---

## Acceptance Criteria

- [ ] Map displays using Leaflet + OpenStreetMap tiles (configured in Story 0.3)
- [ ] Default center: User's geolocation (browser Geolocation API)
- [ ] Fallback center if geolocation denied: Lagos, Nigeria (6.5244, 3.3792)
- [ ] Initial zoom level: 13 (neighborhood view)
- [ ] Map controls: Zoom in/out buttons (44x44px touch targets), full-screen toggle
- [ ] Mobile: pinch-to-zoom, two-finger pan
- [ ] Desktop: scroll-to-zoom, click-and-drag pan
- [ ] Map height: `calc(100vh - 60px)` (100vh - header height, responsive)
- [ ] Geolocation timeout: 5 seconds (then use fallback)
- [ ] Loading skeleton while geolocation is being fetched

---

## Technical Implementation

### Components to Create

- `/components/map/IssueMap.tsx` (client component)
- `/components/map/__tests__/IssueMap.test.tsx`

### State Management

- Zustand store: `useMapStore({ center, zoom })`

### Code Structure

```typescript
'use client';
import { useEffect, useState } from 'react';
import { BaseMap } from './BaseMap';
import { useMapStore } from '@/stores/mapStore';

export function IssueMap() {
  const { center, setCenter, zoom } = useMapStore();
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          setCenter([position.coords.latitude, position.coords.longitude]);
          setLoading(false);
        },
        () => {
          setCenter([6.5244, 3.3792]); // Lagos fallback
          setLoading(false);
        },
        { timeout: 5000 }
      );
    } else {
      setCenter([6.5244, 3.3792]);
      setLoading(false);
    }
  }, []);

  if (loading) return <MapSkeleton />;

  return (
    <BaseMap center={center} zoom={zoom}>
      {/* Map content */}
    </BaseMap>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create IssueMap Component

- [ ] Create `/components/map/IssueMap.tsx` file
- [ ] Mark as client component with `'use client'`
- [ ] Import BaseMap from Story 0.3
- [ ] Set up component structure

### Task 2: Implement Geolocation Detection

- [ ] Use browser Geolocation API
- [ ] Request user's current position
- [ ] Set timeout to 5 seconds
- [ ] Handle success: Update map center with coords
- [ ] Handle error: Use Lagos fallback (6.5244, 3.3792)
- [ ] Handle browser without geolocation support

### Task 3: Create Loading Skeleton

- [ ] Create MapSkeleton component
- [ ] Show pulsing gray rectangle while loading
- [ ] Match map dimensions (100vh - 60px)
- [ ] Display during geolocation request

### Task 4: Configure Map Settings

- [ ] Set initial zoom level: 13
- [ ] Set map height: `calc(100vh - 60px)`
- [ ] Ensure touch targets for zoom controls: 44x44px
- [ ] Enable mobile gestures (pinch-to-zoom, two-finger pan)
- [ ] Enable desktop controls (scroll-to-zoom, drag-to-pan)

### Task 5: State Management with Zustand

- [ ] Update `/stores/mapStore.ts` with center and zoom
- [ ] Add `center: [lat, lng]` state
- [ ] Add `zoom: number` state
- [ ] Add `setCenter` action
- [ ] Add `setZoom` action

### Task 6: Testing

- [ ] Write unit tests for IssueMap component
- [ ] Mock Geolocation API
- [ ] Test successful geolocation
- [ ] Test geolocation error (fallback to Lagos)
- [ ] Test timeout scenario
- [ ] Test loading state
- [ ] E2E test: Map renders and centers on user location

---

## Dependencies

- **Blocked by:** Story 0.3 (BaseMap component) ✅ COMPLETE
- **Blocks:** Story 1.2.2 (Display Issue Pins)
- **Related:** Story 1.3.3a (Auto-Location Detection reuses geolocation logic)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Works on Chrome, Safari, Firefox
- [x] Mobile gestures working (pinch-to-zoom, two-finger pan)
- [x] Touch targets 44x44px minimum
- [x] No console errors or warnings
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Leaflet and react-leaflet already installed in Story 0.3
- OpenStreetMap tiles are free and don't require API key
- Lagos coordinates: 6.5244° N, 3.3792° E (city center)
- Geolocation permission prompt may be blocked by browser if not HTTPS
