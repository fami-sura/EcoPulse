# Story 1.3.3b: Map Pin Adjustment & Manual Address Search

**Epic:** 1.3 60-Second Report Submission Flow  
**Story Points:** 5  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user  
**I want** to adjust the pin location on a map or search for an address  
**So that** I can report the exact location even if auto-detection is inaccurate

---

## Acceptance Criteria

- [ ] Display small map preview (300x200px mobile, 400x300px desktop)
- [ ] Pin defaults to detected location from Story 1.3.3a
- [ ] User can drag pin to adjust location (Leaflet draggable marker)
- [ ] Dragging pin updates reverse geocoded address in real-time (debounced 1s)
- [ ] Manual search bar above map: "Search for address or place"
  - Uses Nominatim search API
  - Autocomplete suggestions (dropdown with top 5 results)
  - Selecting suggestion updates pin location and address
  - Rate limit: 1 request/second (debounced search input)
- [ ] "Reset to Current Location" button (calls geolocation again)
- [ ] Map zoom level: 16 (street-level detail)
- [ ] Map controls: Zoom in/out buttons (44x44px touch targets)
- [ ] Comprehensive error handling
- [ ] Loading state during search (spinner in search bar)
- [ ] Touch-friendly: Pin dragging works on mobile with touch gestures

---

## Technical Implementation

### Components to Create

- `/components/report/LocationPicker.tsx`
- `/components/report/__tests__/LocationPicker.test.tsx`

### Code Structure

```typescript
'use client';
import { useState, useMemo } from 'react';
import { MapContainer, TileLayer, Marker } from 'react-leaflet';
import { debounce } from 'lodash';
import { Search01, MapPin01 } from '@hugeicons/react';

const searchAddress = async (query: string) => {
  const response = await fetch(
    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`
  );
  return await response.json();
};

const reverseGeocode = async (lat: number, lng: number) => {
  const response = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
  );
  const data = await response.json();
  return data.display_name;
};

export function LocationPicker({ initialLocation, onLocationChange }) {
  const [location, setLocation] = useState(initialLocation);
  const [address, setAddress] = useState('');
  const [searchQuery, setSearchQuery] = useState('');
  const [suggestions, setSuggestions] = useState([]);
  const [searching, setSearching] = useState(false);

  const debouncedSearch = useMemo(
    () => debounce(async (query) => {
      if (!query) return;
      setSearching(true);
      const results = await searchAddress(query);
      setSuggestions(results);
      setSearching(false);
    }, 1000),
    []
  );

  const handleMarkerDrag = useMemo(
    () => debounce(async (e) => {
      const { lat, lng } = e.target.getLatLng();
      setLocation({ lat, lng });
      const newAddress = await reverseGeocode(lat, lng);
      setAddress(newAddress);
      onLocationChange({ lat, lng, address: newAddress });
    }, 1000),
    []
  );

  return (
    <div className="location-picker">
      {/* Search bar */}
      {/* Map preview */}
      {/* Reset button */}
    </div>
  );
}
```

---

## Tasks & Subtasks

### Task 1: Create LocationPicker Component

- [ ] Create `/components/report/LocationPicker.tsx` file
- [ ] Import BaseMap component from Story 0.3
- [ ] Set up map preview with Leaflet
- [ ] Configure map size (300x200px mobile, 400x300px desktop)
- [ ] Set zoom level: 16 (street-level)

### Task 2: Implement Draggable Pin

- [ ] Use Leaflet Marker with `draggable={true}`
- [ ] Default pin to detected location from Story 1.3.3a
- [ ] Handle `dragend` event
- [ ] Update location state on drag
- [ ] Trigger reverse geocoding on drag (debounced 1s)

### Task 3: Implement Address Search

- [ ] Create search input above map
- [ ] Use Nominatim search API
- [ ] Debounce search input (1s delay for rate limiting)
- [ ] Display autocomplete suggestions (top 5 results)
- [ ] Select suggestion: Update pin location and address

### Task 4: Implement Reverse Geocoding on Drag

- [ ] Call Nominatim reverse geocoding API
- [ ] Update address when pin dragged
- [ ] Debounce API calls (1s delay)
- [ ] Handle API errors gracefully

### Task 5: Implement "Reset to Current Location" Button

- [ ] Add button to re-trigger geolocation
- [ ] Call geolocation API from Story 1.3.3a
- [ ] Update pin location on success
- [ ] Show loading state during detection

### Task 6: Implement Error Handling

- [ ] Search returns no results: "No results found. Please try a different search term."
- [ ] Nominatim API error: "Search unavailable. Please use map to place pin."
- [ ] Invalid search query (empty): Disable search button
- [ ] Reverse geocoding fails: Show lat/lng instead of address

### Task 7: Implement Map Controls

- [ ] Add zoom in/out buttons
- [ ] Ensure 44x44px touch targets
- [ ] Position controls in top-right corner
- [ ] Test on mobile and desktop

### Task 8: Optimize for Mobile Touch

- [ ] Test pin dragging with touch gestures
- [ ] Ensure smooth drag experience on mobile
- [ ] Add haptic feedback on pin drag (if supported)

### Task 9: State Management

- [ ] Store location in Zustand: `useReportStore({ lat, lng, address })`
- [ ] Update store when pin dragged
- [ ] Update store when search selected
- [ ] Pass final location to parent component

### Task 10: Testing

- [ ] Write unit tests for LocationPicker component
- [ ] Test pin dragging
- [ ] Test address search
- [ ] Test autocomplete suggestions
- [ ] Test reverse geocoding
- [ ] Test "Reset to Current Location"
- [ ] Test Nominatim rate limiting (debounce)
- [ ] E2E test: Drag pin → address updates

---

## Dependencies

- **Blocked by:** Story 1.3.3a (provides initial location), Story 0.3 (BaseMap component) ✅
- **Blocks:** Story 1.3.6 (Report Submission needs final location)
- **Related:** Story 1.2.1 (Map setup)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Pin dragging working on mobile and desktop
- [x] Address search with autocomplete working
- [x] Reverse geocoding working (debounced)
- [x] Rate limiting compliant (1 req/sec)
- [x] Error handling tested
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Nominatim search API: `https://nominatim.openstreetmap.org/search?q={query}&format=json&limit=5`
- Nominatim reverse API: `https://nominatim.openstreetmap.org/reverse?format=json&lat={lat}&lon={lng}`
- Debounce both search and reverse geocoding (1s delay for rate limiting)
- Leaflet marker drag event: `eventHandlers={{ dragend: handleDragEnd }}`
- Use `lodash.debounce` or custom debounce implementation
