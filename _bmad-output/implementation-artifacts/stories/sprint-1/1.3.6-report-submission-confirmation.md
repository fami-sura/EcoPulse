# Story 1.3.6: Report Submission & Confirmation (with Error Handling)

**Epic:** 1.3 60-Second Report Submission Flow  
**Story Points:** 5  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user completing the report flow  
**I want** to submit my report and see confirmation  
**So that** I know my report was received and will be reviewed

---

## Acceptance Criteria

- [ ] "Submit Report" button at bottom of form
- [ ] Disabled until all required fields completed:
  - At least 1 photo
  - Location selected (lat/lng)
  - Category selected
  - Severity selected (defaults to 'medium')
  - Text description (60 characters minimum)
- [ ] Race condition prevention: Wait for all photo uploads to complete before enabling submit
- [ ] On submit:
  - Show loading spinner overlay: "Submitting your report..."
  - Disable submit button (prevent double submission)
  - Call Server Action `createReport(reportData)`
  - Insert report into `issues` table (Supabase)
  - Generate anonymous `session_id` for retroactive credit (localStorage)
- [ ] Success state:
  - ✅ Checkmark animation (scale in + fade in)
  - "Thank you! Your report has been submitted."
  - Display report ID: "Report #12345"
  - Two action buttons:
    - "View on map" → redirects to `/` with `?report={id}` (pin highlighted)
    - "Submit another report" → clears form, stays on `/report/new`
- [ ] Comprehensive error handling with retry mechanism
- [ ] Optimistic UI update: Pin appears on map immediately
- [ ] Accessibility: Success/error announced to screen readers

---

## Technical Implementation

### Files to Create

- `/app/actions/createReport.ts` (Server Action)
- `/app/actions/__tests__/createReport.test.ts`
- `/components/report/ReportForm.tsx`
- `/components/report/__tests__/ReportForm.test.tsx`

### Server Action Structure

```typescript
'use server';
import { createClient } from '@/lib/supabase/server';
import { revalidatePath } from 'next/cache';

export async function createReport(reportData: ReportFormData) {
  try {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('issues')
      .insert({
        photos: reportData.photoUrls,
        lat: reportData.lat,
        lng: reportData.lng,
        address: reportData.address,
        category: reportData.category,
        severity: reportData.severity,
        note: reportData.note,
        session_id: reportData.sessionId, // for retroactive credit
        status: 'pending',
      })
      .select()
      .single();

    if (error) throw error;

    revalidatePath('/');
    return { success: true, reportId: data.id };
  } catch (err) {
    console.error('Report submission error:', err);
    return {
      success: false,
      error: err.message || 'Unable to submit report. Please try again.',
    };
  }
}
```

---

## Tasks & Subtasks

### Task 1: Create createReport Server Action

- [ ] Create `/app/actions/createReport.ts` file
- [ ] Accept reportData parameter
- [ ] Insert into `issues` table
- [ ] Handle session_id for anonymous users
- [ ] Return structured response: `{ success, reportId/error }`
- [ ] Revalidate home page path after insert

### Task 2: Create ReportForm Component

- [ ] Create `/components/report/ReportForm.tsx` file
- [ ] Integrate all sub-components:
  - PhotoCapture (Story 1.3.2)
  - LocationDetector + LocationPicker (Story 1.3.3a/b)
  - CategorySelector (Story 1.3.4)
  - SeveritySelector (Story 1.3.5)
  - Text description field
- [ ] Implement form validation
- [ ] Manage form state

### Task 3: Implement Form Validation

- [ ] At least 1 photo uploaded
- [ ] Location selected (lat/lng not null)
- [ ] Category selected (waste or drainage)
- [ ] Severity selected (defaults to medium)
- [ ] Text description (60 chars minimum)
- [ ] Disable submit button until all fields valid

### Task 4: Implement Race Condition Prevention

- [ ] Track photo upload status
- [ ] Disable submit while any photo uploading
- [ ] Show "Uploading photos..." in submit button
- [ ] Enable submit only when all uploads complete

### Task 5: Implement Session ID Generation

- [ ] Check localStorage for existing session_id
- [ ] Generate new session_id if not exists: `crypto.randomUUID()`
- [ ] Fallback for browsers without crypto.randomUUID():
  - `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
- [ ] Save session_id to localStorage
- [ ] Include session_id in report data

### Task 6: Implement Submit Handler

- [ ] Show loading overlay
- [ ] Disable submit button
- [ ] Call createReport Server Action
- [ ] Handle success response
- [ ] Handle error response
- [ ] Implement retry mechanism (max 3 attempts)

### Task 7: Implement Success State

- [ ] Show checkmark animation (scale in + fade in)
- [ ] Display success message
- [ ] Display report ID
- [ ] Show action buttons:
  - "View on map" → navigate to `/?report={id}`
  - "Submit another report" → reset form
- [ ] Clear form state after successful submit

### Task 8: Implement Comprehensive Error Handling

- [ ] Network timeout (>30s): "Network timeout. Check connection and try again." + Retry
- [ ] Validation failure: "Please complete all required fields." + scroll to first error
- [ ] Supabase error: "Unable to submit report. Try again in a moment." + Retry
- [ ] Photo upload incomplete: Disable submit, show "Uploading photos..."
- [ ] Session ID generation failure: Log error but proceed
- [ ] Generic error: "Something went wrong. Please try again." + Retry

### Task 9: Implement Retry Mechanism

- [ ] Retry button re-submits same data
- [ ] Max 3 retry attempts
- [ ] After 3 failures: "Still having trouble? Contact support."
- [ ] Track retry count in state

### Task 10: Implement Optimistic UI Update

- [ ] Add report to Zustand map store before DB confirmation
- [ ] Generate temp ID: `temp-${Date.now()}`
- [ ] On success: Replace temp ID with real ID
- [ ] On error: Remove optimistic report from map

### Task 11: Implement Accessibility

- [ ] ARIA live region for status announcements
- [ ] Announce "Submitting report, please wait"
- [ ] Announce "Report submitted successfully"
- [ ] Announce errors
- [ ] Focus management: Move focus to success/error message

### Task 12: Testing

- [ ] Write unit tests for createReport Server Action
- [ ] Test successful submission
- [ ] Test all error scenarios
- [ ] Test retry mechanism
- [ ] Test session ID generation
- [ ] Test optimistic UI update
- [ ] Test form validation
- [ ] E2E test: Complete report flow → submit → success

---

## Dependencies

- **Blocked by:** Story 1.3.1, 1.3.2 (photo uploads), Story 0.1 (issues table exists) ✅
- **Blocks:** None (completes Epic 1.3)
- **Related:** All Epic 1.3 stories (integrates all report form components)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Server Action tested with all scenarios
- [x] Error handling tested comprehensively
- [x] Retry mechanism working
- [x] Optimistic UI update working
- [x] Accessibility tested (screen reader + keyboard)
- [x] Race condition prevention verified
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Session ID enables retroactive credit when user creates account later
- Optimistic UI provides instant feedback (report appears on map immediately)
- Comprehensive error handling prevents user frustration
- Retry mechanism handles temporary network issues
- Form validation prevents invalid submissions
- ARIA live regions announce status to screen readers
