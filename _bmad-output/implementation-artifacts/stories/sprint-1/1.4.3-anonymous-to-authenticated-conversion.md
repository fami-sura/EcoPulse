# Story 1.4.3: Anonymous to Authenticated Conversion with Retroactive Credit

**Epic:** 1.4 User Authentication & Profile  
**Story Points:** 3  
**Sprint:** 1  
**Status:** Not Started

---

## User Story

**As a** user who previously submitted reports anonymously  
**I want** to claim ownership of those reports when I create an account  
**So that** I receive credit for all my contributions

---

## Acceptance Criteria

- [ ] After successful signup/login, check for existing anonymous reports
- [ ] Query `issues` table for reports with matching `session_id` from localStorage
- [ ] Update found reports: Set `user_id` to authenticated user, clear `session_id`
- [ ] Award retroactive points for all claimed reports
- [ ] Show confirmation: "3 reports claimed! You earned 30 points."
- [ ] Remove `session_id` from localStorage after successful migration
- [ ] Handle edge cases:
  - No anonymous reports found (skip migration)
  - Reports already claimed by another user (skip duplicate claims)
  - Network error during migration (retry on next login)
- [ ] Migration happens automatically (no user action required)
- [ ] Update user's total points in `users` table
- [ ] Insert point history records for each claimed report

---

## Technical Implementation

### Server Actions to Create

- `/app/actions/claimAnonymousReports.ts`

### Code Structure

```typescript
'use server';
import { createClient } from '@/lib/supabase/server';

export async function claimAnonymousReports(sessionId: string) {
  const supabase = await createClient();

  // Get authenticated user
  const {
    data: { user },
    error: authError,
  } = await supabase.auth.getUser();
  if (authError || !user) {
    return { success: false, error: 'Not authenticated' };
  }

  // Find anonymous reports with this session_id
  const { data: reports, error: fetchError } = await supabase
    .from('issues')
    .select('id')
    .eq('session_id', sessionId)
    .is('user_id', null);

  if (fetchError || !reports || reports.length === 0) {
    return { success: true, claimedCount: 0 };
  }

  // Update reports to claim them
  const { error: updateError } = await supabase
    .from('issues')
    .update({ user_id: user.id, session_id: null })
    .eq('session_id', sessionId)
    .is('user_id', null);

  if (updateError) {
    return { success: false, error: updateError.message };
  }

  // Award retroactive points (10 points per report)
  const pointsToAward = reports.length * 10;

  await supabase
    .from('users')
    .update({ points: supabase.raw(`points + ${pointsToAward}`) })
    .eq('id', user.id);

  // Insert point history records
  const pointHistoryRecords = reports.map((report) => ({
    user_id: user.id,
    amount: 10,
    reason: `Claimed anonymous report #${report.id}`,
  }));

  await supabase.from('points_history').insert(pointHistoryRecords);

  return {
    success: true,
    claimedCount: reports.length,
    pointsAwarded: pointsToAward,
  };
}
```

---

## Tasks & Subtasks

### Task 1: Create claimAnonymousReports Server Action

- [ ] Create `/app/actions/claimAnonymousReports.ts` file
- [ ] Accept sessionId parameter
- [ ] Query `issues` table for matching session_id
- [ ] Filter: `session_id = {sessionId}` AND `user_id IS NULL`
- [ ] Return count of reports found

### Task 2: Implement Report Claiming Logic

- [ ] Update found reports: Set `user_id`, clear `session_id`
- [ ] Use atomic update to prevent race conditions
- [ ] Verify user is authenticated before claiming
- [ ] Handle no reports found (skip migration gracefully)

### Task 3: Implement Retroactive Point Awarding

- [ ] Calculate points: 10 points per report
- [ ] Update `users` table: Increment points
- [ ] Use SQL increment to prevent race conditions:
  - `UPDATE users SET points = points + {amount} WHERE id = {userId}`
- [ ] Insert records in `points_history` table

### Task 4: Integrate with Login Flow

- [ ] After successful login, get sessionId from localStorage
- [ ] Call claimAnonymousReports Server Action
- [ ] Handle success: Show confirmation toast
- [ ] Handle error: Log error, retry on next login
- [ ] Clear sessionId from localStorage after successful migration

### Task 5: Integrate with Signup Flow

- [ ] After successful signup, get sessionId from localStorage
- [ ] Call claimAnonymousReports Server Action
- [ ] Show confirmation: "3 reports claimed! You earned 30 points."
- [ ] Clear sessionId from localStorage

### Task 6: Implement Confirmation UI

- [ ] Show toast notification on success
- [ ] Message: "3 reports claimed! You earned 30 points."
- [ ] Animate point counter in user profile
- [ ] Update points badge in navigation

### Task 7: Handle Edge Cases

- [ ] No anonymous reports: Skip migration silently
- [ ] Reports already claimed: Skip duplicate claims
- [ ] Network error: Retry on next login (don't clear sessionId)
- [ ] User logs out and back in: Don't re-claim same reports
- [ ] Multiple devices: First login claims reports

### Task 8: Implement Retry Logic

- [ ] If migration fails, keep sessionId in localStorage
- [ ] Retry on next login attempt
- [ ] Max retry attempts: 3
- [ ] After 3 failures: Clear sessionId, log error

### Task 9: Update Auth Store

- [ ] Update user points in auth store after claiming
- [ ] Trigger points counter animation
- [ ] Refresh user profile data

### Task 10: Testing

- [ ] Write unit tests for claimAnonymousReports Server Action
- [ ] Test successful claim
- [ ] Test no reports found
- [ ] Test duplicate claim prevention
- [ ] Test retroactive point awarding
- [ ] Test edge cases
- [ ] E2E test: Submit anonymous report → signup → reports claimed → points awarded

---

## Dependencies

- **Blocked by:** Story 1.4.1 (Authentication setup), Story 1.3.6 (Anonymous reports with session_id)
- **Blocks:** None
- **Related:** Story 1.5.1 (Points System Foundation - deferred to Sprint 2)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Unit tests written and passing (80% coverage)
- [x] Server Action tested with all scenarios
- [x] Retroactive points awarded correctly
- [x] localStorage sessionId cleared after migration
- [x] Edge cases handled gracefully
- [x] Confirmation UI working
- [x] Code reviewed and approved
- [x] Deployed to Vercel preview environment

---

## Notes

- Session ID generated in Story 1.3.6 (Report Submission)
- Points awarded: 10 points per report (standard reporting reward)
- Atomic SQL updates prevent race conditions
- localStorage enables cross-session tracking
- First device to login claims all reports
- Future enhancement: Link reports to device fingerprint (Phase 2)
